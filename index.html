<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
  <title>Linq</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    input, textarea { font-size: 16px !important; }
      
      /* Mobile-specific styles */
      html, body {
        height: 100%;
        height: -webkit-fill-available;
        overflow: hidden;
      }
      
      #app {
        height: 100vh;
        height: 100dvh;
        height: -webkit-fill-available;
        overflow: hidden;
      }
      
      /* Chat screen mobile layout */
      .chat-screen {
        display: flex;
        flex-direction: column;
        height: 100vh;
        height: 100dvh;
        height: -webkit-fill-available;
        max-height: 100vh;
        max-height: 100dvh;
        overflow: hidden;
      }
      
      .chat-header-mobile {
        flex-shrink: 0;
        height: 56px;
        min-height: 56px;
      }
      
      .chat-messages-mobile {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }
      
      .chat-input-mobile {
        flex-shrink: 0;
        position: sticky;
        bottom: 0;
        background: white;
        padding-bottom: env(safe-area-inset-bottom, 0);
      }
      
      /* Fix for iOS keyboard */
      @supports (-webkit-touch-callout: none) {
        .chat-input-mobile {
          padding-bottom: max(env(safe-area-inset-bottom), 8px);
        }
      }
      
      /* Sidebar mobile layout */
      .sidebar-mobile {
        height: 100vh;
        height: 100dvh;
        height: -webkit-fill-available;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      
      .sidebar-header-mobile {
        flex-shrink: 0;
      }
      
      .sidebar-content-mobile {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
      }
      
      /* Hide scrollbar on mobile */
      @media (max-width: 768px) {
        .chat-messages-mobile::-webkit-scrollbar,
        .sidebar-content-mobile::-webkit-scrollbar {
          display: none;
        }
        .chat-messages-mobile,
        .sidebar-content-mobile {
          -ms-overflow-style: none;
          scrollbar-width: none;
        }
      }
      
      /* Voice recording bar mobile */
      .voice-recording-bar {
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        background: #1a1a1a;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        border-top: 1px solid #333;
      }
      
      /* Image preview modal mobile */
      @media (max-width: 768px) {
        .image-preview-modal img {
          max-height: 60vh;
        }
      }
    .text-shadow { text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
    /* Slide progress animation */
    .slide-progress-bar { transition: width 0.1s linear; }
    /* Ring animation for new slides */
    @keyframes ring-pulse {
      0%, 100% { opacity: 0.9; }
      50% { opacity: 1; }
    }
    .ring-animate { animation: ring-pulse 2s ease-in-out infinite; }
    /* Updates feed */
    @keyframes fadeSlideUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    .post-card { animation: fadeSlideUp .2s ease forwards; }
    @keyframes likePop { 0%,100%{transform:scale(1)} 50%{transform:scale(1.5)} }
    .like-pop { animation: likePop .25s ease; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #emoji-panel { display:none; position:absolute; bottom:62px; left:0; right:0; background:#fff; border-top:1px solid #e5e7eb; max-height:220px; overflow-y:auto; z-index:50; }
    #emoji-panel.open { display:block; }
    /* Blue ambient glow on message input and search bar */
    .blue-glow-input:focus-within {
      box-shadow: 0 0 0 2px rgba(59,130,246,0.35), 0 0 18px 4px rgba(59,130,246,0.18);
      border-color: rgba(59,130,246,0.6) !important;
      transition: box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .blue-glow-input {
      transition: box-shadow 0.2s ease, border-color 0.2s ease;
    }
        /* Contact profile slide animation */
    @keyframes slideUpProfile {
      from { transform: translateY(100%); opacity: 0; }
      to   { transform: translateY(0);    opacity: 1; }
    }
    @keyframes fadeIn  { from { opacity:0; } to { opacity:1; } }
    @keyframes fadeOut { from { opacity:1; } to { opacity:0; } }
    @keyframes slideDownProfile {
      from { transform: translateY(0);    opacity: 1; }
      to   { transform: translateY(100%); opacity: 0; }
    }
    /* Logo glow animation */
    @keyframes logo-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(255,255,255,0.1), inset 0 0 20px rgba(255,255,255,0.05); }
      50% { box-shadow: 0 0 30px rgba(255,255,255,0.15), inset 0 0 30px rgba(255,255,255,0.08); }
    }
    .logo-glow { animation: logo-glow 4s ease-in-out infinite; }
    /* Pulse animation for connection dots */
    @keyframes dot-pulse {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }
    .dot-pulse { animation: dot-pulse 2s ease-in-out infinite; }
    /* Header icon hover effect */
    .header-icon {
      transition: all 0.2s ease;
    }
    .header-icon:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255,255,255,0.1);
    }
    /* Typing animation */
    @keyframes typing-dot {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-4px); }
    }
    .typing-dot:nth-child(1) { animation: typing-dot 1s infinite 0s; }
    .typing-dot:nth-child(2) { animation: typing-dot 1s infinite 0.15s; }
    .typing-dot:nth-child(3) { animation: typing-dot 1s infinite 0.3s; }
    /* Message bubble tails */
    .msg-tail-right::after {
      content: '';
      position: absolute;
      right: -8px;
      bottom: 0;
      width: 0;
      height: 0;
      border: 8px solid transparent;
      border-left-color: white;
      border-bottom-color: white;
      border-right: 0;
      border-bottom: 0;
    }
    .msg-tail-left::after {
      content: '';
      position: absolute;
      left: -8px;
      bottom: 0;
      width: 0;
      height: 0;
      border: 8px solid transparent;
      border-right-color: #1f2937;
      border-bottom-color: #1f2937;
      border-left: 0;
      border-bottom: 0;
    }
    /* Scroll to bottom button animation */
    @keyframes bounce-subtle {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }
    .scroll-btn-bounce { animation: bounce-subtle 2s ease-in-out infinite; }
    /* Swipe to reply animation */
    .swipe-reply { transition: transform 0.1s ease-out; }
    /* Chat item hover */
    .chat-item-hover:active { background-color: rgba(255,255,255,0.05); }
  </style>
  <script type="module">
    // Firebase SDK
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, query, where, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
    // Firebase Storage import removed - using Base64 for images instead

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBVy6BAIAeryc56HwbKEotkmX-jSpn2CQs",
      authDomain: "link-af338.firebaseapp.com",
      projectId: "link-af338",
      storageBucket: "link-af338.firebasestorage.app",
      messagingSenderId: "468588433959",
      appId: "1:468588433959:web:c5f8e3dc48861d5dc4b402"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // Storage removed - using Base64 for all images

    // Debug logger
    const debugLogs = [];
    function log(msg) {
      const time = new Date().toLocaleTimeString();
      const entry = `[${time}] ${msg}`;
      debugLogs.push(entry);
      console.log(entry);
      const debugEl = document.getElementById('debug-content');
      if (debugEl) {
        debugEl.textContent = debugLogs.slice(-20).join('\n');
      }
    }

    log('Firebase initialized');

    // App State
    const state = {
      user: JSON.parse(localStorage.getItem('linkup_user') || 'null'),
      userData: JSON.parse(localStorage.getItem('linkup_userData') || 'null'),
      loading: true,
      authView: 'login',
      activeTab: 'circle',
      selectedChatId: null,
      showMobileChat: false,
      showUserSearch: false,
      showProfileMenu: false,
      showConnectionInvites: false,
      showRequestModal: false,
      invitesPanelTab: 'received',
      requestsSubTab: 'incoming',
      showSlideModal: false,
      showSlideViewer: false,
      viewingSlideUserId: null,
      selectedRequestUser: null,
      selectedRequestType: null,
      connections: [],
      chats: [],
      chatUsers: {},
      receivedInvites: [],
      sentInvites: [],
      receivedRequests: [],
      sentRequests: [],
      slides: [],
      // Updates / public posts feed
      posts: [],           // all posts from Firestore
      updatesVisibility: true,  // this user's setting
      blockedUsers: [],    // user IDs this user has blocked
      updatesSubTab: 'feed',    // 'feed' | 'my_posts'
      messages: [],
      searchResults: [],
      typingUsers: {},
      circleSearchQuery: '',
      error: null,
      // Call state
      call: {
        active: false,
        type: null, // 'voice' or 'video'
        direction: null, // 'incoming' or 'outgoing'
        status: 'idle', // 'idle', 'ringing', 'connecting', 'connected', 'ended'
        remoteUser: null,
        callId: null,
        startTime: null,
        duration: 0,
        isMuted: false,
        isSpeakerOn: false,
        isVideoOff: false,
        localStream: null,
        remoteStream: null,
        peerConnection: null
      }
    };

    // WebRTC Configuration
    const rtcConfig = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' }
      ]
    };

    // Call functions
    let callUnsubscribe = null;
    let callTimer = null;

    async function startCall(userId, type = 'voice') {
      log('startCall called with userId: ' + userId + ', type: ' + type);
      
      const user = state.connections.find(c => c.id === userId) || state.chatUsers[userId];
      if (!user) {
        log('Cannot start call - user not found in connections or chatUsers');
        log('Connections: ' + state.connections.map(c => c.id).join(', '));
        log('ChatUsers: ' + Object.keys(state.chatUsers || {}).join(', '));
        alert('Cannot start call - user not found');
        return;
      }

      // Check if we're on HTTPS or localhost (required for WebRTC)
      const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      const isFileProtocol = location.protocol === 'file:';
      
      // Use demo mode if not in secure context
      if (isFileProtocol || !isSecure) {
        log('Using demo call mode (file:// or non-HTTPS detected)');
        startDemoCall(user, type);
        return;
      }

      log('Starting ' + type + ' call to ' + user.name);
      
      state.call = {
        ...state.call,
        active: true,
        type: type,
        direction: 'outgoing',
        status: 'ringing',
        remoteUser: user,
        callId: null,
        startTime: null,
        duration: 0,
        isMuted: false,
        isSpeakerOn: false,
        isVideoOff: false
      };

      renderCallScreen();

      try {
        // Get local media stream
        const constraints = {
          audio: true,
          video: type === 'video'
        };
        state.call.localStream = await navigator.mediaDevices.getUserMedia(constraints);
        log('Got local stream');

        // Create peer connection
        state.call.peerConnection = new RTCPeerConnection(rtcConfig);

        // Add local tracks to peer connection
        state.call.localStream.getTracks().forEach(track => {
          state.call.peerConnection.addTrack(track, state.call.localStream);
        });

        // Handle incoming tracks
        state.call.peerConnection.ontrack = (event) => {
          log('Received remote track');
          state.call.remoteStream = event.streams[0];
          updateCallScreen();
        };

        // Handle ICE candidates
        state.call.peerConnection.onicecandidate = async (event) => {
          if (event.candidate && state.call.callId) {
            await addDoc(collection(db, 'calls', state.call.callId, 'candidates'), {
              candidate: event.candidate.toJSON(),
              from: state.user.uid,
              timestamp: serverTimestamp()
            });
          }
        };

        // Connection state changes
        state.call.peerConnection.onconnectionstatechange = () => {
          log('Connection state: ' + state.call.peerConnection.connectionState);
          if (state.call.peerConnection.connectionState === 'connected') {
            state.call.status = 'connected';
            state.call.startTime = Date.now();
            startCallTimer();
            updateCallScreen();
          } else if (state.call.peerConnection.connectionState === 'disconnected' || 
                     state.call.peerConnection.connectionState === 'failed') {
            endCall();
          }
        };

        // Create offer
        const offer = await state.call.peerConnection.createOffer();
        await state.call.peerConnection.setLocalDescription(offer);

        // Save call to Firestore
        const callDoc = await addDoc(collection(db, 'calls'), {
          callerId: state.user.uid,
          callerName: state.userData.name,
          callerAvatar: state.userData.avatar || '',
          receiverId: userId,
          receiverName: user.name,
          receiverAvatar: user.avatar || '',
          type: type,
          status: 'ringing',
          offer: { type: offer.type, sdp: offer.sdp },
          createdAt: serverTimestamp()
        });

        state.call.callId = callDoc.id;
        log('Call created: ' + callDoc.id);

        // Listen for answer
        listenForCallUpdates(callDoc.id);

        // Play ringtone
        playRingtone('outgoing');

        // Auto-end call after 60 seconds if not answered
        setTimeout(() => {
          if (state.call.status === 'ringing') {
            log('Call timeout - no answer');
            endCall();
          }
        }, 60000);

      } catch (err) {
        log('Call error: ' + err.message);
        alert('Could not start call: ' + err.message);
        endCall();
      }
    }

    async function answerCall(callId) {
      log('Answering call: ' + callId);
      stopRingtone();

      try {
        const callDoc = await getDoc(doc(db, 'calls', callId));
        if (!callDoc.exists()) {
          log('Call not found');
          return;
        }

        const callData = callDoc.data();
        state.call.status = 'connecting';
        updateCallScreen();

        // Get local media stream
        const constraints = {
          audio: true,
          video: callData.type === 'video'
        };
        state.call.localStream = await navigator.mediaDevices.getUserMedia(constraints);
        log('Got local stream');

        // Create peer connection
        state.call.peerConnection = new RTCPeerConnection(rtcConfig);

        // Add local tracks
        state.call.localStream.getTracks().forEach(track => {
          state.call.peerConnection.addTrack(track, state.call.localStream);
        });

        // Handle incoming tracks
        state.call.peerConnection.ontrack = (event) => {
          log('Received remote track');
          state.call.remoteStream = event.streams[0];
          updateCallScreen();
        };

        // Handle ICE candidates
        state.call.peerConnection.onicecandidate = async (event) => {
          if (event.candidate) {
            await addDoc(collection(db, 'calls', callId, 'candidates'), {
              candidate: event.candidate.toJSON(),
              from: state.user.uid,
              timestamp: serverTimestamp()
            });
          }
        };

        // Connection state changes
        state.call.peerConnection.onconnectionstatechange = () => {
          log('Connection state: ' + state.call.peerConnection.connectionState);
          if (state.call.peerConnection.connectionState === 'connected') {
            state.call.status = 'connected';
            state.call.startTime = Date.now();
            startCallTimer();
            updateCallScreen();
          } else if (state.call.peerConnection.connectionState === 'disconnected' || 
                     state.call.peerConnection.connectionState === 'failed') {
            endCall();
          }
        };

        // Set remote description (offer)
        await state.call.peerConnection.setRemoteDescription(new RTCSessionDescription(callData.offer));

        // Create and set answer
        const answer = await state.call.peerConnection.createAnswer();
        await state.call.peerConnection.setLocalDescription(answer);

        // Update call with answer
        await updateDoc(doc(db, 'calls', callId), {
          answer: { type: answer.type, sdp: answer.sdp },
          status: 'connected'
        });

        // Listen for ICE candidates
        listenForIceCandidates(callId, callData.callerId);

      } catch (err) {
        log('Answer error: ' + err.message);
        alert('Could not answer call: ' + err.message);
        endCall();
      }
    }

    async function rejectCall(callId) {
      log('Rejecting call: ' + callId);
      stopRingtone();
      
      try {
        await updateDoc(doc(db, 'calls', callId), {
          status: 'rejected'
        });
      } catch (err) {
        log('Reject error: ' + err.message);
      }
      
      resetCallState();
    }

    async function endCall() {
      log('Ending call');
      stopRingtone();
      stopCallTimer();

      // Update call status in Firestore
      if (state.call.callId) {
        try {
          await updateDoc(doc(db, 'calls', state.call.callId), {
            status: 'ended',
            endedAt: serverTimestamp()
          });
        } catch (err) {
          log('Error updating call status: ' + err.message);
        }
      }

      // Stop local stream
      if (state.call.localStream) {
        state.call.localStream.getTracks().forEach(track => track.stop());
      }

      // Close peer connection
      if (state.call.peerConnection) {
        state.call.peerConnection.close();
      }

      // Unsubscribe from call updates
      if (callUnsubscribe) {
        callUnsubscribe();
        callUnsubscribe = null;
      }

      resetCallState();
    }

    function resetCallState() {
      state.call = {
        active: false,
        type: null,
        direction: null,
        status: 'idle',
        remoteUser: null,
        callId: null,
        startTime: null,
        duration: 0,
        isMuted: false,
        isSpeakerOn: false,
        isVideoOff: false,
        localStream: null,
        remoteStream: null,
        peerConnection: null
      };
      
      document.getElementById('call-screen')?.classList.add('hidden');
    }

    function toggleMute() {
      if (state.call.localStream) {
        const audioTrack = state.call.localStream.getAudioTracks()[0];
        if (audioTrack) {
          audioTrack.enabled = !audioTrack.enabled;
          state.call.isMuted = !audioTrack.enabled;
          updateCallScreen();
        }
      }
    }

    function toggleVideo() {
      if (state.call.localStream) {
        const videoTrack = state.call.localStream.getVideoTracks()[0];
        if (videoTrack) {
          videoTrack.enabled = !videoTrack.enabled;
          state.call.isVideoOff = !videoTrack.enabled;
          updateCallScreen();
        }
      }
    }

    function toggleSpeaker() {
      state.call.isSpeakerOn = !state.call.isSpeakerOn;
      const remoteAudio = document.getElementById('remote-audio');
      if (remoteAudio) {
        remoteAudio.setSinkId && remoteAudio.setSinkId(state.call.isSpeakerOn ? 'default' : '');
      }
      updateCallScreen();
    }

    function listenForCallUpdates(callId) {
      callUnsubscribe = onSnapshot(doc(db, 'calls', callId), async (snapshot) => {
        if (!snapshot.exists()) return;
        
        const callData = snapshot.data();
        log('Call update: ' + callData.status);

        if (callData.status === 'connected' && callData.answer && state.call.direction === 'outgoing') {
          // Got answer - set remote description
          stopRingtone();
          state.call.status = 'connecting';
          updateCallScreen();
          
          try {
            await state.call.peerConnection.setRemoteDescription(new RTCSessionDescription(callData.answer));
            // Listen for ICE candidates
            listenForIceCandidates(callId, callData.receiverId);
          } catch (err) {
            log('Error setting remote description: ' + err.message);
          }
        } else if (callData.status === 'rejected' || callData.status === 'ended') {
          log('Call ended by remote');
          endCall();
        }
      });
    }

    function listenForIceCandidates(callId, otherUserId) {
      const candidatesQuery = query(
        collection(db, 'calls', callId, 'candidates'),
        where('from', '==', otherUserId)
      );

      onSnapshot(candidatesQuery, (snapshot) => {
        snapshot.docChanges().forEach(async (change) => {
          if (change.type === 'added') {
            const data = change.doc.data();
            try {
              await state.call.peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
              log('Added ICE candidate');
            } catch (err) {
              log('Error adding ICE candidate: ' + err.message);
            }
          }
        });
      });
    }

    // Listen for incoming calls
    function listenForIncomingCalls() {
      if (!state.user) return;

      const callsQuery = query(
        collection(db, 'calls'),
        where('receiverId', '==', state.user.uid),
        where('status', '==', 'ringing')
      );

      onSnapshot(callsQuery, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          if (change.type === 'added' && !state.call.active) {
            const callData = { id: change.doc.id, ...change.doc.data() };
            log('Incoming call from: ' + callData.callerName);
            
            state.call = {
              ...state.call,
              active: true,
              type: callData.type,
              direction: 'incoming',
              status: 'ringing',
              remoteUser: {
                id: callData.callerId,
                name: callData.callerName,
                avatar: callData.callerAvatar
              },
              callId: callData.id
            };

            renderCallScreen();
            playRingtone('incoming');
          }
        });
      });
    }

    // Demo Call Mode (works without WebRTC/HTTPS)
    let demoCallInterval = null;
    
    function startDemoCall(user, type) {
      log('Starting demo ' + type + ' call to ' + user.name);
      
      state.call = {
        ...state.call,
        active: true,
        type: type,
        direction: 'outgoing',
        status: 'ringing',
        remoteUser: user,
        callId: 'demo_' + Date.now(),
        startTime: null,
        duration: 0,
        isMuted: false,
        isSpeakerOn: false,
        isVideoOff: false
      };
      
      renderDemoCallScreen();
      playRingtone('outgoing');
      
      // Simulate call being answered after 3 seconds
      setTimeout(() => {
        if (state.call.status === 'ringing') {
          log('Demo call: Simulating answer');
          stopRingtone();
          state.call.status = 'connected';
          state.call.startTime = Date.now();
          startCallTimer();
          renderDemoCallScreen();
        }
      }, 3000);
    }
    
    function renderDemoCallScreen() {
      let callScreen = document.getElementById('call-screen');
      if (!callScreen) {
        callScreen = document.createElement('div');
        callScreen.id = 'call-screen';
        callScreen.className = 'fixed inset-0 z-[100] bg-black flex flex-col';
        document.body.appendChild(callScreen);
      }
      callScreen.classList.remove('hidden');
      updateDemoCallScreen();
    }
    
    function updateDemoCallScreen() {
      const callScreen = document.getElementById('call-screen');
      if (!callScreen || !state.call.active) return;
      
      const { type, status, remoteUser, isMuted, isSpeakerOn, isVideoOff } = state.call;
      const isVideo = type === 'video';
      const isConnected = status === 'connected';
      const isRinging = status === 'ringing';
      
      callScreen.innerHTML = `
        <!-- Demo mode banner -->
        <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-50 bg-yellow-500/90 text-black text-xs font-medium px-3 py-1 rounded-full">
          Demo Mode - Simulated Call
        </div>
        
        ${isVideo ? `
          <!-- Video call background (simulated) -->
          <div class="absolute inset-0 bg-gradient-to-b from-gray-900 via-gray-800 to-black">
            <div class="w-full h-full flex items-center justify-center">
              <div class="w-40 h-40 rounded-full bg-gray-800 flex items-center justify-center">
                ${remoteUser?.avatar 
                  ? `<img src="${remoteUser.avatar}" class="w-full h-full rounded-full object-cover" />`
                  : `<span class="text-6xl text-white font-bold">${remoteUser?.name?.charAt(0) || '?'}</span>`
                }
              </div>
            </div>
          </div>
          
          <!-- Local video placeholder -->
          <div class="absolute top-24 right-4 w-28 h-40 rounded-2xl overflow-hidden bg-gray-800 shadow-2xl border-2 border-gray-700 ${isVideoOff ? 'hidden' : ''}">
            <div class="w-full h-full flex items-center justify-center bg-gray-900">
              ${state.userData?.avatar 
                ? `<img src="${state.userData.avatar}" class="w-full h-full object-cover" />`
                : `<span class="text-2xl text-white font-bold">${state.userData?.name?.charAt(0) || 'Y'}</span>`
              }
            </div>
          </div>
        ` : `
          <!-- Voice call background -->
          <div class="absolute inset-0 bg-gradient-to-b from-gray-900 via-black to-gray-900"></div>
        `}
        
        <!-- Call info -->
        <div class="relative flex-1 flex flex-col items-center justify-center p-8">
          ${!isVideo ? `
            <div class="relative mb-6">
              <div class="w-36 h-36 rounded-full bg-gray-800 flex items-center justify-center overflow-hidden ring-4 ${isRinging ? 'ring-white/30 animate-pulse' : 'ring-gray-700'}">
                ${remoteUser?.avatar 
                  ? `<img src="${remoteUser.avatar}" class="w-full h-full object-cover" />`
                  : `<span class="text-6xl text-white font-bold">${remoteUser?.name?.charAt(0) || '?'}</span>`
                }
              </div>
            </div>
          ` : ''}
          
          <h2 class="text-2xl font-bold text-white mb-2 text-shadow">${remoteUser?.name || 'Unknown'}</h2>
          <p id="call-status" class="text-gray-300 text-shadow">
            ${isRinging ? 'Ringing...' : ''}
            ${isConnected ? `<span id="call-duration">${formatCallDuration(state.call.duration)}</span>` : ''}
          </p>
        </div>
        
        <!-- Call controls -->
        <div class="relative p-8 pb-12">
          <div class="flex items-center justify-center gap-6">
            <!-- Mute -->
            <button id="demo-mute-btn" class="w-14 h-14 rounded-full ${isMuted ? 'bg-white' : 'bg-gray-800'} flex items-center justify-center shadow-lg transition-all">
              ${isMuted 
                ? `<svg class="w-6 h-6 text-black" fill="currentColor" viewBox="0 0 24 24"><path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l1.66 1.66c-.71.33-1.5.52-2.31.52-2.76 0-5.3-2.1-5.3-5.1H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c.91-.13 1.77-.45 2.55-.9l4.18 4.18L21 19.73 4.27 3z"/></svg>`
                : `<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15a.998.998 0 00-.98-.85c-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08a6.993 6.993 0 005.91-5.78c.1-.6-.39-1.14-1-1.14z"/></svg>`
              }
            </button>
            
            ${isVideo ? `
              <!-- Camera toggle -->
              <button id="demo-camera-btn" class="w-14 h-14 rounded-full ${isVideoOff ? 'bg-white' : 'bg-gray-800'} flex items-center justify-center shadow-lg transition-all">
                ${isVideoOff 
                  ? `<svg class="w-6 h-6 text-black" fill="currentColor" viewBox="0 0 24 24"><path d="M21 6.5l-4 4V7c0-.55-.45-1-1-1H9.82L21 17.18V6.5zM3.27 2L2 3.27 4.73 6H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.21 0 .39-.08.55-.18L19.73 21 21 19.73 3.27 2z"/></svg>`
                  : `<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>`
                }
              </button>
            ` : `
              <!-- Speaker toggle -->
              <button id="demo-speaker-btn" class="w-14 h-14 rounded-full ${isSpeakerOn ? 'bg-white' : 'bg-gray-800'} flex items-center justify-center shadow-lg transition-all">
                ${isSpeakerOn 
                  ? `<svg class="w-6 h-6 text-black" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`
                  : `<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3z"/></svg>`
                }
              </button>
            `}
            
            <!-- End call -->
            <button id="demo-end-call-btn" class="w-16 h-16 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center shadow-lg transition-transform active:scale-95">
              <svg class="w-8 h-8 text-white transform rotate-135" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>
              </svg>
            </button>
          </div>
        </div>
      `;
      
      // Attach demo call event listeners
      document.getElementById('demo-mute-btn')?.addEventListener('click', () => {
        state.call.isMuted = !state.call.isMuted;
        updateDemoCallScreen();
      });
      
      document.getElementById('demo-camera-btn')?.addEventListener('click', () => {
        state.call.isVideoOff = !state.call.isVideoOff;
        updateDemoCallScreen();
      });
      
      document.getElementById('demo-speaker-btn')?.addEventListener('click', () => {
        state.call.isSpeakerOn = !state.call.isSpeakerOn;
        updateDemoCallScreen();
      });
      
      document.getElementById('demo-end-call-btn')?.addEventListener('click', () => {
        endDemoCall();
      });
    }
    
    function endDemoCall() {
      log('Ending demo call');
      stopRingtone();
      stopCallTimer();
      resetCallState();
    }

    // Call timer
    function startCallTimer() {
      stopCallTimer();
      callTimer = setInterval(() => {
        if (state.call.startTime) {
          state.call.duration = Math.floor((Date.now() - state.call.startTime) / 1000);
          const durationEl = document.getElementById('call-duration');
          if (durationEl) {
            durationEl.textContent = formatCallDuration(state.call.duration);
          }
        }
      }, 1000);
    }

    function stopCallTimer() {
      if (callTimer) {
        clearInterval(callTimer);
        callTimer = null;
      }
    }

    function formatCallDuration(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Voice Note Recording State
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingStartTime = null;
    let recordingInterval = null;
    let isRecording = false;

    // Start voice recording
    async function startVoiceRecording() {
      try {
        log('Starting voice recording...');
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        audioChunks = [];
        isRecording = true;
        recordingStartTime = Date.now();
        
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };
        
        mediaRecorder.onstop = async () => {
          log('Recording stopped, processing audio...');
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          
          // Convert to base64
          const reader = new FileReader();
          reader.onloadend = async () => {
            const base64Audio = reader.result;
            await sendVoiceNote(base64Audio, Math.floor((Date.now() - recordingStartTime) / 1000));
          };
          reader.readAsDataURL(audioBlob);
          
          // Stop all tracks
          stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start(100); // Collect data every 100ms
        
        // Update UI to show recording
        showRecordingUI();
        
        // Update recording duration
        recordingInterval = setInterval(() => {
          const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
          const mins = Math.floor(duration / 60);
          const secs = duration % 60;
          const durationEl = document.getElementById('recording-duration');
          if (durationEl) {
            durationEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
          }
        }, 1000);
        
        log('Voice recording started');
      } catch (err) {
        log('Voice recording error: ' + err.message);
        alert('Could not access microphone. Please check permissions.');
        isRecording = false;
      }
    }
    
    function stopVoiceRecording(cancel = false) {
      if (!mediaRecorder || !isRecording) return;
      
      log('Stopping voice recording, cancel: ' + cancel);
      isRecording = false;
      
      if (recordingInterval) {
        clearInterval(recordingInterval);
        recordingInterval = null;
      }
      
      if (cancel) {
        // Cancel recording - don't save
        mediaRecorder.stop();
        audioChunks = [];
        hideRecordingUI();
        return;
      }
      
      // Check minimum duration (1 second)
      const duration = Date.now() - recordingStartTime;
      if (duration < 1000) {
        log('Recording too short, cancelling');
        mediaRecorder.stop();
        audioChunks = [];
        hideRecordingUI();
        return;
      }
      
      mediaRecorder.stop();
      hideRecordingUI();
    }
    
    function showRecordingUI() {
      const inputArea = document.querySelector('#message-form')?.parentElement;
      if (!inputArea) return;
      
      // Replace input area with recording UI
      const recordingUI = document.createElement('div');
      recordingUI.id = 'recording-ui';
      recordingUI.className = 'flex-1 flex items-center gap-3 bg-red-500/10 rounded-3xl px-4 py-2';
      recordingUI.innerHTML = `
        <div class="flex items-center gap-2 flex-1">
          <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
          <span id="recording-duration" class="text-red-500 font-medium text-sm">00:00</span>
          <div class="flex-1 flex items-center justify-center">
            <div class="flex gap-0.5">
              ${Array(20).fill(0).map(() => '<div class="w-1 bg-red-500/50 rounded-full animate-pulse" style="height: ' + (Math.random() * 20 + 5) + 'px;"></div>').join('')}
            </div>
          </div>
        </div>
        <button id="cancel-recording" class="p-2 text-red-500 hover:bg-red-500/20 rounded-full transition-all" title="Cancel">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
          </svg>
        </button>
        <button id="stop-recording" class="p-3 bg-red-500 text-white rounded-full hover:bg-red-600 transition-all" title="Send voice note">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
        </button>
      `;
      
      // Hide original input elements
      document.getElementById('attachment-btn')?.parentElement?.classList.add('hidden');
      document.getElementById('message-form')?.classList.add('hidden');
      document.getElementById('send-btn')?.classList.add('hidden');
      document.getElementById('voice-note-btn')?.classList.add('hidden');
      
      // Insert recording UI
      inputArea.insertBefore(recordingUI, inputArea.firstChild);
      
      // Attach listeners
      document.getElementById('cancel-recording')?.addEventListener('click', () => stopVoiceRecording(true));
      document.getElementById('stop-recording')?.addEventListener('click', () => stopVoiceRecording(false));
    }
    
    function hideRecordingUI() {
      document.getElementById('recording-ui')?.remove();
      
      // Show original input elements
      document.getElementById('attachment-btn')?.parentElement?.classList.remove('hidden');
      document.getElementById('message-form')?.classList.remove('hidden');
      document.getElementById('send-btn')?.classList.remove('hidden');
      document.getElementById('voice-note-btn')?.classList.remove('hidden');
    }
    
    async function sendVoiceNote(audioBase64, durationSeconds) {
      if (!state.selectedChatId || !state.user) {
        log('Cannot send voice note - missing chatId or user');
        return;
      }
      
      const chatId = state.selectedChatId;
      const now = new Date();
      const tempId = 'temp_' + Date.now();
      
      log('Sending voice note to chat: ' + chatId);
      
      // Create optimistic message
      const tempMsg = {
        id: tempId,
        chatId: chatId,
        senderId: state.user.uid,
        text: '',
        audioUrl: audioBase64,
        audioDuration: durationSeconds,
        type: 'voice',
        timestamp: { toDate: () => now },
        status: 'sending'
      };
      
      // Add to state
      state.messages.push(tempMsg);
      allMessages[chatId] = [...state.messages];
      
      // Save to localStorage
      try {
        const cacheKey = 'linkup_msgs_' + chatId;
        const toCache = state.messages.map(m => ({
          ...m,
          timestamp: m.timestamp?.toDate?.() ? m.timestamp.toDate().toISOString() : (typeof m.timestamp === 'string' ? m.timestamp : new Date().toISOString())
        }));
        localStorage.setItem(cacheKey, JSON.stringify(toCache));
      } catch (e) {
        log('Cache save error: ' + e.message);
      }
      
      updateMessages();
      
      // Scroll to bottom
      const messageList = document.getElementById('message-list');
      if (messageList) {
        messageList.scrollTop = messageList.scrollHeight;
      }
      
      try {
        // Save to Firebase
        const msgRef = await addDoc(collection(db, 'messages'), {
          chatId: chatId,
          senderId: state.user.uid,
          text: '',
          audioUrl: audioBase64,
          audioDuration: durationSeconds,
          type: 'voice',
          timestamp: serverTimestamp(),
          status: 'sent'
        });
        
        log('Voice note saved: ' + msgRef.id);
        
        // Update chat last message
        await updateDoc(doc(db, 'chats', chatId), {
          lastMessage: 'ðŸŽ¤ Voice note (' + formatVoiceDuration(durationSeconds) + ')',
          lastMessageTime: serverTimestamp(),
          lastMessageSenderId: state.user.uid,
          lastMessageStatus: 'sent'
        });
        
        // Update to delivered
        setTimeout(async () => {
          try {
            await updateDoc(doc(db, 'messages', msgRef.id), { status: 'delivered' });
            await updateDoc(doc(db, 'chats', chatId), { lastMessageStatus: 'delivered' });
          } catch (e) {
            log('Error updating to delivered: ' + e.message);
          }
        }, 500);
        
      } catch (err) {
        log('Error sending voice note: ' + err.message);
        const failedMsg = state.messages.find(m => m.id === tempId);
        if (failedMsg) {
          failedMsg.status = 'failed';
          updateMessages();
        }
      }
    }
    
    function formatVoiceDuration(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Voice note playback
    let currentAudio = null;
    let currentAudioId = null;
    
    function playVoiceNote(audioUrl, messageId) {
      // Stop current audio if playing different one
      if (currentAudio && currentAudioId !== messageId) {
        currentAudio.pause();
        currentAudio = null;
        updateVoiceNoteUI(currentAudioId, false);
      }
      
      const playBtn = document.getElementById('voice-play-' + messageId);
      const progressBar = document.getElementById('voice-progress-' + messageId);
      const timeEl = document.getElementById('voice-time-' + messageId);
      
      if (currentAudioId === messageId && currentAudio && !currentAudio.paused) {
        // Pause current
        currentAudio.pause();
        updateVoiceNoteUI(messageId, false);
        return;
      }
      
      // Create new audio
      currentAudio = new Audio(audioUrl);
      currentAudioId = messageId;
      
      currentAudio.onplay = () => {
        updateVoiceNoteUI(messageId, true);
      };
      
      currentAudio.onpause = () => {
        updateVoiceNoteUI(messageId, false);
      };
      
      currentAudio.onended = () => {
        updateVoiceNoteUI(messageId, false);
        if (progressBar) progressBar.style.width = '0%';
      };
      
      currentAudio.ontimeupdate = () => {
        if (currentAudio && progressBar) {
          const percent = (currentAudio.currentTime / currentAudio.duration) * 100;
          progressBar.style.width = percent + '%';
          
          if (timeEl) {
            const remaining = Math.floor(currentAudio.duration - currentAudio.currentTime);
            timeEl.textContent = formatVoiceDuration(remaining);
          }
        }
      };
      
      currentAudio.play().catch(err => {
        log('Audio playback error: ' + err.message);
      });
    }
    
    function updateVoiceNoteUI(messageId, isPlaying) {
      const playBtn = document.getElementById('voice-play-' + messageId);
      if (playBtn) {
        playBtn.innerHTML = isPlaying 
          ? '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>'
          : '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
      }
    }
    
    // Make playVoiceNote available globally
    window.playVoiceNote = playVoiceNote;

    // Ringtone (using Web Audio API)
    let ringtoneContext = null;
    let ringtoneOscillator = null;

    function playRingtone(type) {
      stopRingtone();
      try {
        ringtoneContext = new (window.AudioContext || window.webkitAudioContext)();
        ringtoneOscillator = ringtoneContext.createOscillator();
        const gainNode = ringtoneContext.createGain();
        
        ringtoneOscillator.connect(gainNode);
        gainNode.connect(ringtoneContext.destination);
        
        ringtoneOscillator.type = 'sine';
        ringtoneOscillator.frequency.value = type === 'incoming' ? 440 : 480;
        gainNode.gain.value = 0.1;
        
        ringtoneOscillator.start();
        
        // Create ringtone pattern
        let isPlaying = true;
        const pattern = setInterval(() => {
          if (!ringtoneOscillator) {
            clearInterval(pattern);
            return;
          }
          gainNode.gain.value = isPlaying ? 0 : 0.1;
          isPlaying = !isPlaying;
        }, type === 'incoming' ? 500 : 1000);
      } catch (err) {
        log('Ringtone error: ' + err.message);
      }
    }

    function stopRingtone() {
      if (ringtoneOscillator) {
        try {
          ringtoneOscillator.stop();
        } catch (e) {}
        ringtoneOscillator = null;
      }
      if (ringtoneContext) {
        try {
          ringtoneContext.close();
        } catch (e) {}
        ringtoneContext = null;
      }
    }

    function renderCallScreen() {
      let callScreen = document.getElementById('call-screen');
      if (!callScreen) {
        callScreen = document.createElement('div');
        callScreen.id = 'call-screen';
        callScreen.className = 'fixed inset-0 z-[100] bg-black flex flex-col';
        document.body.appendChild(callScreen);
      }
      callScreen.classList.remove('hidden');
      updateCallScreen();
    }

    function updateCallScreen() {
      const callScreen = document.getElementById('call-screen');
      if (!callScreen || !state.call.active) return;

      const { type, direction, status, remoteUser, isMuted, isVideoOff, isSpeakerOn, localStream, remoteStream } = state.call;
      const isVideo = type === 'video';
      const isConnected = status === 'connected';
      const isIncoming = direction === 'incoming';
      const isRinging = status === 'ringing';

      callScreen.innerHTML = `
        <!-- Video backgrounds (if video call) -->
        ${isVideo ? `
          <div class="absolute inset-0 bg-gray-900">
            <!-- Remote video (full screen) -->
            <video id="remote-video" autoplay playsinline class="w-full h-full object-cover ${remoteStream ? '' : 'hidden'}"></video>
            ${!remoteStream ? `
              <div class="w-full h-full flex items-center justify-center">
                <div class="w-32 h-32 rounded-full bg-gray-800 flex items-center justify-center">
                  ${remoteUser?.avatar 
                    ? `<img src="${remoteUser.avatar}" class="w-full h-full rounded-full object-cover" />`
                    : `<span class="text-5xl text-white font-bold">${remoteUser?.name?.charAt(0) || '?'}</span>`
                  }
                </div>
              </div>
            ` : ''}
          </div>
          
          <!-- Local video (picture-in-picture) -->
          <div class="absolute top-20 right-4 w-32 h-44 rounded-2xl overflow-hidden bg-gray-800 shadow-2xl border-2 border-gray-700 ${isVideoOff ? 'hidden' : ''}">
            <video id="local-video" autoplay playsinline muted class="w-full h-full object-cover"></video>
          </div>
        ` : `
          <!-- Voice call background -->
          <div class="absolute inset-0 bg-gradient-to-b from-gray-900 via-black to-gray-900"></div>
        `}
        
        <!-- Call info overlay -->
        <div class="relative flex-1 flex flex-col items-center justify-center p-8">
          ${!isVideo || !remoteStream ? `
            <!-- Avatar for voice calls or when no video -->
            <div class="relative mb-6">
              <div class="w-36 h-36 rounded-full bg-gray-800 flex items-center justify-center overflow-hidden ring-4 ${isRinging ? 'ring-white/30 animate-pulse' : 'ring-gray-700'}">
                ${remoteUser?.avatar 
                  ? `<img src="${remoteUser.avatar}" class="w-full h-full object-cover" />`
                  : `<span class="text-6xl text-white font-bold">${remoteUser?.name?.charAt(0) || '?'}</span>`
                }
              </div>
              ${isConnected ? `
                <div class="absolute -bottom-1 -right-1 w-8 h-8 rounded-full bg-white flex items-center justify-center">
                  <svg class="w-5 h-5 text-black ${isMuted ? 'hidden' : ''}" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                  </svg>
                  <svg class="w-5 h-5 text-red-500 ${isMuted ? '' : 'hidden'}" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l1.66 1.66c-.71.33-1.5.52-2.31.52-2.76 0-5.3-2.1-5.3-5.1H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c.91-.13 1.77-.45 2.55-.9l4.18 4.18L21 19.73 4.27 3z"/>
                  </svg>
                </div>
              ` : ''}
            </div>
          ` : ''}
          
          <!-- Name and status -->
          <h2 class="text-2xl font-bold text-white mb-2 text-shadow">${remoteUser?.name || 'Unknown'}</h2>
          <p id="call-status" class="text-gray-300 text-shadow">
            ${isRinging && isIncoming ? 'Incoming ' + type + ' call...' : ''}
            ${isRinging && !isIncoming ? 'Ringing...' : ''}
            ${status === 'connecting' ? 'Connecting...' : ''}
            ${isConnected ? `<span id="call-duration">${formatCallDuration(state.call.duration)}</span>` : ''}
          </p>
        </div>
        
        <!-- Call controls -->
        <div class="relative p-8 pb-12">
          ${isRinging && isIncoming ? `
            <!-- Incoming call controls -->
            <div class="flex items-center justify-center gap-12">
              <button id="reject-call-btn" class="w-16 h-16 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center shadow-lg transition-transform active:scale-95">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
              <button id="answer-call-btn" class="w-16 h-16 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center shadow-lg transition-transform active:scale-95 animate-pulse">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                </svg>
              </button>
            </div>
          ` : `
            <!-- Ongoing/Outgoing call controls -->
            <div class="flex items-center justify-center gap-6">
              <!-- Mute -->
              <button id="mute-btn" class="w-14 h-14 rounded-full ${isMuted ? 'bg-white' : 'bg-gray-800'} flex items-center justify-center shadow-lg transition-all">
                ${isMuted 
                  ? `<svg class="w-6 h-6 text-black" fill="currentColor" viewBox="0 0 24 24"><path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l1.66 1.66c-.71.33-1.5.52-2.31.52-2.76 0-5.3-2.1-5.3-5.1H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c.91-.13 1.77-.45 2.55-.9l4.18 4.18L21 19.73 4.27 3z"/></svg>`
                  : `<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15a.998.998 0 00-.98-.85c-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08a6.993 6.993 0 005.91-5.78c.1-.6-.39-1.14-1-1.14z"/></svg>`
                }
              </button>
              
              ${isVideo ? `
                <!-- Camera toggle -->
                <button id="camera-btn" class="w-14 h-14 rounded-full ${isVideoOff ? 'bg-white' : 'bg-gray-800'} flex items-center justify-center shadow-lg transition-all">
                  ${isVideoOff 
                    ? `<svg class="w-6 h-6 text-black" fill="currentColor" viewBox="0 0 24 24"><path d="M21 6.5l-4 4V7c0-.55-.45-1-1-1H9.82L21 17.18V6.5zM3.27 2L2 3.27 4.73 6H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.21 0 .39-.08.55-.18L19.73 21 21 19.73 3.27 2z"/></svg>`
                    : `<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>`
                  }
                </button>
              ` : `
                <!-- Speaker toggle -->
                <button id="speaker-btn" class="w-14 h-14 rounded-full ${isSpeakerOn ? 'bg-white' : 'bg-gray-800'} flex items-center justify-center shadow-lg transition-all">
                  ${isSpeakerOn 
                    ? `<svg class="w-6 h-6 text-black" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`
                    : `<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3z"/></svg>`
                  }
                </button>
              `}
              
              <!-- End call -->
              <button id="end-call-btn" class="w-16 h-16 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center shadow-lg transition-transform active:scale-95">
                <svg class="w-8 h-8 text-white transform rotate-135" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>
                </svg>
              </button>
            </div>
          `}
        </div>
        
        <!-- Audio elements -->
        <audio id="remote-audio" autoplay></audio>
      `;

      // Set up video elements
      if (isVideo) {
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        
        if (localVideo && state.call.localStream) {
          localVideo.srcObject = state.call.localStream;
        }
        if (remoteVideo && state.call.remoteStream) {
          remoteVideo.srcObject = state.call.remoteStream;
        }
      }

      // Set up audio for remote stream
      const remoteAudio = document.getElementById('remote-audio');
      if (remoteAudio && state.call.remoteStream) {
        remoteAudio.srcObject = state.call.remoteStream;
      }

      // Attach event listeners
      document.getElementById('answer-call-btn')?.addEventListener('click', () => answerCall(state.call.callId));
      document.getElementById('reject-call-btn')?.addEventListener('click', () => rejectCall(state.call.callId));
      document.getElementById('end-call-btn')?.addEventListener('click', () => endCall());
      document.getElementById('mute-btn')?.addEventListener('click', () => toggleMute());
      document.getElementById('camera-btn')?.addEventListener('click', () => toggleVideo());
      document.getElementById('speaker-btn')?.addEventListener('click', () => toggleSpeaker());
    }

    // Request Types Configuration
    const REQUEST_TYPES = {
      meeting: {
        name: 'Meeting Request',
        icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`,
        fields: [
          { name: 'date', label: 'Date', type: 'date', required: true },
          { name: 'time', label: 'Time', type: 'time', required: true },
          { name: 'location', label: 'Location', type: 'text', placeholder: 'Meeting location' },
          { name: 'notes', label: 'Notes', type: 'textarea', placeholder: 'Additional notes...' }
        ]
      },
      lunch: {
        name: 'Lunch Request',
        icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /><circle cx="12" cy="12" r="10" stroke-width="2" /></svg>`,
        fields: [
          { name: 'date', label: 'Date', type: 'date', required: true },
          { name: 'time', label: 'Time', type: 'time', required: true },
          { name: 'restaurant', label: 'Restaurant/Location', type: 'text', placeholder: 'Where to eat?' },
          { name: 'notes', label: 'Notes', type: 'textarea', placeholder: 'Any dietary preferences...' }
        ]
      },
      outing: {
        name: 'Outing Request',
        icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`,
        fields: [
          { name: 'date', label: 'Date', type: 'date', required: true },
          { name: 'time', label: 'Time', type: 'time', required: true },
          { name: 'activity', label: 'Activity Type', type: 'select', options: ['Movies', 'Shopping', 'Park', 'Beach', 'Hiking', 'Sports', 'Concert', 'Other'] },
          { name: 'location', label: 'Location', type: 'text', placeholder: 'Where?' },
          { name: 'notes', label: 'Notes', type: 'textarea', placeholder: 'Additional details...' }
        ]
      },
      chillas: {
        name: 'Chillas Request',
        icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>`,
        fields: [
          { name: 'date', label: 'Date', type: 'date', required: true },
          { name: 'time', label: 'Time', type: 'time', required: true },
          { name: 'vibe', label: 'Vibe/Activity', type: 'select', options: ['Netflix & Chill', 'Gaming', 'Music Session', 'Just Vibing', 'BBQ', 'House Party', 'Other'] },
          { name: 'location', label: 'Location', type: 'text', placeholder: 'Where to chill?' },
          { name: 'notes', label: 'Notes', type: 'textarea', placeholder: 'What to bring...' }
        ]
      },
      favor: {
        name: 'Favor Request',
        icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11" /></svg>`,
        fields: [
          { name: 'description', label: 'Favor Description', type: 'textarea', placeholder: 'Describe the favor you need...', required: true },
          { name: 'urgency', label: 'Urgency', type: 'select', options: ['Low - No rush', 'Medium - This week', 'High - ASAP'] },
          { name: 'notes', label: 'Additional Notes', type: 'textarea', placeholder: 'Any other details...' }
        ]
      },
      special: {
        name: 'Special Request',
        icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>`,
        fields: [
          { name: 'title', label: 'Request Title', type: 'text', placeholder: 'What is this about?', required: true },
          { name: 'description', label: 'Description', type: 'textarea', placeholder: 'Describe your request in detail...', required: true },
          { name: 'date', label: 'Date (if applicable)', type: 'date' },
          { name: 'notes', label: 'Additional Notes', type: 'textarea', placeholder: 'Any other details...' }
        ]
      }
    };

    // Check stored auth
    if (state.user && state.userData) {
      state.loading = false;
      log('Restored session: ' + state.userData.email);
    } else {
      state.loading = false;
    }

    // Firebase REST API Auth
    async function loginWithEmail(email, password) {
      log('Login: ' + email);
      const resp = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=${firebaseConfig.apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password, returnSecureToken: true })
      });
      const data = await resp.json();
      if (data.error) throw new Error(data.error.message);

      log('Login success: ' + data.localId);
      const userDoc = await getDoc(doc(db, 'users', data.localId));
      const userData = userDoc.exists() ? { id: data.localId, ...userDoc.data() } : { id: data.localId, email, name: email.split('@')[0] };

      state.user = { uid: data.localId, email: data.email };
      state.userData = userData;
      localStorage.setItem('linkup_user', JSON.stringify(state.user));
      localStorage.setItem('linkup_userData', JSON.stringify(state.userData));
      return state.user;
    }

    async function registerWithEmail(email, password, name, location = '', bio = '') {
      log('Register: ' + email);
      const resp = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${firebaseConfig.apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password, returnSecureToken: true })
      });
      const data = await resp.json();
      if (data.error) throw new Error(data.error.message);
      
      log('Register success: ' + data.localId);
      const userData = {
        name,
        email,
        location: location || '',
        bio: bio || '',
        avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=333&color=fff`,
        status: 'Hey there! I am using Linq',
        isOnline: true,
        createdAt: new Date().toISOString()
      };
      
      await setDoc(doc(db, 'users', data.localId), userData);
      log('User doc created');
      
      state.user = { uid: data.localId, email: data.email };
      state.userData = { id: data.localId, ...userData };
      localStorage.setItem('linkup_user', JSON.stringify(state.user));
      localStorage.setItem('linkup_userData', JSON.stringify(state.userData));
      
      return state.user;
    }

    function logout() {
      log('Logout');
      state.user = null;
      state.userData = null;
      state.connections = [];
      state.chats = [];
      state.receivedInvites = [];
      state.sentInvites = [];
      state.messages = [];
      state.selectedChatId = null;
      localStorage.removeItem('linkup_user');
      localStorage.removeItem('linkup_userData');
      renderFull();
    }

    // Firestore listeners
    let unsubscribers = [];
    let listenersSetup = false;

    function setupListeners() {
      if (!state.user || listenersSetup) return;
      listenersSetup = true;
      log('Setting up Firestore listeners...');
      
      // Clear old listeners
      unsubscribers.forEach(fn => fn());
      unsubscribers = [];

      const uid = state.user.uid;
      log('User ID: ' + uid);

      // Received invites
      try {
        const invitesReceivedQuery = query(
          collection(db, 'invites'),
          where('receiverId', '==', uid),
          where('status', '==', 'pending')
        );
        unsubscribers.push(onSnapshot(invitesReceivedQuery, (snap) => {
          state.receivedInvites = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          log('Received invites: ' + state.receivedInvites.length);
          updateSidebar();
        }, (err) => log('Invites error: ' + err.message)));
      } catch (e) { log('Setup invites error: ' + e.message); }

      // Sent invites
      try {
        const invitesSentQuery = query(
          collection(db, 'invites'),
          where('senderId', '==', uid)
        );
        unsubscribers.push(onSnapshot(invitesSentQuery, (snap) => {
          state.sentInvites = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          log('Sent invites: ' + state.sentInvites.length);
          updateSidebar();
        }, (err) => log('Sent invites error: ' + err.message)));
      } catch (e) { log('Setup sent invites error: ' + e.message); }

      // Connections (accepted invites)
      try {
        const connectionsQuery1 = query(
          collection(db, 'invites'),
          where('senderId', '==', uid),
          where('status', '==', 'accepted')
        );
        const connectionsQuery2 = query(
          collection(db, 'invites'),
          where('receiverId', '==', uid),
          where('status', '==', 'accepted')
        );

        let connections1 = [], connections2 = [];
        
        unsubscribers.push(onSnapshot(connectionsQuery1, async (snap) => {
          log('Connections query 1 returned: ' + snap.docs.length + ' docs');
          const userIds = snap.docs.map(d => d.data().receiverId);
          connections1 = await fetchUsers(userIds);
          state.connections = [...connections1, ...connections2];
          log('Connections (sent): ' + connections1.length);
          log('Total connections: ' + state.connections.length);
          updateSidebar();
          updateTabBadges();
        }, (err) => log('Connections1 error: ' + err.message)));

        unsubscribers.push(onSnapshot(connectionsQuery2, async (snap) => {
          log('Connections query 2 returned: ' + snap.docs.length + ' docs');
          const userIds = snap.docs.map(d => d.data().senderId);
          connections2 = await fetchUsers(userIds);
          state.connections = [...connections1, ...connections2];
          log('Connections (received): ' + connections2.length);
          log('Total connections: ' + state.connections.length);
          updateSidebar();
          updateTabBadges();
        }, (err) => log('Connections2 error: ' + err.message)));
      } catch (e) { log('Setup connections error: ' + e.message); }

      // Chats - with user data preloading
      try {
        const chatsQuery = query(
          collection(db, 'chats'),
          where('participants', 'array-contains', uid)
        );
        unsubscribers.push(onSnapshot(chatsQuery, async (snap) => {
          const chatsRaw = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          log('Chats found: ' + chatsRaw.length);
          
          // Fetch other user data for each chat
          for (const chat of chatsRaw) {
            const otherId = chat.participants.find(p => p !== uid);
            if (otherId && !state.chatUsers) state.chatUsers = {};
            if (otherId && !state.chatUsers[otherId]) {
              try {
                const userDoc = await getDoc(doc(db, 'users', otherId));
                if (userDoc.exists()) {
                  state.chatUsers[otherId] = { id: otherId, ...userDoc.data() };
                  log('Loaded user: ' + state.chatUsers[otherId].name);
                }
              } catch (e) { log('Fetch user error: ' + e.message); }
            }
          }
          
          state.chats = chatsRaw;
          updateSidebar();
        }, (err) => log('Chats error: ' + err.message)));
      } catch (e) { log('Setup chats error: ' + e.message); }

      // Received Requests (requests sent TO me)
      try {
        const receivedRequestsQuery = query(
          collection(db, 'requests'),
          where('toId', '==', uid),
          where('status', '==', 'pending')
        );
        unsubscribers.push(onSnapshot(receivedRequestsQuery, (snap) => {
          state.receivedRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          log('Received requests: ' + state.receivedRequests.length);
          updateSidebar();
          updateTabBadges();
          updateChatRequestBadge();
          // Refresh drawer if open
          if (!document.getElementById('requests-drawer')?.classList.contains('hidden')) {
            updateRequestsDrawer();
          } else {
            // Just update the icon badge
            const iconBadge = document.getElementById('requests-drawer-badge');
            if (iconBadge) {
              const count = state.receivedRequests.length;
              iconBadge.textContent = count;
              iconBadge.classList.toggle('hidden', count === 0);
            }
          }
        }, (err) => log('Received requests error: ' + err.message)));
      } catch (e) { log('Setup received requests error: ' + e.message); }

      // Sent Requests (requests sent BY me)
      try {
        const sentRequestsQuery = query(
          collection(db, 'requests'),
          where('fromId', '==', uid)
        );
        unsubscribers.push(onSnapshot(sentRequestsQuery, (snap) => {
          state.sentRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          log('Sent requests: ' + state.sentRequests.length);
          updateSidebar();
          // Refresh drawer if open
          if (!document.getElementById('requests-drawer')?.classList.contains('hidden')) {
            updateRequestsDrawer();
          }
        }, (err) => log('Sent requests error: ' + err.message)));
      } catch (e) { log('Setup sent requests error: ' + e.message); }

      // Slides (status updates from connections) - without orderBy to avoid index requirement
      try {
        const slidesQuery = query(collection(db, 'slides'));
        unsubscribers.push(onSnapshot(slidesQuery, (snap) => {
          let slides = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          // Sort by createdAt descending in JavaScript
          slides.sort((a, b) => {
            const timeA = a.createdAt?.toDate?.() || new Date(a.createdAt || 0);
            const timeB = b.createdAt?.toDate?.() || new Date(b.createdAt || 0);
            return timeB - timeA; // descending
          });
          state.slides = slides;
          log('Slides: ' + state.slides.length);
          updateSidebar();
        }, (err) => log('Slides error: ' + err.message)));
      } catch (e) { log('Setup slides error: ' + e.message); }

      // â”€â”€ posts (public feed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      try {
        const postsQuery = query(collection(db, 'posts'));
        unsubscribers.push(onSnapshot(postsQuery, (snap) => {
          let allPosts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          // Sort newest first
          allPosts.sort((a, b) => {
            const tA = a.createdAt?.toDate?.() || new Date(a.createdAt || 0);
            const tB = b.createdAt?.toDate?.() || new Date(b.createdAt || 0);
            return tB - tA;
          });
          state.posts = allPosts;
          log('Posts loaded: ' + allPosts.length);
          if (state.activeTab === 'slides') updateSidebar();
        }, err => log('Posts error: ' + err.message)));
      } catch (e) { log('Setup posts error: ' + e.message); }

      // â”€â”€ user_settings (updatesVisibility + blockedUsers) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      try {
        const settingsRef = doc(db, 'user_settings', uid);
        unsubscribers.push(onSnapshot(settingsRef, (snap) => {
          if (snap.exists()) {
            const d = snap.data();
            state.updatesVisibility = d.updatesVisibility !== false;
            state.blockedUsers = d.blockedUsers || [];
          } else {
            state.updatesVisibility = true;
            state.blockedUsers = [];
          }
          log('Settings: visibility=' + state.updatesVisibility + ' blocked=' + state.blockedUsers.length);
        }, err => log('Settings error: ' + err.message)));
      } catch (e) { log('Setup settings error: ' + e.message); }
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  UPDATES FEATURE - BACKEND FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Rate limiting state (in-memory per session)
    const _postTimestamps = [];

    function _canPostNow() {
      const now = Date.now();
      const oneHour = 3600000;
      // Prune old
      while (_postTimestamps.length && now - _postTimestamps[0] > oneHour) _postTimestamps.shift();
      return _postTimestamps.length < 3;
    }

    async function createPost({ content, imageUrl = null, videoUrl = null, visibility = 'circle' }) {
      if (!state.user || !state.userData) return;
      if (!content && !imageUrl && !videoUrl) { alert('Add some text, photo or video first.'); return; }
      if (!_canPostNow()) { alert('You can only post 3 times per hour. Please wait.'); return; }
      // If visibility OFF, force circle
      if (!state.updatesVisibility && visibility === 'public') visibility = 'circle';
      _postTimestamps.push(Date.now());
      const ref = await addDoc(collection(db, 'posts'), {
        userId: state.user.uid,
        userName: state.userData.name,
        userAvatar: state.userData.avatar || '',
        userBio: state.userData.bio || '',
        userLocation: state.userData.location || '',
        content: content || '',
        imageUrl: imageUrl,
        videoUrl: videoUrl || null,
        visibility,
        likesCount: 0,
        commentsCount: 0,
        likedBy: [],
        createdAt: serverTimestamp()
      });
      log('Post created: ' + ref.id);
      return ref.id;
    }

    async function deletePost(postId) {
      if (!postId) return;
      if (!confirm('Delete this post?')) return;
      await deleteDoc(doc(db, 'posts', postId));
      log('Post deleted: ' + postId);
    }

    async function toggleLike(postId) {
      if (!state.user) return;
      const postRef = doc(db, 'posts', postId);
      const snap = await getDoc(postRef);
      if (!snap.exists()) return;
      const data = snap.data();
      const liked = (data.likedBy || []);
      const uid = state.user.uid;
      if (liked.includes(uid)) {
        await updateDoc(postRef, { likedBy: liked.filter(x => x !== uid), likesCount: Math.max(0, (data.likesCount || 1) - 1) });
      } else {
        await updateDoc(postRef, { likedBy: [...liked, uid], likesCount: (data.likesCount || 0) + 1 });
      }
    }

    
    // â”€â”€ Comment helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function addComment(postId, text) {
      if (!state.user || !state.userData || !text.trim()) return;
      await addDoc(collection(db, 'posts', postId, 'comments'), {
        userId: state.user.uid,
        userName: state.userData.name,
        userAvatar: state.userData.avatar || '',
        text: text.trim(),
        createdAt: serverTimestamp()
      });
      // Bump count locally so UI updates immediately
      const post = (state.posts || []).find(p => p.id === postId);
      if (post) post.commentsCount = (post.commentsCount || 0) + 1;
    }

    async function fetchComments(postId) {
      const snap = await getDocs(collection(db, 'posts', postId, 'comments'));
      return snap.docs
        .map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => {
          const ta = a.createdAt?.seconds || 0;
          const tb = b.createdAt?.seconds || 0;
          return ta - tb;
        });
    }

    function openComments(postId) {
      document.getElementById('comments-overlay')?.remove();
      const wrap = document.createElement('div');
      wrap.id = 'comments-overlay';
      wrap.style.cssText = 'position:fixed;inset:0;z-index:80;display:flex;flex-direction:column;justify-content:flex-end;';
      wrap.innerHTML =
        '<div id="co-bg" style="position:absolute;inset:0;background:rgba(0,0,0,.55)"></div>' +
        '<div id="co-sheet" style="position:relative;background:#111;border-radius:20px 20px 0 0;border-top:1px solid #333;display:flex;flex-direction:column;max-height:75vh;animation:slideUpProfile .22s ease">' +
          '<div style="width:36px;height:4px;background:#444;border-radius:2px;margin:12px auto 0"></div>' +
          '<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid #222">' +
            '<span style="color:#fff;font-weight:600;font-size:15px">Comments</span>' +
            '<button id="co-close" style="width:28px;height:28px;border-radius:50%;background:#222;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center">' +
              '<svg width="14" height="14" fill="none" stroke="#aaa" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>' +
            '</button>' +
          '</div>' +
          '<div id="co-list" style="flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:12px">' +
            '<div style="text-align:center;padding:24px 0"><svg style="animation:spin 1s linear infinite;display:inline-block" width="20" height="20" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="#555" stroke-width="4" opacity=".3"/><path fill="#888" d="M4 12a8 8 0 018-8V0C5.4 0 0 5.4 0 12h4z"/></svg></div>' +
          '</div>' +
          '<div style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-top:1px solid #222">' +
            '<div style="width:32px;height:32px;border-radius:50%;overflow:hidden;background:#333;flex-shrink:0">' +
              (state.userData?.avatar
                ? '<img src="' + (state.userData.avatar) + '" style="width:100%;height:100%;object-fit:cover"/>'
                : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:12px">' + (state.userData?.name?.charAt(0) || '?') + '</div>') +
            '</div>' +
            '<div style="flex:1;display:flex;align-items:center;background:#222;border-radius:20px;padding:8px 14px;gap:8px">' +
              '<input id="co-input" type="text" placeholder="Add a comment..." maxlength="300" style="flex:1;background:none;border:none;outline:none;color:#fff;font-size:14px"/>' +
              '<button id="co-send" style="background:none;border:none;cursor:pointer;padding:0">' +
                '<svg width="18" height="18" fill="none" stroke="#4a9eff" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>' +
              '</button>' +
            '</div>' +
          '</div>' +
        '</div>';
      document.body.appendChild(wrap);

      const closeComments = () => wrap.remove();
      document.getElementById('co-bg').addEventListener('click', closeComments);
      document.getElementById('co-close').addEventListener('click', closeComments);

      function renderComments(list) {
        const el = document.getElementById('co-list');
        if (!el) return;
        if (!list.length) {
          el.innerHTML = '<p style="color:#666;font-size:14px;text-align:center;padding:24px 0">No comments yet. Be the first!</p>';
          return;
        }
        el.innerHTML = list.map(c =>
          '<div style="display:flex;gap:10px;align-items:flex-start">' +
            '<div style="width:32px;height:32px;border-radius:50%;overflow:hidden;background:#333;flex-shrink:0">' +
              (c.userAvatar
                ? '<img src="' + c.userAvatar + '" style="width:100%;height:100%;object-fit:cover"/>'
                : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:12px">' + (c.userName?.charAt(0) || '?') + '</div>') +
            '</div>' +
            '<div style="flex:1;background:#1e1e1e;border-radius:14px;padding:8px 12px">' +
              '<p style="color:#fff;font-size:12px;font-weight:600;margin:0 0 3px">' + (c.userName || 'Unknown') + '</p>' +
              '<p style="color:#ccc;font-size:14px;margin:0;line-height:1.4">' + c.text + '</p>' +
            '</div>' +
          '</div>'
        ).join('');
        el.scrollTop = el.scrollHeight;
      }

      fetchComments(postId).then(renderComments);

      async function sendComment() {
        const input = document.getElementById('co-input');
        const text = input?.value?.trim();
        if (!text) return;
        input.value = '';
        await addComment(postId, text);
        // Update count pill in feed
        const countEl = document.querySelector('.post-comment-btn[data-post-id="' + postId + '"] .post-comment-count');
        if (countEl) countEl.textContent = parseInt(countEl.textContent || '0') + 1;
        const list = await fetchComments(postId);
        renderComments(list);
      }

      document.getElementById('co-send').addEventListener('click', sendComment);
      document.getElementById('co-input').addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); sendComment(); }
      });
      setTimeout(() => document.getElementById('co-input')?.focus(), 300);
    }

    async function reportPost(postId, postUserId) {
      if (!state.user || !postId) return;
      await addDoc(collection(db, 'reports'), {
        postId, reportedBy: state.user.uid, reportedUserId: postUserId, createdAt: serverTimestamp()
      });
      alert('Post reported. Thank you â€” our team will review it.');
    }

    async function blockUserFromFeed(userId, userName) {
      if (!state.user || !userId) return;
      if (!confirm('Block ' + userName + '? Their posts won\'t appear in your feed.')) return;
      const ref = doc(db, 'user_settings', state.user.uid);
      const snap = await getDoc(ref);
      const current = snap.exists() ? (snap.data().blockedUsers || []) : [];
      if (!current.includes(userId)) {
        await setDoc(ref, { blockedUsers: [...current, userId] }, { merge: true });
      }
      log('Blocked: ' + userId);
    }

    async function saveUpdatesVisibility(val) {
      if (!state.user) return;
      const ref = doc(db, 'user_settings', state.user.uid);
      await setDoc(ref, { updatesVisibility: val }, { merge: true });
      state.updatesVisibility = val;
      log('updatesVisibility -> ' + val);
      updateSidebar();
    }

    // Send connection invite directly from a post card
    async function sendInviteFromPost(toUserId, toUserName, toUserAvatar, btn) {
      if (!state.user || !state.userData) return;
      // Check duplicate
      const existing = state.sentInvites.find(i => i.toId === toUserId);
      if (existing) {
        btn.textContent = 'Sent';
        btn.disabled = true;
        return;
      }
      // Rate limit 10/day
      const today = new Date(); today.setHours(0,0,0,0);
      const todaySent = (state.sentInvites || []).filter(i => {
        const t = i.createdAt?.toDate?.() || new Date(i.createdAt || 0);
        return t >= today;
      });
      if (todaySent.length >= 10) { alert('You can send at most 10 connection invites per day.'); return; }
      btn.disabled = true;
      btn.innerHTML = '<svg class="w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>';
      try {
        await addDoc(collection(db, 'invites'), {
          fromId: state.user.uid, fromName: state.userData.name, fromAvatar: state.userData.avatar || '',
          toId: toUserId, toName: toUserName, toAvatar: toUserAvatar || '',
          status: 'pending', createdAt: serverTimestamp()
        });
        btn.innerHTML = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg> Sent!';
        btn.classList.add('text-green-400', 'border-green-600');
      } catch (e) {
        btn.disabled = false;
        btn.innerHTML = 'Connect';
        log('Invite error: ' + e.message);
      }
    }

    // Navigate to existing chat with a connected user
    async function openChatWithUser(userId) {
      const user = state.connections.find(c => c.id === userId);
      if (!user) return;
      const chatId = [state.user.uid, userId].sort().join('_');
      try {
        const existing = await getDoc(doc(db, 'chats', chatId));
        if (!existing.exists()) {
          await setDoc(doc(db, 'chats', chatId), {
            participants: [state.user.uid, userId],
            participantNames: { [state.user.uid]: state.userData?.name || 'You', [userId]: user.name },
            participantAvatars: { [state.user.uid]: state.userData?.avatar || '', [userId]: user.avatar || '' },
            lastMessage: '', lastMessageTime: serverTimestamp(),
            lastMessageSenderId: '', lastMessageStatus: '', requestsCount: 0, createdAt: serverTimestamp()
          });
        }
        state.selectedChatId = chatId;
        state.showMobileChat = true;
        if (allMessages[chatId]) state.messages = allMessages[chatId];
        setupMessagesListener(chatId);
        document.getElementById('sidebar')?.classList.add('hidden');
        document.getElementById('sidebar')?.classList.remove('flex');
        document.getElementById('chat-view')?.classList.remove('hidden');
        document.getElementById('chat-view')?.classList.add('flex');
        const chat = state.chats.find(c => c.id === chatId) || { id: chatId, participants: [state.user.uid, userId] };
        document.getElementById('chat-view').innerHTML = renderChatView(chat, user);
        attachChatViewListeners();
        updateChatRequestBadge();
      } catch (e) { log('openChatWithUser error: ' + e.message); }
    }

    // Slide Functions
    async function postSlide(content, type = 'text') {
      if (!state.user || !state.userData) return;
      
      log('Posting slide...');
      await addDoc(collection(db, 'slides'), {
        userId: state.user.uid,
        userName: state.userData.name,
        userAvatar: state.userData.avatar || '',
        content: content,
        type: type, // 'text', 'image', 'quote'
        backgroundColor: getRandomSlideColor(),
        createdAt: serverTimestamp(),
        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24 hours
      });
      log('Slide posted!');
    }

    function getRandomSlideColor() {
      const colors = [
        'bg-gradient-to-br from-gray-800 to-gray-900',
        'bg-gradient-to-br from-gray-700 to-black',
        'bg-gradient-to-br from-gray-600 to-gray-800',
        'bg-gradient-to-br from-black to-gray-800',
        'bg-gradient-to-br from-gray-900 to-black',
        'bg-gradient-to-br from-gray-700 to-gray-900'
      ];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    async function deleteSlide(slideId) {
      await deleteDoc(doc(db, 'slides', slideId));
      log('Slide deleted');
    }

    // Compress and convert image to Base64 with aggressive size reduction
    // High-quality image encoder â€” preserves quality, only downsizes if Firestore limit demands it
    function compressImageToBase64(file, maxSize = 1920) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            let width = img.width;
            let height = img.height;

            // Cap at maxSize on the longest side â€” default 1920px keeps great quality
            if (width > height) {
              if (width > maxSize) { height = Math.round(height * maxSize / width); width = maxSize; }
            } else {
              if (height > maxSize) { width = Math.round(width * maxSize / height); height = maxSize; }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(img, 0, 0, width, height);

            // Try PNG first for lossless (good for avatars/screenshots)
            // Fall back to JPEG at 95% quality â€” visually indistinguishable from original
            let base64 = canvas.toDataURL('image/jpeg', 0.95);

            // Firestore doc limit ~900KB base64 budget â€” step down only if needed
            const maxBytes = 900 * 1024;
            let quality = 0.95;
            while (base64.length > maxBytes && quality > 0.6) {
              quality -= 0.05;
              base64 = canvas.toDataURL('image/jpeg', quality);
              log('Adjusting quality: ' + quality.toFixed(2) + ' â†’ ' + Math.round(base64.length / 1024) + 'KB');
            }

            // Last resort: shrink dimensions (still high quality)
            if (base64.length > maxBytes) {
              const scale = Math.sqrt(maxBytes / base64.length);
              canvas.width  = Math.round(width  * scale);
              canvas.height = Math.round(height * scale);
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              base64 = canvas.toDataURL('image/jpeg', 0.9);
              log('Resized to ' + canvas.width + 'x' + canvas.height + ' â†’ ' + Math.round(base64.length / 1024) + 'KB');
            }

            log('Final: ' + width + 'x' + height + ' ' + Math.round(base64.length / 1024) + 'KB q=' + quality.toFixed(2));
            resolve(base64);
          };
          img.onerror = () => reject(new Error('Failed to load image'));
          img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }
    
    // Helper to add debug log
    function addLog(msg) {
      log(msg);
    }

    // Upload profile picture (Base64 - stored directly in Firestore, no Firebase Storage needed)
    async function uploadProfilePicture(file) {
      if (!state.user || !file) return null;
      
      log('Processing profile picture...');
      try {
        // Compress and convert to Base64
        const base64Image = await compressImageToBase64(file, 400);
        log('Image compressed to Base64');
        
        // Update user document with Base64 image
        await updateDoc(doc(db, 'users', state.user.uid), {
          avatar: base64Image
        });
        
        // Update local state
        state.userData.avatar = base64Image;
        localStorage.setItem('linkup_userData', JSON.stringify(state.userData));
        
        log('Profile picture saved!');
        return base64Image;
      } catch (err) {
        log('Profile upload error: ' + err.message);
        throw err;
      }
    }

    // Convert slide image to Base64 (no Firebase Storage needed)
    async function uploadSlideImage(file) {
      if (!state.user || !file) return null;
      
      log('Converting slide image to Base64...');
      try {
        // Use larger size for slide images (800x800 max)
        const base64Image = await compressImageToBase64(file, 1920);
        log('Slide image converted to Base64!');
        return base64Image;
      } catch (err) {
        log('Slide image error: ' + err.message);
        throw err;
      }
    }

    // Post slide with optional image
    async function postSlideWithImage(content, imageUrl = null) {
      if (!state.user || !state.userData) return;
      
      log('Posting slide...');
      await addDoc(collection(db, 'slides'), {
        userId: state.user.uid,
        userName: state.userData.name,
        userAvatar: state.userData.avatar || '',
        content: content || '',
        imageUrl: imageUrl,
        type: imageUrl ? 'image' : 'text',
        backgroundColor: getRandomSlideColor(),
        createdAt: serverTimestamp(),
        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000)
      });
      log('Slide posted!');
    }

    async function fetchUsers(userIds) {
      const users = [];
      for (const id of userIds) {
        const userDoc = await getDoc(doc(db, 'users', id));
        if (userDoc.exists()) {
          users.push({ id, ...userDoc.data() });
        }
      }
      return users;
    }

    // Store all messages by chatId to prevent data loss
    const allMessages = {};
    let messagesUnsubscribe = null;

    function setupMessagesListener(chatId) {
      if (!chatId) {
        log('No chatId provided to setupMessagesListener');
        return;
      }
      
      log('Setting up messages listener for chat: ' + chatId);
      
      // Load cached messages from localStorage FIRST
      const cacheKey = 'linkup_msgs_' + chatId;
      const cached = localStorage.getItem(cacheKey);
      if (cached) {
        try {
          const cachedMsgs = JSON.parse(cached);
          allMessages[chatId] = cachedMsgs;
          state.messages = cachedMsgs;
          log('Loaded ' + cachedMsgs.length + ' cached messages');
          updateMessages();
        } catch (e) {
          log('Cache parse error: ' + e.message);
        }
      }
      
      if (messagesUnsubscribe) {
        messagesUnsubscribe();
        messagesUnsubscribe = null;
      }
      
      // Simple query without orderBy to avoid requiring a composite index
      // We'll sort the messages in JavaScript instead
      const messagesQuery = query(
        collection(db, 'messages'),
        where('chatId', '==', chatId)
      );
      
      messagesUnsubscribe = onSnapshot(messagesQuery, async (snap) => {
        log('Messages snapshot received: ' + snap.docs.length + ' messages for chat: ' + chatId);
        
        // Convert Firestore docs to message objects
        let firestoreMessages = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        // Sort messages by timestamp (since we're not using orderBy in the query)
        firestoreMessages.sort((a, b) => {
          const timeA = a.timestamp?.toDate?.() || new Date(a.timestamp || 0);
          const timeB = b.timestamp?.toDate?.() || new Date(b.timestamp || 0);
          return timeA - timeB;
        });
        
        // Merge with existing messages (keep optimistic ones that aren't in Firestore yet)
        const existingMessages = allMessages[chatId] || [];
        const optimisticMessages = existingMessages.filter(m => m.id.startsWith('temp_'));
        
        // Combine: Firestore messages + optimistic messages not yet saved
        const merged = [...firestoreMessages];
        optimisticMessages.forEach(optMsg => {
          // Check if this optimistic message was saved (match by text and approximate time)
          const alreadySaved = firestoreMessages.some(fsMsg => 
            fsMsg.text === optMsg.text && 
            fsMsg.senderId === optMsg.senderId
          );
          if (!alreadySaved) {
            merged.push(optMsg);
          }
        });
        
        // Sort by timestamp
        merged.sort((a, b) => {
          const timeA = a.timestamp?.toDate?.() || new Date(a.timestamp || 0);
          const timeB = b.timestamp?.toDate?.() || new Date(b.timestamp || 0);
          return timeA - timeB;
        });
        
        // Update state and cache
        allMessages[chatId] = merged;
        state.messages = merged;
        
        // Save to localStorage (convert timestamps for storage)
        try {
          const toCache = merged.map(m => ({
            ...m,
            timestamp: m.timestamp?.toDate?.() ? m.timestamp.toDate().toISOString() : m.timestamp
          }));
          localStorage.setItem(cacheKey, JSON.stringify(toCache));
        } catch (e) {
          log('Cache save error: ' + e.message);
        }
        
        updateMessages();
        
        // Mark messages from other user as 'read'
        const unreadMessages = snap.docs.filter(d => {
          const data = d.data();
          return data.senderId !== state.user?.uid && data.status !== 'read';
        });
        
        // Update each unread message to 'read'
        if (unreadMessages.length > 0) {
          for (const msgDoc of unreadMessages) {
            try {
              await updateDoc(msgDoc.ref, { status: 'read' });
            } catch (e) {
              log('Error updating message status: ' + e.message);
            }
          }
          
          // Update the chat's lastMessageStatus to 'read' so it shows in the chat list
          try {
            const chat = state.chats.find(c => c.id === chatId);
            if (chat && chat.lastMessageSenderId !== state.user?.uid) {
              await updateDoc(doc(db, 'chats', chatId), { lastMessageStatus: 'read' });
            }
          } catch (e) {
            log('Error updating chat status: ' + e.message);
          }
        }
      }, (error) => {
        // Handle Firestore query errors (like missing index)
        log('Messages query error: ' + error.message);
        
        // If there's a cached version, keep showing it
        if (allMessages[chatId] && allMessages[chatId].length > 0) {
          state.messages = allMessages[chatId];
          updateMessages();
        }
      });
    }

    // Image preview state for sending
    let pendingImageData = null;
    let pendingImageCaption = '';

    // Handle attachment files (images, documents, audio)
    async function handleAttachmentFile(file, type) {
      if (!file || !state.selectedChatId || !state.user) {
        log('Cannot send attachment - missing file, chatId, or user');
        return;
      }
      
      log('Handling attachment: ' + file.name + ' (' + type + ')');
      
      try {
        if (type === 'image' || type === 'media') {
          if (file.type.startsWith('image/')) {
            // Show image preview modal like WhatsApp
            const base64 = await compressImageToBase64(file, 1920);
            showImagePreviewModal(base64);
            log('Image preview shown');
          } else if (file.type.startsWith('video/')) {
            const messageText = 'ðŸŽ¥ [Video: ' + file.name + ']';
            await sendMessage(messageText);
            log('Video attachment sent');
          }
        } else if (type === 'document') {
          const messageText = 'ðŸ“„ [Document: ' + file.name + ']';
          await sendMessage(messageText);
          log('Document attachment sent');
        } else if (type === 'audio') {
          const messageText = 'ðŸŽµ [Audio: ' + file.name + ']';
          await sendMessage(messageText);
          log('Audio attachment sent');
        }
        
      } catch (err) {
        log('Attachment error: ' + err.message);
        alert('Failed to send attachment: ' + err.message);
      }
    }

    // Show WhatsApp-style image preview before sending
    function showImagePreviewModal(base64Image) {
      pendingImageData = base64Image;
      pendingImageCaption = '';
      
      // Get recipient name
      const selectedChat = state.chats.find(c => c.id === state.selectedChatId);
      const otherUser = selectedChat ? getOtherUser(selectedChat) : null;
      const recipientName = otherUser?.name || 'User';
      
      // Create modal HTML
      const modalHtml = `
        <div id="image-preview-modal" class="fixed inset-0 z-[60] bg-black flex flex-col">
          <!-- Header -->
          <div class="flex items-center justify-between p-4 bg-black/90">
            <button id="close-image-preview" class="w-10 h-10 rounded-full flex items-center justify-center text-white hover:bg-white/20 transition-all">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            <div class="flex items-center gap-2">
              <button id="crop-image" class="w-10 h-10 rounded-full flex items-center justify-center text-white hover:bg-white/20 transition-all" title="Crop">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg>
              </button>
              <button id="rotate-image" class="w-10 h-10 rounded-full flex items-center justify-center text-white hover:bg-white/20 transition-all" title="Rotate">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
              </button>
            </div>
          </div>
          
          <!-- Image Preview -->
          <div class="flex-1 flex items-center justify-center p-4 overflow-hidden">
            <img id="preview-img" src="${base64Image}" alt="Preview" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl">
          </div>
          
          <!-- Caption & Send -->
          <div class="p-4 bg-black/90">
            <div class="flex items-center gap-3 max-w-2xl mx-auto">
              <div class="flex-1 flex items-center bg-gray-800 rounded-full px-4 py-2">
                <input type="text" id="image-caption-input" placeholder="Add a caption..." class="flex-1 bg-transparent text-white placeholder-gray-400 outline-none text-sm">
              </div>
              <button id="send-image-btn" class="w-12 h-12 rounded-full bg-white flex items-center justify-center hover:scale-105 active:scale-95 transition-transform shadow-lg">
                <svg class="w-6 h-6 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
              </button>
            </div>
            <p class="text-center text-gray-400 text-xs mt-2">Sending to <span class="text-white font-medium">${recipientName}</span></p>
          </div>
        </div>
      `;
      
      // Add modal to DOM
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Attach event listeners
      document.getElementById('close-image-preview')?.addEventListener('click', closeImagePreviewModal);
      document.getElementById('send-image-btn')?.addEventListener('click', sendImageFromPreview);
      document.getElementById('image-caption-input')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendImageFromPreview();
        }
      });
      
      // Focus caption input
      setTimeout(() => document.getElementById('image-caption-input')?.focus(), 100);
    }
    
    function closeImagePreviewModal() {
      pendingImageData = null;
      pendingImageCaption = '';
      document.getElementById('image-preview-modal')?.remove();
    }
    
    async function sendImageFromPreview() {
      if (!pendingImageData) return;
      
      const caption = document.getElementById('image-caption-input')?.value?.trim() || '';
      
      closeImagePreviewModal();
      
      // Send image as a message with imageUrl field
      await sendImageMessage(pendingImageData, caption);
    }
    
    // Send document message with base64 data
    async function sendDocumentMessage(fileName, base64Data, fileSize, fileType, fileExt) {
      if (!state.selectedChatId || !state.user) {
        log('Cannot send document - missing chatId or user');
        return;
      }
      
      const chatId = state.selectedChatId;
      const now = new Date();
      const tempId = 'temp_' + Date.now();
      
      log('Sending document to chat: ' + chatId);
      
      // Format file size for display
      const formatFileSize = (bytes) => {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      };
      
      // Create optimistic message
      const tempMsg = {
        id: tempId,
        chatId: chatId,
        senderId: state.user.uid,
        text: fileName,
        documentUrl: base64Data,
        documentName: fileName,
        documentSize: fileSize,
        documentType: fileType,
        documentExt: fileExt,
        type: 'document',
        timestamp: { toDate: () => now },
        status: 'sending'
      };
      
      // Add to state
      state.messages.push(tempMsg);
      allMessages[chatId] = [...state.messages];
      
      // Save to localStorage
      try {
        const cacheKey = 'linkup_msgs_' + chatId;
        const toCache = state.messages.map(m => ({
          ...m,
          timestamp: m.timestamp?.toDate?.() ? m.timestamp.toDate().toISOString() : (typeof m.timestamp === 'string' ? m.timestamp : new Date().toISOString())
        }));
        localStorage.setItem(cacheKey, JSON.stringify(toCache));
      } catch (e) {
        log('Cache save error: ' + e.message);
      }
      
      updateMessages();
      
      // Scroll to bottom
      const messageList = document.getElementById('message-list');
      if (messageList) {
        messageList.scrollTop = messageList.scrollHeight;
      }
      
      try {
        // Save to Firebase
        const msgRef = await addDoc(collection(db, 'messages'), {
          chatId: chatId,
          senderId: state.user.uid,
          text: fileName,
          documentUrl: base64Data,
          documentName: fileName,
          documentSize: fileSize,
          documentType: fileType,
          documentExt: fileExt,
          type: 'document',
          timestamp: serverTimestamp(),
          status: 'sent'
        });
        
        log('Document message saved: ' + msgRef.id);
        
        // Update chat last message
        await updateDoc(doc(db, 'chats', chatId), {
          lastMessage: 'ðŸ“„ ' + fileName,
          lastMessageTime: serverTimestamp(),
          lastMessageSenderId: state.user.uid,
          lastMessageStatus: 'sent'
        });
        
        // Update to delivered
        setTimeout(async () => {
          try {
            await updateDoc(doc(db, 'messages', msgRef.id), { status: 'delivered' });
            await updateDoc(doc(db, 'chats', chatId), { lastMessageStatus: 'delivered' });
          } catch (e) {
            log('Error updating to delivered: ' + e.message);
          }
        }, 500);
        
      } catch (err) {
        log('Error sending document: ' + err.message);
        const failedMsg = state.messages.find(m => m.id === tempId);
        if (failedMsg) {
          failedMsg.status = 'failed';
          updateMessages();
        }
      }
    }

    // Send image message with base64 data
    async function sendImageMessage(imageBase64, caption = '') {
      if (!state.selectedChatId || !state.user) {
        log('Cannot send image - missing chatId or user');
        return;
      }
      
      const chatId = state.selectedChatId;
      const now = new Date();
      const tempId = 'temp_' + Date.now();
      
      log('Sending image to chat: ' + chatId);
      
      // Create optimistic message with image
      const tempMsg = {
        id: tempId,
        chatId: chatId,
        senderId: state.user.uid,
        text: caption || '',
        imageUrl: imageBase64,
        type: 'image',
        timestamp: { toDate: () => now },
        status: 'sending'
      };
      
      // Add to state
      state.messages.push(tempMsg);
      allMessages[chatId] = [...state.messages];
      
      // Save to localStorage
      try {
        const cacheKey = 'linkup_msgs_' + chatId;
        const toCache = state.messages.map(m => ({
          ...m,
          timestamp: m.timestamp?.toDate?.() ? m.timestamp.toDate().toISOString() : (typeof m.timestamp === 'string' ? m.timestamp : new Date().toISOString())
        }));
        localStorage.setItem(cacheKey, JSON.stringify(toCache));
      } catch (e) {
        log('Cache save error: ' + e.message);
      }
      
      updateMessages();
      
      // Scroll to bottom
      const messageList = document.getElementById('message-list');
      if (messageList) {
        messageList.scrollTop = messageList.scrollHeight;
      }
      
      try {
        // Save to Firebase
        const msgRef = await addDoc(collection(db, 'messages'), {
          chatId: chatId,
          senderId: state.user.uid,
          text: caption || '',
          imageUrl: imageBase64,
          type: 'image',
          timestamp: serverTimestamp(),
          status: 'sent'
        });
        
        log('Image message saved: ' + msgRef.id);
        
        // Update chat last message
        await updateDoc(doc(db, 'chats', chatId), {
          lastMessage: caption ? 'ðŸ“· ' + caption : 'ðŸ“· Photo',
          lastMessageTime: serverTimestamp(),
          lastMessageSenderId: state.user.uid,
          lastMessageStatus: 'sent'
        });
        
        // Update to delivered
        setTimeout(async () => {
          try {
            await updateDoc(doc(db, 'messages', msgRef.id), { status: 'delivered' });
            await updateDoc(doc(db, 'chats', chatId), { lastMessageStatus: 'delivered' });
          } catch (e) {
            log('Error updating to delivered: ' + e.message);
          }
        }, 500);
        
      } catch (err) {
        log('Error sending image: ' + err.message);
        const failedMsg = state.messages.find(m => m.id === tempId);
        if (failedMsg) {
          failedMsg.status = 'failed';
          updateMessages();
        }
      }
    }
    
    // Handle sharing location
    async function handleShareLocation() {
      if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser');
        return;
      }
      
      log('Getting location...');
      
      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const { latitude, longitude } = position.coords;
          const locationUrl = `https://www.google.com/maps?q=${latitude},${longitude}`;
          const messageText = `ðŸ“ [Location: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}]\n${locationUrl}`;
          await sendMessage(messageText);
          log('Location shared');
        },
        (error) => {
          log('Location error: ' + error.message);
          alert('Could not get your location. Please check your permissions.');
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
    }
    
    // ============== CHAT FEATURES ==============
    
    // Search in chat
    function openSearchInChat() {
      const modalHtml = `
        <div id="search-chat-modal" class="fixed inset-0 z-[60] bg-black/80 flex items-start justify-center pt-20 p-4">
          <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl">
            <div class="p-4 border-b border-gray-200">
              <div class="flex items-center gap-3">
                <button id="close-search-chat" class="p-2 text-gray-600 hover:text-black rounded-full hover:bg-gray-100 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
                <input type="text" id="search-chat-input" placeholder="Search messages..." class="blue-glow-input flex-1 bg-gray-100 text-black placeholder-gray-500 rounded-lg px-4 py-2 border border-transparent focus:outline-none" autofocus>
              </div>
            </div>
            <div id="search-chat-results" class="max-h-80 overflow-y-auto p-2">
              <p class="text-center text-gray-500 py-8 text-sm">Type to search messages</p>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      const input = document.getElementById('search-chat-input');
      const resultsContainer = document.getElementById('search-chat-results');
      
      // Search on input
      input?.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        if (!query) {
          resultsContainer.innerHTML = '<p class="text-center text-gray-500 py-8 text-sm">Type to search messages</p>';
          return;
        }
        
        // Search through messages
        const results = state.messages.filter(msg => 
          msg.text?.toLowerCase().includes(query)
        ).slice(0, 20); // Limit to 20 results
        
        if (results.length === 0) {
          resultsContainer.innerHTML = '<p class="text-center text-gray-500 py-8 text-sm">No messages found</p>';
          return;
        }
        
        resultsContainer.innerHTML = results.map(msg => {
          const isMe = msg.senderId === state.user?.uid;
          const time = formatMessageTime(msg.timestamp);
          const highlightedText = msg.text.replace(
            new RegExp(`(${query})`, 'gi'),
            '<span class="bg-yellow-200 text-black font-medium">$1</span>'
          );
          return `
            <div class="search-result-item p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors" data-msg-id="${msg.id}">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-xs font-medium text-gray-600">${isMe ? 'You' : 'Them'}</span>
                <span class="text-xs text-gray-400">${time}</span>
              </div>
              <p class="text-sm text-black line-clamp-2">${highlightedText}</p>
            </div>
          `;
        }).join('');
        
        // Click to scroll to message
        document.querySelectorAll('.search-result-item').forEach(item => {
          item.addEventListener('click', () => {
            const msgId = item.dataset.msgId;
            document.getElementById('search-chat-modal')?.remove();
            
            // Find and scroll to message
            setTimeout(() => {
              const msgEl = document.querySelector(`[data-msg-id="${msgId}"]`);
              if (msgEl) {
                msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                msgEl.classList.add('bg-yellow-100');
                setTimeout(() => msgEl.classList.remove('bg-yellow-100'), 2000);
              }
            }, 100);
          });
        });
      });
      
      // Close modal
      document.getElementById('close-search-chat')?.addEventListener('click', () => {
        document.getElementById('search-chat-modal')?.remove();
      });
      
      // Close on escape
      const handleEscape = (e) => {
        if (e.key === 'Escape') {
          document.getElementById('search-chat-modal')?.remove();
          document.removeEventListener('keydown', handleEscape);
        }
      };
      document.addEventListener('keydown', handleEscape);
    }
    
    // Mute chat options
    function openMuteOptions() {
      const chatId = state.selectedChatId;
      const isMuted = localStorage.getItem('muted_' + chatId) === 'true';
      
      if (isMuted) {
        // Already muted - ask to unmute
        if (confirm('This chat is muted. Unmute it?')) {
          localStorage.removeItem('muted_' + chatId);
          alert('Chat unmuted!');
        }
        return;
      }
      
      const modalHtml = `
        <div id="mute-modal" class="fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl">
            <div class="p-4 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-black text-center">Mute notifications</h3>
            </div>
            <div class="p-2">
              <button class="mute-option w-full p-3 text-left text-black hover:bg-gray-100 rounded-lg transition-colors" data-duration="8h">8 Hours</button>
              <button class="mute-option w-full p-3 text-left text-black hover:bg-gray-100 rounded-lg transition-colors" data-duration="1w">1 Week</button>
              <button class="mute-option w-full p-3 text-left text-black hover:bg-gray-100 rounded-lg transition-colors" data-duration="always">Always</button>
            </div>
            <div class="p-3 border-t border-gray-200">
              <button id="cancel-mute" class="w-full py-2.5 text-gray-600 hover:text-black font-medium transition-colors">Cancel</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Handle mute options
      document.querySelectorAll('.mute-option').forEach(btn => {
        btn.addEventListener('click', () => {
          const duration = btn.dataset.duration;
          localStorage.setItem('muted_' + chatId, 'true');
          localStorage.setItem('muted_until_' + chatId, duration);
          document.getElementById('mute-modal')?.remove();
          alert('Chat muted for ' + (duration === 'always' ? 'forever' : duration) + '!');
        });
      });
      
      document.getElementById('cancel-mute')?.addEventListener('click', () => {
        document.getElementById('mute-modal')?.remove();
      });
    }
    
    // Wallpaper picker
    function openWallpaperPicker() {
      const chatId = state.selectedChatId;
      const currentWallpaper = localStorage.getItem('wallpaper_' + chatId) || 'default';
      
      const wallpapers = [
        { id: 'default', name: 'Default', class: 'bg-black' },
        { id: 'gray', name: 'Gray', class: 'bg-gray-900' },
        { id: 'dark-blue', name: 'Dark Blue', class: 'bg-slate-900' },
        { id: 'dark-green', name: 'Dark Green', class: 'bg-emerald-950' },
        { id: 'dark-purple', name: 'Dark Purple', class: 'bg-purple-950' },
        { id: 'gradient1', name: 'Gradient 1', class: 'bg-gradient-to-b from-gray-900 to-black' },
        { id: 'gradient2', name: 'Gradient 2', class: 'bg-gradient-to-br from-slate-900 to-gray-900' },
        { id: 'gradient3', name: 'Gradient 3', class: 'bg-gradient-to-b from-zinc-900 to-black' },
      ];
      
      const modalHtml = `
        <div id="wallpaper-modal" class="fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
              <h3 class="text-lg font-semibold text-black">Chat Wallpaper</h3>
              <button id="close-wallpaper" class="p-2 text-gray-600 hover:text-black rounded-full hover:bg-gray-100 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
            <div class="p-4 grid grid-cols-4 gap-3">
              ${wallpapers.map(wp => `
                <button class="wallpaper-option w-full aspect-square rounded-xl ${wp.class} border-2 ${currentWallpaper === wp.id ? 'border-black ring-2 ring-black ring-offset-2' : 'border-gray-300'} hover:border-black transition-all relative overflow-hidden" data-wallpaper="${wp.id}" data-class="${wp.class}">
                  ${currentWallpaper === wp.id ? '<div class="absolute inset-0 flex items-center justify-center"><svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div>' : ''}
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Handle wallpaper selection
      document.querySelectorAll('.wallpaper-option').forEach(btn => {
        btn.addEventListener('click', () => {
          const wallpaperId = btn.dataset.wallpaper;
          const wallpaperClass = btn.dataset.class;
          localStorage.setItem('wallpaper_' + chatId, wallpaperId);
          localStorage.setItem('wallpaper_class_' + chatId, wallpaperClass);
          document.getElementById('wallpaper-modal')?.remove();
          
          // Apply wallpaper immediately
          const messageContainer = document.querySelector('#message-list')?.parentElement;
          if (messageContainer) {
            const overlay = messageContainer.querySelector('.absolute.inset-0');
            if (overlay) {
              overlay.className = 'absolute inset-0 ' + wallpaperClass;
            }
          }
        });
      });
      
      document.getElementById('close-wallpaper')?.addEventListener('click', () => {
        document.getElementById('wallpaper-modal')?.remove();
      });
    }
    
    // Block/Unblock user
    async function toggleBlockUser(userId, userName) {
      const blockedKey = 'blocked_' + userId;
      const isBlocked = localStorage.getItem(blockedKey) === 'true';
      
      if (isBlocked) {
        // Unblock
        if (confirm(`Unblock ${userName}?`)) {
          localStorage.removeItem(blockedKey);
          try {
            await deleteDoc(doc(db, 'blockedUsers', state.user.uid + '_' + userId));
          } catch (e) {}
          alert(userName + ' has been unblocked.');
        }
      } else {
        // Block
        if (confirm(`Block ${userName}? They won't be able to message you.`)) {
          localStorage.setItem(blockedKey, 'true');
          try {
            await setDoc(doc(db, 'blockedUsers', state.user.uid + '_' + userId), {
              blockerId: state.user.uid,
              blockedId: userId,
              createdAt: serverTimestamp()
            });
          } catch (e) {}
          alert(userName + ' has been blocked.');
        }
      }
    }
    
    // Contact picker for sharing
    function openContactPicker() {
      const modalHtml = `
        <div id="contact-picker-modal" class="fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
              <h3 class="text-lg font-semibold text-black">Share Contact</h3>
              <button id="close-contact-picker" class="p-2 text-gray-600 hover:text-black rounded-full hover:bg-gray-100 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
            <div class="p-2 border-b border-gray-200 flex-shrink-0">
              <input type="text" id="contact-search" placeholder="Search contacts..." class="blue-glow-input w-full bg-gray-100 text-black placeholder-gray-500 rounded-lg px-4 py-2 border border-transparent focus:outline-none">
            </div>
            <div id="contact-list" class="flex-1 overflow-y-auto p-2">
              ${state.connections.length === 0 
                ? '<p class="text-center text-gray-500 py-8">No contacts to share</p>'
                : state.connections.map(contact => `
                    <button class="contact-share-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition-colors text-left" data-id="${contact.id}" data-name="${contact.name}" data-email="${contact.email || ''}" data-avatar="${contact.avatar || ''}" data-location="${contact.location || ''}">
                      <img src="${contact.avatar || `https://ui-avatars.com/api/?name=${contact.name}&background=333&color=fff`}" alt="${contact.name}" class="w-12 h-12 rounded-full object-cover">
                      <div>
                        <p class="font-medium text-black">${contact.name}</p>
                        <p class="text-sm text-gray-500">${contact.email || contact.status || ''}</p>
                      </div>
                    </button>
                  `).join('')
              }
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Filter contacts
      document.getElementById('contact-search')?.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        document.querySelectorAll('.contact-share-btn').forEach(btn => {
          const name = btn.dataset.name.toLowerCase();
          btn.style.display = name.includes(query) ? 'flex' : 'none';
        });
      });
      
      // Share contact
      document.querySelectorAll('.contact-share-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const contactData = {
            id: btn.dataset.id,
            name: btn.dataset.name,
            email: btn.dataset.email,
            avatar: btn.dataset.avatar,
            location: btn.dataset.location
          };
          
          document.getElementById('contact-picker-modal')?.remove();
          
          // Send contact as a special message
          const contactMessage = `ðŸ“‡ Contact: ${contactData.name}${contactData.email ? '\\n' + contactData.email : ''}${contactData.location ? '\\nðŸ“ ' + contactData.location : ''}`;
          await sendMessage(contactMessage);
          log('Contact shared: ' + contactData.name);
        });
      });
      
      document.getElementById('close-contact-picker')?.addEventListener('click', () => {
        document.getElementById('contact-picker-modal')?.remove();
      });
    }

    // Clear chat messages
    async function clearChat(chatId) {
      if (!chatId) return;
      
      log('Clearing chat: ' + chatId);
      
      try {
        // Get all messages for this chat
        const messagesQuery = query(
          collection(db, 'messages'),
          where('chatId', '==', chatId)
        );
        const snapshot = await getDocs(messagesQuery);
        
        // Delete each message
        const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
        await Promise.all(deletePromises);
        
        // Clear local state
        state.messages = [];
        allMessages[chatId] = [];
        localStorage.removeItem('linkup_msgs_' + chatId);
        
        // Update chat document
        await updateDoc(doc(db, 'chats', chatId), {
          lastMessage: '',
          lastMessageTime: serverTimestamp(),
          lastMessageSenderId: '',
          lastMessageStatus: ''
        });
        
        // Re-render messages
        updateMessages();
        
        log('Chat cleared: ' + snapshot.docs.length + ' messages deleted');
        alert('Chat cleared!');
      } catch (err) {
        log('Clear chat error: ' + err.message);
        alert('Failed to clear chat: ' + err.message);
      }
    }
    
    async function sendMessage(text) {
      if (!text.trim() || !state.selectedChatId || !state.user) {
        log('Cannot send message - missing text, chatId, or user');
        return;
      }
      
      const trimmedText = text.trim();
      const chatId = state.selectedChatId; // Store locally to avoid issues
      const now = new Date();
      const tempId = 'temp_' + Date.now();
      
      log('Sending message to chat: ' + chatId);
      
      // OPTIMISTIC UPDATE: Add message to local state immediately
      const tempMsg = {
        id: tempId,
        chatId: chatId,
        senderId: state.user.uid,
        text: trimmedText,
        timestamp: { toDate: () => now },
        status: 'sending'
      };
      
      // Add to state and allMessages cache
      state.messages.push(tempMsg);
      allMessages[chatId] = [...state.messages];
      
      // Save to localStorage immediately
      try {
        const cacheKey = 'linkup_msgs_' + chatId;
        const toCache = state.messages.map(m => ({
          ...m,
          timestamp: m.timestamp?.toDate?.() ? m.timestamp.toDate().toISOString() : (typeof m.timestamp === 'string' ? m.timestamp : new Date().toISOString())
        }));
        localStorage.setItem(cacheKey, JSON.stringify(toCache));
        log('Message cached to localStorage');
      } catch (e) {
        log('Cache save error: ' + e.message);
      }
      
      updateMessages();
      
      // Scroll to bottom immediately
      const messageList = document.getElementById('message-list');
      if (messageList) {
        messageList.scrollTop = messageList.scrollHeight;
      }
      
      try {
        // Add message to Firebase
        const msgRef = await addDoc(collection(db, 'messages'), {
          chatId: chatId,
          senderId: state.user.uid,
          text: trimmedText,
          timestamp: serverTimestamp(),
          status: 'sent'
        });
        
        log('Message saved to Firebase: ' + msgRef.id + ' for chat: ' + chatId);

        // Update chat with last message info
        try {
          await updateDoc(doc(db, 'chats', chatId), {
            lastMessage: trimmedText,
            lastMessageTime: serverTimestamp(),
            lastMessageSenderId: state.user.uid,
            lastMessageStatus: 'sent'
          });
          log('Chat lastMessage updated');
        } catch (chatErr) {
          log('Error updating chat: ' + chatErr.message);
        }
        
        // Update to 'delivered' after a short delay
        setTimeout(async () => {
          try {
            await updateDoc(doc(db, 'messages', msgRef.id), { status: 'delivered' });
            await updateDoc(doc(db, 'chats', chatId), {
              lastMessageStatus: 'delivered'
            });
            log('Message status updated to delivered');
          } catch (e) {
            log('Error updating to delivered: ' + e.message);
          }
        }, 500);
        
      } catch (err) {
        log('Error sending message: ' + err.message);
        // Keep message in cache even on error (will retry later)
        // Mark as failed instead of removing
        const failedMsg = state.messages.find(m => m.id === tempId);
        if (failedMsg) {
          failedMsg.status = 'failed';
          updateMessages();
        }
        alert('Failed to send message. Please try again.');
      }
    }

    async function sendInvite(user) {
      if (!state.user || !state.userData) return;
      
      log('Sending invite to: ' + user.name);
      await addDoc(collection(db, 'invites'), {
        senderId: state.user.uid,
        senderName: state.userData.name,
        senderAvatar: state.userData.avatar || '',
        senderEmail: state.userData.email,
        receiverId: user.id,
        receiverName: user.name,
        receiverAvatar: user.avatar || '',
        receiverEmail: user.email,
        status: 'pending',
        createdAt: serverTimestamp()
      });
      log('Invite sent!');
    }

    async function acceptInvite(inviteId) {
      log('Accepting invite: ' + inviteId);
      const inviteDoc = await getDoc(doc(db, 'invites', inviteId));
      if (!inviteDoc.exists()) return;
      
      const invite = inviteDoc.data();
      
      // Create chat with both user IDs sorted to create consistent chat ID
      const chatId = [invite.senderId, invite.receiverId].sort().join('_');
      
      try {
        // Check if chat already exists
        const existingChat = await getDoc(doc(db, 'chats', chatId));
        
        if (!existingChat.exists()) {
          // Create new chat document with specific ID
          await setDoc(doc(db, 'chats', chatId), {
            participants: [invite.senderId, invite.receiverId],
            participantNames: {
              [invite.senderId]: invite.senderName,
              [invite.receiverId]: invite.receiverName
            },
            participantAvatars: {
              [invite.senderId]: invite.senderAvatar || '',
              [invite.receiverId]: invite.receiverAvatar || ''
            },
            lastMessage: 'You are now connected! Say hi ðŸ‘‹',
            lastMessageTime: serverTimestamp(),
            lastMessageSenderId: 'system',
            lastMessageStatus: 'read',
            requestsCount: 0,
            createdAt: serverTimestamp()
          });
          log('Chat created: ' + chatId);
          
          // Add system message
          await addDoc(collection(db, 'messages'), {
            chatId: chatId,
            senderId: 'system',
            text: 'ðŸŽ‰ You are now connected! Start your conversation.',
            timestamp: serverTimestamp(),
            status: 'read'
          });
        }
        
        // Update invite status
        await updateDoc(doc(db, 'invites', inviteId), { 
          status: 'accepted',
          acceptedAt: serverTimestamp()
        });
        
        log('Invite accepted!');
        
        // Force refresh the sidebar
        updateSidebar();
        updateTabBadges();
        
      } catch (err) {
        log('Error accepting invite: ' + err.message);
      }
    }

    async function rejectInvite(inviteId) {
      await updateDoc(doc(db, 'invites', inviteId), { status: 'rejected' });
    }

    async function cancelInvite(inviteId) {
      await deleteDoc(doc(db, 'invites', inviteId));
    }

    // Request Functions
    async function sendRequest(toUser, type, details) {
      if (!state.user || !state.userData || !toUser) return;
      
      log('Sending ' + type + ' request to: ' + toUser.name);
      await addDoc(collection(db, 'requests'), {
        fromId: state.user.uid,
        fromName: state.userData.name,
        fromAvatar: state.userData.avatar || '',
        toId: toUser.id,
        toName: toUser.name,
        toAvatar: toUser.avatar || '',
        type: type,
        details: details,
        status: 'pending',
        createdAt: serverTimestamp()
      });
      log('Request sent!');
    }

    async function acceptRequest(requestId) {
      log('Accepting request: ' + requestId);
      await updateDoc(doc(db, 'requests', requestId), { 
        status: 'accepted',
        respondedAt: serverTimestamp()
      });
      // Refresh drawer immediately so user sees the change
      const drawer = document.getElementById('requests-drawer');
      if (drawer && !drawer.classList.contains('hidden')) {
        updateRequestsDrawer();
      }
      updateSidebar();
    }

    async function declineRequest(requestId) {
      log('Declining request: ' + requestId);
      await updateDoc(doc(db, 'requests', requestId), { 
        status: 'declined',
        respondedAt: serverTimestamp()
      });
      // Refresh drawer immediately so user sees the change
      const drawer = document.getElementById('requests-drawer');
      if (drawer && !drawer.classList.contains('hidden')) {
        updateRequestsDrawer();
      }
      updateSidebar();
    }

    async function searchUsers(queryStr) {
      if (!queryStr.trim() || !state.user) return;
      
      log('Searching: ' + queryStr);
      const snapshot = await getDocs(collection(db, 'users'));
      const results = [];
      const myLocation = state.userData?.location?.toLowerCase() || '';
      
      snapshot.forEach((doc) => {
        const data = doc.data();
        const q = queryStr.toLowerCase();
        if (doc.id !== state.user.uid && 
            (data.email?.toLowerCase().includes(q) || data.name?.toLowerCase().includes(q) || data.location?.toLowerCase().includes(q))) {
          // Add location match indicator
          const userLocation = data.location?.toLowerCase() || '';
          const sameLocation = myLocation && userLocation && (
            userLocation.includes(myLocation.split(',')[0]) || 
            myLocation.includes(userLocation.split(',')[0])
          );
          results.push({ id: doc.id, ...data, sameLocation });
        }
      });
      
      // Sort results: same location first
      results.sort((a, b) => {
        if (a.sameLocation && !b.sameLocation) return -1;
        if (!a.sameLocation && b.sameLocation) return 1;
        return 0;
      });
      
      state.searchResults = results;
      log('Found: ' + results.length + ' users');
      renderSearchResults();
    }

    // Suggest connections based on location
    async function getSuggestedConnections() {
      if (!state.user || !state.userData?.location) return [];
      
      const myLocation = state.userData.location.toLowerCase();
      const locationParts = myLocation.split(',').map(p => p.trim());
      
      const snapshot = await getDocs(collection(db, 'users'));
      const suggestions = [];
      
      snapshot.forEach((doc) => {
        if (doc.id === state.user.uid) return;
        
        const data = doc.data();
        const userLocation = data.location?.toLowerCase() || '';
        
        // Check if any part of location matches
        const matches = locationParts.some(part => userLocation.includes(part));
        
        if (matches) {
          // Check if already connected or invite pending
          const status = getInviteStatus(doc.id);
          if (status === 'none') {
            suggestions.push({ id: doc.id, ...data });
          }
        }
      });
      
      return suggestions;
    }

    // Helper functions
    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      
      if (days === 0) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      if (days === 1) return 'Yesterday';
      if (days < 7) return date.toLocaleDateString([], { weekday: 'short' });
      return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
    }

    function formatMessageTime(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatLastSeen(timestamp, isOnline) {
      if (isOnline) return 'online';
      if (!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const diff = Date.now() - date.getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'last seen just now';
      if (mins < 60) return `last seen ${mins} min ago`;
      const hours = Math.floor(mins / 60);
      if (hours < 24) return `last seen ${hours}h ago`;
      return `last seen ${Math.floor(hours / 24)}d ago`;
    }

    function getInviteStatus(userId) {
      if (state.connections.find(c => c.id === userId)) return 'connected';
      const sent = state.sentInvites.find(i => i.receiverId === userId);
      if (sent && sent.status === 'pending') return 'pending';
      return 'none';
    }

    function renderInvitesPanel() {
      const received = state.receivedInvites || [];
      const sent = state.sentInvites.filter(i => i.status === 'pending') || [];
      const activeTab = state.invitesPanelTab || 'received';

      const tabBar = `
        <div class="flex border-b border-gray-200">
          <button class="invite-panel-tab flex-1 py-2.5 text-sm font-medium transition-colors relative ${activeTab === 'received' ? 'text-black' : 'text-gray-400 hover:text-gray-600'}" data-tab="received">
            Received
            ${received.length > 0 ? `<span class="ml-1 px-1.5 py-0.5 text-xs rounded-full bg-black text-white">${received.length}</span>` : ''}
            ${activeTab === 'received' ? '<div class="absolute bottom-0 left-0 right-0 h-0.5 bg-black"></div>' : ''}
          </button>
          <button class="invite-panel-tab flex-1 py-2.5 text-sm font-medium transition-colors relative ${activeTab === 'sent' ? 'text-black' : 'text-gray-400 hover:text-gray-600'}" data-tab="sent">
            Sent
            ${sent.length > 0 ? `<span class="ml-1 px-1.5 py-0.5 text-xs rounded-full bg-gray-200 text-gray-700">${sent.length}</span>` : ''}
            ${activeTab === 'sent' ? '<div class="absolute bottom-0 left-0 right-0 h-0.5 bg-black"></div>' : ''}
          </button>
        </div>
      `;

      if (activeTab === 'received') {
        if (received.length === 0) {
          return tabBar + `
            <div class="p-6 text-center text-gray-500">
              <svg class="w-10 h-10 mx-auto mb-2 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              <p class="text-sm font-medium">No connection requests</p>
              <p class="text-xs text-gray-400 mt-1">When someone wants to connect, they'll show up here</p>
            </div>
          `;
        }
        return tabBar + `
          <div class="p-3 space-y-2">
            ${received.map(invite => `
              <div class="bg-gray-50 rounded-xl p-3 border border-gray-100">
                <div class="flex items-center gap-3 mb-3">
                  <img src="${invite.senderAvatar || `https://ui-avatars.com/api/?name=${invite.senderName}&background=333&color=fff`}" alt="${invite.senderName}" class="w-11 h-11 rounded-full object-cover">
                  <div class="flex-1 min-w-0">
                    <p class="text-black font-semibold text-sm truncate">${invite.senderName}</p>
                    <p class="text-gray-500 text-xs">Wants to connect with you</p>
                  </div>
                </div>
                <div class="flex gap-2">
                  <button class="accept-invite-panel flex-1 py-2 bg-black text-white rounded-lg text-sm font-medium hover:bg-gray-800 transition-colors" data-id="${invite.id}">
                    Accept
                  </button>
                  <button class="reject-invite-panel flex-1 py-2 bg-gray-200 text-black rounded-lg text-sm font-medium hover:bg-gray-300 transition-colors" data-id="${invite.id}">
                    Decline
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } else {
        if (sent.length === 0) {
          return tabBar + `
            <div class="p-6 text-center text-gray-500">
              <svg class="w-10 h-10 mx-auto mb-2 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
              <p class="text-sm font-medium">No sent requests</p>
              <p class="text-xs text-gray-400 mt-1">Your pending connection requests will appear here</p>
            </div>
          `;
        }
        return tabBar + `
          <div class="p-3 space-y-2">
            ${sent.map(invite => `
              <div class="bg-gray-50 rounded-xl p-3 border border-gray-100">
                <div class="flex items-center gap-3 mb-3">
                  <img src="${invite.receiverAvatar || `https://ui-avatars.com/api/?name=${invite.receiverName}&background=333&color=fff`}" alt="${invite.receiverName}" class="w-11 h-11 rounded-full object-cover">
                  <div class="flex-1 min-w-0">
                    <p class="text-black font-semibold text-sm truncate">${invite.receiverName}</p>
                    <p class="text-gray-500 text-xs flex items-center gap-1">
                      <span class="w-1.5 h-1.5 rounded-full bg-yellow-400 inline-block"></span>
                      Waiting for response...
                    </p>
                  </div>
                </div>
                <button class="cancel-invite-panel w-full py-2 bg-gray-200 text-black rounded-lg text-sm font-medium hover:bg-gray-300 transition-colors" data-id="${invite.id}">
                  Cancel Request
                </button>
              </div>
            `).join('')}
          </div>
        `;
      }
    }

    function updateInvitesPanel() {
      const content = document.getElementById('invites-panel-content');
      if (content) {
        content.innerHTML = renderInvitesPanel();
        attachInvitesPanelListeners();
      }
      // Update badge
      const badge = document.getElementById('header-invites-badge');
      if (badge) {
        badge.textContent = state.receivedInvites.length || '';
        badge.classList.toggle('hidden', state.receivedInvites.length === 0);
      }
    }

    function attachInvitesPanelListeners() {
      // Tab switching
      document.querySelectorAll('.invite-panel-tab').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          state.invitesPanelTab = btn.dataset.tab;
          updateInvitesPanel();
        });
      });
      document.querySelectorAll('.accept-invite-panel').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          acceptInvite(btn.dataset.id);
        });
      });
      document.querySelectorAll('.reject-invite-panel').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          rejectInvite(btn.dataset.id);
        });
      });
      document.querySelectorAll('.cancel-invite-panel').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          cancelInvite(btn.dataset.id);
        });
      });
    }

    // Slide viewer state
    let currentSlideIndex = 0;
    let slideProgressInterval = null;
    let slideProgress = 0;
    let currentUserSlides = [];
    let slidePaused = false;
    const SLIDE_DURATION = 5000; // 5 seconds per slide

    function renderSlideViewer(userId) {
      const now = Date.now();
      const twentyFourHours = 24 * 60 * 60 * 1000;
      
      // Get slides for this user from last 24 hours
      currentUserSlides = (state.slides || []).filter(s => {
        const slideTime = s.createdAt?.toDate?.() || new Date(s.createdAt);
        return s.userId === userId && (now - slideTime.getTime()) < twentyFourHours;
      }).sort((a, b) => {
        const timeA = a.createdAt?.toDate?.() || new Date(a.createdAt);
        const timeB = b.createdAt?.toDate?.() || new Date(b.createdAt);
        return timeA - timeB;
      });
      
      if (currentUserSlides.length === 0) {
        return `
          <div class="flex-1 flex items-center justify-center text-gray-400 bg-black">
            <div class="text-center">
              <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
              <p>No slides to show</p>
              <button id="close-slide-viewer" class="mt-4 px-4 py-2 bg-white text-black rounded-lg">Close</button>
            </div>
          </div>
        `;
      }
      
      // Ensure index is in bounds
      if (currentSlideIndex >= currentUserSlides.length) currentSlideIndex = 0;
      
      const slide = currentUserSlides[currentSlideIndex];
      const slideTime = slide.createdAt?.toDate?.() || new Date(slide.createdAt);
      const timeAgo = getTimeAgo(slideTime);
      const isMySlide = userId === state.user?.uid;
      
      return `
        <!-- Touch zones for navigation -->
        <div class="absolute inset-0 z-20 flex">
          <div id="slide-prev-zone" class="w-1/3 h-full cursor-pointer"></div>
          <div id="slide-pause-zone" class="w-1/3 h-full cursor-pointer"></div>
          <div id="slide-next-zone" class="w-1/3 h-full cursor-pointer"></div>
        </div>
        
        <!-- Header with progress bars -->
        <div class="absolute top-0 left-0 right-0 z-30 p-4 bg-gradient-to-b from-black/80 via-black/40 to-transparent">
          <!-- Progress bars - WhatsApp style -->
          <div class="flex gap-1 mb-4">
            ${currentUserSlides.map((s, i) => `
              <div class="flex-1 h-1 rounded-full bg-white/30 overflow-hidden">
                <div class="slide-progress-bar h-full bg-white rounded-full transition-all duration-100" 
                     style="width: ${i < currentSlideIndex ? '100' : i === currentSlideIndex ? slideProgress : '0'}%"
                     data-index="${i}"></div>
              </div>
            `).join('')}
          </div>
          
          <!-- User info and controls -->
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <img src="${slide.userAvatar || `https://ui-avatars.com/api/?name=${slide.userName}&background=333&color=fff`}" 
                   alt="${slide.userName}" 
                   class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-lg">
              <div>
                <p class="text-white font-semibold text-shadow">${slide.userName}</p>
                <p class="text-white/80 text-xs">${timeAgo}</p>
              </div>
            </div>
            <div class="flex items-center gap-1">
              ${isMySlide ? `
                <button id="delete-slide" class="p-2 text-white/80 hover:text-white transition-colors" data-id="${slide.id}" title="Delete">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              ` : `
                <button id="mute-slide" class="p-2 text-white/80 hover:text-white transition-colors" title="Mute">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                  </svg>
                </button>
              `}
              <button id="close-slide-viewer" class="p-2 text-white/80 hover:text-white transition-colors" title="Close">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Slide Content -->
        <div class="absolute inset-0 flex items-center justify-center ${slide.imageUrl ? 'bg-black' : slide.backgroundColor || 'bg-gradient-to-br from-gray-800 to-black'}">
          ${slide.imageUrl 
            ? `<img src="${slide.imageUrl}" alt="Slide" class="w-full h-full object-contain">`
            : `<div class="p-8 flex items-center justify-center h-full">
                <p class="text-white text-2xl md:text-3xl font-medium text-center leading-relaxed max-w-lg">${slide.content}</p>
              </div>`
          }
        </div>
        
        <!-- Caption overlay for image slides -->
        ${slide.imageUrl && slide.content ? `
          <div class="absolute bottom-24 left-0 right-0 z-30 px-4">
            <div class="bg-black/60 backdrop-blur-sm rounded-2xl px-4 py-3 max-w-lg mx-auto">
              <p class="text-white text-center">${slide.content}</p>
            </div>
          </div>
        ` : ''}
        
        <!-- Footer - Reply input -->
        ${!isMySlide ? `
          <div class="absolute bottom-0 left-0 right-0 z-30 p-4 bg-gradient-to-t from-black/80 via-black/40 to-transparent">
            <div class="flex items-center gap-2 max-w-lg mx-auto">
              <input type="text" id="slide-reply" 
                     placeholder="Reply to ${slide.userName}..." 
                     class="flex-1 bg-white/20 backdrop-blur-sm text-white placeholder-white/60 rounded-full px-5 py-3 focus:outline-none focus:ring-2 focus:ring-white/40 border border-white/20">
              <button id="send-slide-reply" class="p-3 bg-white text-black rounded-full hover:bg-gray-200 transition-colors shadow-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
              </button>
            </div>
          </div>
        ` : `
          <div class="absolute bottom-0 left-0 right-0 z-30 p-4 bg-gradient-to-t from-black/80 to-transparent">
            <div class="flex items-center justify-center gap-4 text-white/80">
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                <span class="text-sm">${currentSlideIndex + 1} of ${currentUserSlides.length}</span>
              </div>
            </div>
          </div>
        `}
        
        <!-- Pause indicator -->
        <div id="pause-indicator" class="hidden absolute inset-0 z-40 flex items-center justify-center bg-black/30 pointer-events-none">
          <div class="w-20 h-20 rounded-full bg-black/50 flex items-center justify-center">
            <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
            </svg>
          </div>
        </div>
      `;
    }

    function startSlideProgress() {
      stopSlideProgress();
      slideProgress = 0;
      
      slideProgressInterval = setInterval(() => {
        if (slidePaused) return;
        
        slideProgress += (100 / (SLIDE_DURATION / 100));
        
        // Update progress bar
        const progressBars = document.querySelectorAll('.slide-progress-bar');
        progressBars.forEach((bar, i) => {
          if (i < currentSlideIndex) {
            bar.style.width = '100%';
          } else if (i === currentSlideIndex) {
            bar.style.width = `${Math.min(slideProgress, 100)}%`;
          } else {
            bar.style.width = '0%';
          }
        });
        
        // Move to next slide when progress completes
        if (slideProgress >= 100) {
          goToNextSlide();
        }
      }, 100);
    }

    function stopSlideProgress() {
      if (slideProgressInterval) {
        clearInterval(slideProgressInterval);
        slideProgressInterval = null;
      }
    }

    function goToNextSlide() {
      if (currentSlideIndex < currentUserSlides.length - 1) {
        currentSlideIndex++;
        slideProgress = 0;
        updateSlideContent();
      } else {
        // End of slides - close viewer or go to next user
        closeSlideViewer();
      }
    }

    function goToPrevSlide() {
      if (currentSlideIndex > 0) {
        currentSlideIndex--;
        slideProgress = 0;
        updateSlideContent();
      } else {
        // Beginning of slides - restart current
        slideProgress = 0;
      }
    }

    function updateSlideContent() {
      const content = document.getElementById('slide-viewer-content');
      if (content) {
        content.innerHTML = renderSlideViewer(state.viewingSlideUserId);
        attachSlideViewerListeners();
      }
    }

    function openSlideViewer(userId) {
      state.showSlideViewer = true;
      state.viewingSlideUserId = userId;
      currentSlideIndex = 0;
      slideProgress = 0;
      slidePaused = false;
      
      const viewer = document.getElementById('slide-viewer');
      const content = document.getElementById('slide-viewer-content');
      
      if (viewer && content) {
        viewer.classList.remove('hidden');
        content.innerHTML = renderSlideViewer(userId);
        attachSlideViewerListeners();
        startSlideProgress();
      }
    }

    function closeSlideViewer() {
      stopSlideProgress();
      state.showSlideViewer = false;
      state.viewingSlideUserId = null;
      currentSlideIndex = 0;
      currentUserSlides = [];
      document.getElementById('slide-viewer')?.classList.add('hidden');
    }

    function attachSlideViewerListeners() {
      // Close button
      document.getElementById('close-slide-viewer')?.addEventListener('click', closeSlideViewer);
      
      // Navigation zones - tap left to go back, right to go forward
      document.getElementById('slide-prev-zone')?.addEventListener('click', (e) => {
        e.stopPropagation();
        goToPrevSlide();
      });
      
      document.getElementById('slide-next-zone')?.addEventListener('click', (e) => {
        e.stopPropagation();
        goToNextSlide();
      });
      
      // Pause zone - hold to pause
      const pauseZone = document.getElementById('slide-pause-zone');
      const pauseIndicator = document.getElementById('pause-indicator');
      
      pauseZone?.addEventListener('mousedown', () => {
        slidePaused = true;
        pauseIndicator?.classList.remove('hidden');
      });
      
      pauseZone?.addEventListener('mouseup', () => {
        slidePaused = false;
        pauseIndicator?.classList.add('hidden');
      });
      
      pauseZone?.addEventListener('mouseleave', () => {
        slidePaused = false;
        pauseIndicator?.classList.add('hidden');
      });
      
      // Touch events for mobile
      pauseZone?.addEventListener('touchstart', (e) => {
        e.preventDefault();
        slidePaused = true;
        pauseIndicator?.classList.remove('hidden');
      });
      
      pauseZone?.addEventListener('touchend', () => {
        slidePaused = false;
        pauseIndicator?.classList.add('hidden');
      });
      
      // Keyboard navigation
      const handleKeyPress = (e) => {
        if (!state.showSlideViewer) return;
        
        if (e.key === 'ArrowLeft') {
          goToPrevSlide();
        } else if (e.key === 'ArrowRight' || e.key === ' ') {
          goToNextSlide();
        } else if (e.key === 'Escape') {
          closeSlideViewer();
        }
      };
      
      document.addEventListener('keydown', handleKeyPress);
      
      // Delete slide
      document.getElementById('delete-slide')?.addEventListener('click', async (e) => {
        e.stopPropagation();
        stopSlideProgress();
        const slideId = e.currentTarget.dataset.id;
        if (confirm('Delete this slide?')) {
          await deleteSlide(slideId);
          // If there are more slides, show the next one
          if (currentUserSlides.length > 1) {
            if (currentSlideIndex >= currentUserSlides.length - 1) {
              currentSlideIndex = Math.max(0, currentSlideIndex - 1);
            }
            updateSlideContent();
            startSlideProgress();
          } else {
            closeSlideViewer();
          }
        } else {
          startSlideProgress();
        }
      });
      
      // Reply input - pause progress when typing
      const replyInput = document.getElementById('slide-reply');
      replyInput?.addEventListener('focus', () => {
        slidePaused = true;
      });
      replyInput?.addEventListener('blur', () => {
        slidePaused = false;
      });
      
      // Send reply
      document.getElementById('send-slide-reply')?.addEventListener('click', async () => {
        const input = document.getElementById('slide-reply');
        if (!input || !input.value.trim()) return;
        
        const userId = state.viewingSlideUserId;
        const text = input.value.trim();
        
        // Find or create chat with this user
        let chat = state.chats.find(c => c.participants.includes(userId));
        
        if (!chat) {
          // Create new chat
          const chatRef = await addDoc(collection(db, 'chats'), {
            participants: [state.user.uid, userId],
            lastMessage: text,
            lastMessageTime: serverTimestamp(),
            requestsCount: 0
          });
          chat = { id: chatRef.id };
        }
        
        // Send message
        await addDoc(collection(db, 'messages'), {
          chatId: chat.id,
          senderId: state.user.uid,
          text: `[Replied to slide] ${text}`,
          timestamp: serverTimestamp(),
          status: 'sent'
        });
        
        await updateDoc(doc(db, 'chats', chat.id), {
          lastMessage: `[Replied to slide] ${text}`,
          lastMessageTime: serverTimestamp()
        });
        
        closeSlideViewer();
        log('Slide reply sent!');
      });
    }

    function getOtherUser(chat) {
      const otherId = chat.participants.find(p => p !== state.user?.uid);
      // First try chatUsers cache, then connections
      if (state.chatUsers && state.chatUsers[otherId]) {
        return state.chatUsers[otherId];
      }
      return state.connections.find(c => c.id === otherId);
    }

    // PARTIAL UPDATE FUNCTIONS - Don't re-render everything!
    
    function updateSidebar() {
      const tabContent = document.getElementById('tab-content');
      if (tabContent) {
        tabContent.innerHTML = renderTabContent();
        attachTabContentListeners();
      }
      updateTabBadges();
    }

    function openRequestsDrawer() {
      const drawer = document.getElementById('requests-drawer');
      if (!drawer) return;
      drawer.classList.remove('hidden');
      updateRequestsDrawer();
    }

    function updateRequestsDrawer() {
      const content = document.getElementById('requests-drawer-content');
      if (content) {
        content.innerHTML = renderRequestsTab();
        attachRequestsDrawerListeners();
      }
      // Update header badge
      const badge = document.getElementById('requests-drawer-badge-header');
      if (badge) {
        const count = state.receivedRequests.length;
        badge.textContent = count + ' pending';
        badge.classList.toggle('hidden', count === 0);
      }
      // Update icon badge
      const iconBadge = document.getElementById('requests-drawer-badge');
      if (iconBadge) {
        const count = state.receivedRequests.length;
        iconBadge.textContent = count;
        iconBadge.classList.toggle('hidden', count === 0);
      }
    }

    function attachRequestsDrawerListeners() {
      const content = document.getElementById('requests-drawer-content');
      if (!content) return;

      // Remove any previous delegated listener by replacing the node
      const fresh = content.cloneNode(true);
      content.parentNode.replaceChild(fresh, content);
      const c = document.getElementById('requests-drawer-content');

      // Single delegated click handler â€” catches all buttons even after re-render
      c.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-subtab], button.accept-request, button.decline-request, button.open-request-modal, button#find-people-requests-btn');
        if (!btn) return;

        // â”€â”€ Sub-tab switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (btn.dataset.subtab) {
          state.requestsSubTab = btn.dataset.subtab;
          updateRequestsDrawer();
          return;
        }

        // â”€â”€ Accept â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (btn.classList.contains('accept-request')) {
          btn.disabled = true;
          btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> Acceptingâ€¦';
          try {
            await acceptRequest(btn.dataset.id);
          } catch(err) {
            btn.disabled = false;
            btn.textContent = 'Accept';
          }
          return;
        }

        // â”€â”€ Decline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (btn.classList.contains('decline-request')) {
          btn.disabled = true;
          btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> Decliningâ€¦';
          try {
            await declineRequest(btn.dataset.id);
          } catch(err) {
            btn.disabled = false;
            btn.textContent = 'Decline';
          }
          return;
        }

        // â”€â”€ Send request modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (btn.classList.contains('open-request-modal')) {
          state.selectedRequestUser = {
            id: btn.dataset.userId,
            name: btn.dataset.userName,
            avatar: btn.dataset.userAvatar
          };
          state.selectedRequestType = null;
          state.showRequestModal = true;
          document.getElementById('request-modal')?.classList.remove('hidden');
          updateRequestModal();
          return;
        }

        // â”€â”€ Find people â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (btn.id === 'find-people-requests-btn') {
          state.showUserSearch = true;
          state.searchResults = [];
          document.getElementById('user-search-modal')?.classList.remove('hidden');
          setTimeout(() => document.getElementById('search-users-input')?.focus(), 100);
        }
      });
    }

    function updateChatRequestBadge() {
      const badge = document.getElementById('chat-request-badge');
      if (badge) {
        const count = state.receivedRequests.length;
        badge.textContent = count > 9 ? '9+' : count;
        badge.classList.toggle('hidden', count === 0);
      }
    }
    
    function updateTabBadges() {
      const circleBadge = document.getElementById('circle-badge');
      const slidesBadge = document.getElementById('slides-badge');
      const headerInvitesBadge = document.getElementById('header-invites-badge');
      
      log('Updating badges - Connections: ' + state.connections.length + ', Received Invites: ' + state.receivedInvites.length + ', Received Requests: ' + state.receivedRequests.length);
      
      // Circle badge - shows number of accepted connections
      if (circleBadge) {
        circleBadge.textContent = state.connections.length || '';
        circleBadge.classList.toggle('hidden', state.connections.length === 0);
      }
      
      // Slides badge - shows number of recent slides from connections
      if (slidesBadge) {
        const now = Date.now();
        const twentyFourHours = 24 * 60 * 60 * 1000;
        const connectionIds = state.connections.map(c => c.id);
        
        const recentConnectionSlides = (state.slides || []).filter(s => {
          const slideTime = s.createdAt?.toDate?.() || new Date(s.createdAt);
          return connectionIds.includes(s.userId) && (now - slideTime.getTime()) < twentyFourHours;
        });
        
        // Count unique users with slides
        const uniqueUsers = [...new Set(recentConnectionSlides.map(s => s.userId))];
        slidesBadge.textContent = uniqueUsers.length || '';
        slidesBadge.classList.toggle('hidden', uniqueUsers.length === 0);
      }
      
      // Header invites badge - shows received connection invites
      if (headerInvitesBadge) {
        headerInvitesBadge.textContent = state.receivedInvites.length || '';
        headerInvitesBadge.classList.toggle('hidden', state.receivedInvites.length === 0);
      }
      
      // Update invites panel if open
      updateInvitesPanel();
    }

    function updateMessages() {
      const msgContainer = document.getElementById('message-list');
      if (msgContainer) {
        msgContainer.innerHTML = renderMessageList();
        msgContainer.scrollTop = msgContainer.scrollHeight;
      }
    }

    function renderSearchResults() {
      const resultsContainer = document.getElementById('search-results');
      if (resultsContainer) {
        resultsContainer.innerHTML = state.searchResults.length === 0 
          ? '<div class="text-center text-gray-500 py-8">Search for users by name, email, or location</div>'
          : state.searchResults.map(user => {
              const status = getInviteStatus(user.id);
              return `
                <div class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 transition-colors ${user.sameLocation ? 'bg-gray-100 border border-gray-200' : ''}">
                  <div class="flex items-center gap-3">
                    <div class="relative">
                      <img src="${user.avatar || `https://ui-avatars.com/api/?name=${user.name}&background=333&color=fff`}" alt="${user.name}" class="w-12 h-12 rounded-full object-cover">
                      ${user.sameLocation ? '<div class="absolute -bottom-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center"><svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /></svg></div>' : ''}
                    </div>
                    <div>
                      <h3 class="text-black font-medium">${user.name}</h3>
                      ${user.location ? `
                        <p class="text-gray-600 text-xs flex items-center gap-1">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /></svg>
                          ${user.location}
                          ${user.sameLocation ? '<span class="text-green-600 ml-1 font-medium">â€¢ Near you</span>' : ''}
                        </p>
                      ` : `<p class="text-gray-500 text-sm">${user.email}</p>`}
                      ${user.bio ? `<p class="text-gray-500 text-xs mt-0.5 line-clamp-1">${user.bio}</p>` : ''}
                    </div>
                  </div>
                  ${status === 'connected' 
                    ? '<span class="px-3 py-1 bg-gray-200 text-black rounded-full text-sm">Connected</span>'
                    : status === 'pending'
                    ? '<span class="px-3 py-1 bg-gray-200 text-gray-600 rounded-full text-sm">Pending</span>'
                    : `<button class="send-invite-btn px-4 py-2 bg-black text-white rounded-lg text-sm font-medium hover:bg-gray-800 transition-colors" data-user-id="${user.id}">Invite</button>`
                  }
                </div>
              `;
            }).join('');
        attachSearchResultListeners();
      }
    }

    // FULL RENDER - Only for major state changes (login/logout)
    
    function renderFull() {
      const root = document.getElementById('root');
      
      if (state.loading) {
        root.innerHTML = `
          <div class="h-screen bg-black flex items-center justify-center">
            <div class="text-center">
              <svg class="animate-spin h-12 w-12 text-white mx-auto mb-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <p class="text-white text-lg">Loading Linq...</p>
            </div>
          </div>
        `;
        return;
      }

      if (!state.user) {
        renderAuth();
        return;
      }

      // Main app
      renderApp();
      setupListeners();
      listenForIncomingCalls();
    }

    function renderAuth() {
      const root = document.getElementById('root');
      
      if (state.authView === 'login') {
        root.innerHTML = `
          <div class="min-h-screen bg-black flex items-center justify-center p-4">
            <div class="w-full max-w-md">
              <div class="text-center mb-8">
                <div class="mb-2"></div>
                <h1 class="text-4xl font-bold text-white tracking-tight">Linq</h1>
                <p class="text-gray-500 mt-2">Connect â€¢ Request â€¢ Link Up</p>
              </div>

              <form id="login-form" class="space-y-4">
                <div id="error-box" class="hidden bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-sm"></div>
                
                <div>
                  <label class="block text-gray-400 text-sm mb-2">Email</label>
                  <input type="email" id="login-email" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-black placeholder-gray-400 focus:outline-none focus:border-gray-400 transition-colors" placeholder="Enter your email" required>
                </div>

                <div>
                  <label class="block text-gray-400 text-sm mb-2">Password</label>
                  <input type="password" id="login-password" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-black placeholder-gray-400 focus:outline-none focus:border-gray-400 transition-colors" placeholder="Enter your password" required>
                </div>

                <button type="submit" id="login-btn" class="w-full bg-white text-black font-semibold py-3 rounded-lg hover:bg-gray-200 transition-colors disabled:opacity-50">
                  Sign In
                </button>
              </form>

              <p class="text-center text-gray-400 mt-6">
                Don't have an account? 
                <button id="switch-to-register" class="text-white hover:underline font-medium ml-1">Sign up</button>
              </p>

              <div class="mt-8 pt-4 border-t border-gray-800">
                <button id="toggle-debug" class="text-gray-600 text-xs hover:text-gray-400">Show Debug Info</button>
                <pre id="debug-content" class="hidden mt-2 text-xs text-gray-500 bg-gray-100 p-2 rounded max-h-40 overflow-auto"></pre>
              </div>
            </div>
          </div>
        `;
        
        document.getElementById('login-form').onsubmit = async (e) => {
          e.preventDefault();
          const btn = document.getElementById('login-btn');
          const errorBox = document.getElementById('error-box');
          btn.disabled = true;
          btn.innerHTML = '<span class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-black" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Signing in...</span>';
          
          try {
            await loginWithEmail(
              document.getElementById('login-email').value,
              document.getElementById('login-password').value
            );
            listenersSetup = false;
            renderFull();
          } catch (err) {
            log('Login error: ' + err.message);
            errorBox.textContent = err.message.replace(/_/g, ' ').toLowerCase();
            errorBox.classList.remove('hidden');
            btn.disabled = false;
            btn.textContent = 'Sign In';
          }
        };
        
        document.getElementById('switch-to-register').onclick = () => {
          state.authView = 'register';
          renderFull();
        };
        
        document.getElementById('toggle-debug').onclick = () => {
          const content = document.getElementById('debug-content');
          content.classList.toggle('hidden');
          content.textContent = debugLogs.slice(-20).join('\n');
        };
      } else {
        root.innerHTML = `
          <div class="min-h-screen bg-black flex items-center justify-center p-4">
            <div class="w-full max-w-md">
              <div class="text-center mb-8">
                <div class="mb-2"></div>
                <h1 class="text-3xl font-bold text-white tracking-tight">Linq</h1>
                <p class="text-gray-500 mt-2">Create your account</p>
              </div>

              <form id="register-form" class="space-y-4">
                <div id="error-box" class="hidden bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-sm"></div>
                
                <div>
                  <label class="block text-gray-400 text-sm mb-2">Full Name</label>
                  <input type="text" id="register-name" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-black placeholder-gray-400 focus:outline-none focus:border-gray-400 transition-colors" placeholder="Enter your full name" required>
                </div>

                <div>
                  <label class="block text-gray-400 text-sm mb-2">Email</label>
                  <input type="email" id="register-email" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-black placeholder-gray-400 focus:outline-none focus:border-gray-400 transition-colors" placeholder="Enter your email" required>
                </div>

                <div>
                  <label class="block text-gray-400 text-sm mb-2">Password</label>
                  <input type="password" id="register-password" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-black placeholder-gray-400 focus:outline-none focus:border-gray-400 transition-colors" placeholder="Create a password (min 6 chars)" required>
                </div>

                <div>
                  <label class="block text-gray-400 text-sm mb-2">Confirm Password</label>
                  <input type="password" id="register-confirm" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-black placeholder-gray-400 focus:outline-none focus:border-gray-400 transition-colors" placeholder="Confirm your password" required>
                </div>

                <div>
                  <label class="block text-gray-400 text-sm mb-2">Location</label>
                  <input type="text" id="register-location" class="w-full bg-white border border-gray-300 rounded-lg px-4 py-3 text-black placeholder-gray-400 focus:outline-none focus:border-gray-400 transition-colors" placeholder="e.g. Protea Glen 1, Soweto" required>
                </div>

                <button type="submit" id="register-btn" class="w-full bg-white text-black font-semibold py-3 rounded-lg hover:bg-gray-200 transition-colors disabled:opacity-50">
                  Create Account
                </button>
              </form>

              <p class="text-center text-gray-400 mt-6">
                Already have an account? 
                <button id="switch-to-login" class="text-white hover:underline font-medium ml-1">Sign in</button>
              </p>

              <div class="mt-8 pt-4 border-t border-gray-800">
                <button id="toggle-debug" class="text-gray-600 text-xs hover:text-gray-400">Show Debug Info</button>
                <pre id="debug-content" class="hidden mt-2 text-xs text-gray-500 bg-gray-100 p-2 rounded max-h-40 overflow-auto"></pre>
              </div>
            </div>
          </div>
        `;
        
        document.getElementById('register-form').onsubmit = async (e) => {
          e.preventDefault();
          const btn = document.getElementById('register-btn');
          const errorBox = document.getElementById('error-box');
          const password = document.getElementById('register-password').value;
          const confirm = document.getElementById('register-confirm').value;
          
          if (password !== confirm) {
            errorBox.textContent = 'Passwords do not match';
            errorBox.classList.remove('hidden');
            return;
          }
          if (password.length < 6) {
            errorBox.textContent = 'Password must be at least 6 characters';
            errorBox.classList.remove('hidden');
            return;
          }
          
          btn.disabled = true;
          btn.innerHTML = '<span class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-black" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Creating account...</span>';
          
          try {
            await registerWithEmail(
              document.getElementById('register-email').value,
              password,
              document.getElementById('register-name').value,
              document.getElementById('register-location').value,
              ''
            );
            listenersSetup = false;
            renderFull();
          } catch (err) {
            log('Register error: ' + err.message);
            errorBox.textContent = err.message.replace(/_/g, ' ').toLowerCase();
            errorBox.classList.remove('hidden');
            btn.disabled = false;
            btn.textContent = 'Create Account';
          }
        };
        
        document.getElementById('switch-to-login').onclick = () => {
          state.authView = 'login';
          renderFull();
        };
        
        document.getElementById('toggle-debug').onclick = () => {
          const content = document.getElementById('debug-content');
          content.classList.toggle('hidden');
          content.textContent = debugLogs.slice(-20).join('\n');
        };
      }
    }

    function renderApp() {
      const root = document.getElementById('root');
      const selectedChat = state.chats.find(c => c.id === state.selectedChatId);
      const otherUser = selectedChat ? getOtherUser(selectedChat) : null;
      
      root.innerHTML = `
        <div class="h-screen bg-black flex overflow-hidden">
          <!-- Sidebar -->
          <div id="sidebar" class="${state.showMobileChat ? 'hidden md:flex' : 'flex'} flex-col w-full md:w-80 lg:w-96 bg-black border-r border-gray-800 flex-shrink-0 sidebar-mobile">
            
            <!-- Header -->
            <div class="p-4 border-b border-gray-800">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                  <!-- Logo removed - just text -->
                  <h1 class="text-2xl font-bold text-white">Linq</h1>
                </div>
                <div class="flex items-center gap-2">
                  <button id="open-search" class="header-icon w-10 h-10 rounded-full bg-black border border-gray-700 flex items-center justify-center text-white hover:bg-gray-800 hover:border-white shadow-lg" title="Find people">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                    </svg>
                  </button>
                  <!-- Requests Icon -->
                  <div class="relative">
                    <button id="open-requests-drawer" class="header-icon w-10 h-10 rounded-full bg-black border border-gray-700 flex items-center justify-center text-white hover:bg-gray-800 hover:border-white shadow-lg relative" title="My Requests">
                      <!-- Inbox tray icon â€” clear "requests" metaphor -->
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 4H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-2m-4-1v8m0 0l-3-3m3 3l3-3"/>
                      </svg>
                      <span id="requests-drawer-badge" class="absolute -top-1 -right-1 bg-white text-black text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center ${state.receivedRequests.length === 0 ? 'hidden' : ''}">${state.receivedRequests.length}</span>
                    </button>
                  </div>
                  <div class="relative">
                    <button id="open-invites-panel" class="header-icon w-10 h-10 rounded-full bg-black border border-gray-700 flex items-center justify-center text-white hover:bg-gray-800 hover:border-white shadow-lg relative" title="Connection Requests">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                      </svg>
                      <span id="header-invites-badge" class="absolute -top-1 -right-1 bg-white text-black text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center ${state.receivedInvites.length === 0 ? 'hidden' : ''}">${state.receivedInvites.length}</span>
                    </button>
                    <!-- Connection Invites Dropdown -->
                    <div id="invites-panel" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-xl border border-gray-200 z-50 max-h-[480px] overflow-y-auto">
                      <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                        <h3 class="text-black font-semibold">Connection Requests</h3>
                        <button id="close-invites-panel-btn" class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200 transition-colors">
                          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                      </div>
                      <div id="invites-panel-content">
                        ${renderInvitesPanel()}
                      </div>
                    </div>
                  </div>
                  <div class="relative">
                    <button id="profile-btn" class="header-icon w-10 h-10 rounded-full bg-black border border-gray-700 flex items-center justify-center overflow-hidden hover:border-white shadow-lg">
                      ${state.userData?.avatar 
                        ? `<img src="${state.userData.avatar}" alt="${state.userData.name}" class="w-full h-full object-cover" />`
                        : `<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`
                      }
                    </button>
                    <div id="profile-menu" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-xl shadow-xl border border-gray-200 py-2 z-50">
                      <div class="px-4 py-3 border-b border-gray-200">
                        <div class="flex items-center gap-3">
                          <div class="relative">
                            <img src="${state.userData?.avatar || `https://ui-avatars.com/api/?name=${state.userData?.name || 'U'}&background=333&color=fff`}" alt="Profile" class="w-12 h-12 rounded-full object-cover">
                          </div>
                          <div class="flex-1 min-w-0">
                            <p class="text-black font-medium truncate">${state.userData?.name || ''}</p>
                            <p class="text-gray-600 text-sm truncate">${state.userData?.email || ''}</p>
                          </div>
                        </div>
                        ${state.userData?.location ? `
                          <div class="flex items-center gap-2 mt-2 text-gray-600 text-sm">
                            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <span class="truncate">${state.userData.location}</span>
                          </div>
                        ` : ''}
                        ${state.userData?.bio ? `
                          <p class="text-gray-600 text-sm mt-2 line-clamp-2">${state.userData.bio}</p>
                        ` : ''}
                      </div>
                      <label class="flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors cursor-pointer">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span>Change Photo</span>
                        <input type="file" id="profile-photo-input" accept="image/*" class="hidden">
                      </label>
                      <button id="edit-profile-btn" class="w-full flex items-center gap-3 px-4 py-2 text-left text-gray-700 hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        <span>Edit Profile</span>
                      </button>
                      <button id="logout-btn" class="w-full flex items-center gap-3 px-4 py-2 text-left text-gray-700 hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        <span>Sign out</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Search -->
              <div class="relative">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 transition-colors search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="search-connections" placeholder="Search..." class="w-full bg-white text-black placeholder-gray-500 rounded-lg pl-10 pr-8 py-2.5 focus:outline-none focus:ring-2 focus:ring-white focus:shadow-[0_0_15px_rgba(255,255,255,0.3)] transition-all duration-200">
                <button id="clear-search" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-gray-800">
              <button class="tab-btn flex-1 py-3 text-sm font-medium transition-colors relative ${state.activeTab === 'circle' ? 'text-white' : 'text-gray-500 hover:text-gray-300'}" data-tab="circle">
                Circle
                <span id="circle-badge" class="ml-1 px-2 py-0.5 text-xs rounded-full bg-gray-700 text-gray-300 ${state.connections.length === 0 ? 'hidden' : ''}">${state.connections.length}</span>
                ${state.activeTab === 'circle' ? '<div class="absolute bottom-0 left-0 right-0 h-0.5 bg-white"></div>' : ''}
              </button>
              <button class="tab-btn flex-1 py-3 text-sm font-medium transition-colors relative ${state.activeTab === 'slides' ? 'text-white' : 'text-gray-500 hover:text-gray-300'}" data-tab="slides">
                Updates
                <span id="slides-badge" class="ml-1 px-2 py-0.5 text-xs rounded-full bg-gray-700 text-gray-300 ${state.sentInvites.filter(i => i.status === 'pending').length === 0 ? 'hidden' : ''}">${state.sentInvites.filter(i => i.status === 'pending').length}</span>
                ${state.activeTab === 'slides' ? '<div class="absolute bottom-0 left-0 right-0 h-0.5 bg-white"></div>' : ''}
              </button>
            </div>

            <!-- Tab Content -->
            <div id="tab-content" class="flex-1 overflow-y-auto">
              ${renderTabContent()}
            </div>
          </div>

          <!-- Chat View -->
          <div id="chat-view" class="flex-1 ${!state.showMobileChat ? 'hidden md:flex' : 'flex'} flex-col bg-black chat-screen">
            ${selectedChat ? renderChatView(selectedChat, otherUser) : renderEmptyChatView()}
          </div>
        </div>

        <!-- User Search Modal -->
        <div id="user-search-modal" class="${state.showUserSearch ? '' : 'hidden'} fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-2xl w-full max-w-md max-h-[80vh] overflow-hidden shadow-2xl">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
              <h2 class="text-xl font-semibold text-black">Find People</h2>
              <button id="close-search" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:text-black hover:bg-gray-200 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            <form id="search-users-form" class="p-4 bg-white">
              <div class="flex gap-2">
                <input type="text" id="search-users-input" placeholder="Search by name or email..." class="blue-glow-input flex-1 bg-gray-100 border border-gray-300 rounded-lg px-4 py-2 text-black placeholder-gray-500 focus:outline-none transition-colors">
                <button type="submit" class="px-4 py-2 bg-black text-white rounded-lg font-medium hover:bg-gray-800 transition-colors">Search</button>
              </div>
            </form>

            <div id="search-results" class="overflow-y-auto max-h-96 px-4 pb-4 bg-white">
              <div class="text-center text-gray-500 py-8">Search for users by name or email</div>
            </div>
          </div>
        </div>

        <!-- â•â•â• CREATE POST MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="create-post-modal" class="hidden fixed inset-0 bg-black z-[65] flex flex-col">
          <!-- Header -->
          <div class="flex items-center justify-between px-4 py-3 border-b border-gray-800 bg-black flex-shrink-0">
            <button id="cpm-cancel" class="text-gray-400 hover:text-white text-sm font-medium px-1 py-1 transition-colors">Cancel</button>
            <span class="text-white font-bold">New Post</span>
            <button id="cpm-post" class="px-4 py-1.5 bg-white text-black text-sm font-bold rounded-full hover:bg-gray-200 active:scale-95 transition-all disabled:opacity-40 disabled:pointer-events-none">Post</button>
          </div>
          <!-- Author + visibility -->
          <div class="flex items-center gap-3 px-4 py-3 border-b border-gray-800 bg-black flex-shrink-0">
            <div class="w-10 h-10 rounded-full overflow-hidden bg-gray-800 flex-shrink-0 border border-gray-700">
              <img id="cpm-avatar" src="" class="w-full h-full object-cover hidden"/>
              <div id="cpm-initial" class="w-full h-full flex items-center justify-center text-white font-bold text-sm hidden"></div>
            </div>
            <div>
              <p id="cpm-name" class="text-white font-semibold text-sm"></p>
              <div class="flex items-center gap-1.5 mt-1">
                <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="cpm-vis-icon">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"/>
                </svg>
                <select id="cpm-visibility" class="text-xs bg-transparent text-white border-0 focus:outline-none cursor-pointer appearance-none font-medium">
                  <option value="public">Public Â· Everyone on Linq</option>
                  <option value="circle">Circle Only Â· My connections</option>
                </select>
                <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </div>
            </div>
          </div>
          <!-- Visibility-OFF warning -->
          <div id="cpm-vis-warning" class="hidden mx-4 mt-3 bg-amber-950 border border-amber-800 rounded-xl p-2.5">
            <p class="text-amber-300 text-xs">Your Updates visibility is OFF â€” this will be saved as Circle Only regardless.</p>
          </div>
          <!-- Text area -->
          <div class="flex-1 overflow-y-auto px-4 pt-3 pb-4">
            <textarea id="cpm-content" placeholder="What's on your mind?" maxlength="500"
              class="w-full min-h-[120px] bg-transparent text-white text-[16px] placeholder-gray-600 resize-none focus:outline-none leading-relaxed"></textarea>
            <!-- Image preview -->
            <div id="cpm-img-wrap" class="hidden relative rounded-xl overflow-hidden border border-gray-800 mt-2">
              <img id="cpm-img-preview" src="" alt="" class="w-full max-h-60 object-cover bg-gray-100"/>
              <video id="cpm-vid-preview" class="w-full max-h-60 bg-black hidden" controls playsinline></video>
              <button id="cpm-img-remove" class="absolute top-2 right-2 w-8 h-8 bg-black/70 backdrop-blur rounded-full flex items-center justify-center text-white hover:bg-black transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>
          <!-- Toolbar -->
          <div class="flex-shrink-0 border-t border-gray-800 bg-black px-4 py-3 flex items-center justify-between">
            <label class="cursor-pointer p-2 text-gray-500 hover:text-black rounded-full hover:bg-gray-100 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              <input type="file" id="cpm-img-input" accept="image/*,video/*" class="hidden">
            </label>
            <span id="cpm-char" class="text-gray-600 text-xs font-medium">0 / 500</span>
          </div>
        </div>

        <!-- â•â•â• POST BOTTOM SHEET (three-dot menu) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="post-sheet" class="hidden fixed inset-0 z-[70]">
          <div class="absolute inset-0 bg-black/60" id="post-sheet-overlay"></div>
          <div class="absolute bottom-0 left-0 right-0 bg-gray-950 rounded-t-2xl border-t border-gray-800 pb-safe">
            <div class="w-10 h-1 bg-gray-700 rounded-full mx-auto mt-3 mb-2"></div>
            <p id="post-sheet-label" class="text-gray-500 text-xs text-center uppercase tracking-widest mb-2 pb-2 border-b border-gray-800 mx-4"></p>
            <div id="post-sheet-actions" class="py-2 px-2"></div>
          </div>
        </div>

        <!-- Requests Drawer (Full Screen) -->
        <div id="requests-drawer" class="hidden fixed inset-0 z-[60] flex flex-col bg-white">
          <!-- Drawer Header -->
          <div class="flex items-center justify-between px-4 py-3 bg-black border-b border-gray-800 flex-shrink-0">
            <div class="flex items-center gap-3">
              <button id="close-requests-drawer" class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 flex items-center justify-center text-black hover:bg-gray-200 active:scale-95 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
              </button>
              <div>
                <h2 class="text-white font-bold text-lg leading-tight">My Requests</h2>
                <p class="text-gray-500 text-xs">Hangouts, dates & plans</p>
              </div>
            </div>
            <span id="requests-drawer-badge-header" class="px-2.5 py-1 bg-white text-black text-xs font-bold rounded-full ${state.receivedRequests.length === 0 ? 'hidden' : ''}">${state.receivedRequests.length} new</span>
          </div>
          <!-- Drawer Content (mirrors Requests tab exactly) -->
          <div id="requests-drawer-content" class="flex-1 overflow-y-auto bg-white">
            ${renderRequestsTab()}
          </div>
        </div>

        <!-- Request Modal -->
        <div id="request-modal" class="${state.showRequestModal ? '' : 'hidden'} fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
          <div id="request-modal-content" class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col shadow-2xl border border-gray-200">
            ${renderRequestModal()}
          </div>
        </div>

        <!-- Slide Modal (Create New Slide) -->
        <div id="slide-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
              <h2 class="text-xl font-semibold text-black">Create Slide</h2>
              <button id="close-slide-modal" class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center text-gray-400 hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            <div class="p-4">
              <p class="text-gray-500 text-sm mb-4">Share an update with your circle (disappears after 24 hours)</p>
              
              <!-- Image Upload Section -->
              <div id="slide-image-section" class="mb-4">
                <div id="slide-image-preview" class="hidden relative rounded-lg overflow-hidden mb-3">
                  <img id="slide-preview-img" src="" alt="Preview" class="w-full h-48 object-cover">
                  <button id="remove-slide-image" class="absolute top-2 right-2 w-8 h-8 bg-black/70 rounded-full flex items-center justify-center text-white hover:bg-black transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
                <label id="slide-image-upload-btn" class="flex items-center justify-center gap-2 w-full py-3 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-gray-400 transition-colors">
                  <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span class="text-gray-400">Add Photo</span>
                  <input type="file" id="slide-image-input" accept="image/*" class="hidden">
                </label>
              </div>
              
              <textarea id="slide-content" placeholder="Add a caption (optional)" class="w-full bg-gray-100 border border-gray-200 rounded-lg px-4 py-3 text-black placeholder-gray-400 focus:outline-none focus:border-gray-400 transition-colors resize-none h-24" maxlength="280"></textarea>
              <div class="flex justify-between items-center mt-2">
                <span id="slide-char-count" class="text-gray-400 text-xs">0/280</span>
              </div>
            </div>
            <div class="p-4 border-t border-gray-200 flex gap-3">
              <button id="cancel-slide" class="flex-1 py-3 rounded-lg bg-gray-100 text-black font-medium hover:bg-gray-200 transition-colors">Cancel</button>
              <button id="post-slide" class="flex-1 py-3 rounded-lg bg-white text-black font-medium hover:bg-gray-200 transition-colors">Post Slide</button>
            </div>
          </div>
        </div>

        <!-- Slide Viewer -->
        <div id="slide-viewer" class="hidden fixed inset-0 bg-black z-50 flex flex-col">
          <div id="slide-viewer-content"></div>
        </div>

        <!-- Edit Profile Modal -->
        <div id="edit-profile-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
              <h2 class="text-xl font-semibold text-black">Edit Profile</h2>
              <button id="close-edit-profile" class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center text-gray-400 hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            <div class="p-4 space-y-4">
              <div>
                <label class="block text-gray-500 text-sm mb-2">Display Name</label>
                <input type="text" id="edit-name" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-black focus:outline-none focus:border-gray-400 transition-all" placeholder="Your name" value="${state.userData?.name || ''}">
              </div>
              <div>
                <label class="block text-gray-400 text-sm mb-2">
                  <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Location
                  </span>
                </label>
                <input type="text" id="edit-location" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-black focus:outline-none focus:border-gray-400 transition-all" placeholder="e.g. Protea Glen 1, Soweto" value="${state.userData?.location || ''}">
                <p class="text-gray-600 text-xs mt-1">Helps suggest connections in your area</p>
              </div>
              <div>
                <label class="block text-gray-400 text-sm mb-2">Short Description</label>
                <textarea id="edit-bio" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-black focus:outline-none focus:border-gray-400 transition-all resize-none h-24" placeholder="Tell others about yourself..." maxlength="150">${state.userData?.bio || ''}</textarea>
                <p class="text-gray-600 text-xs mt-1"><span id="bio-char-count">${(state.userData?.bio || '').length}</span>/150 characters</p>
              </div>
            </div>
              <!-- Updates Visibility Setting -->
              <div class="border-t border-gray-800 pt-4">
                <div class="flex items-center justify-between gap-3">
                  <div>
                    <p class="text-white text-sm font-semibold">Updates Visibility</p>
                    <p class="text-gray-500 text-xs mt-0.5">Allow your public posts to appear in the Updates feed for all Linq users</p>
                  </div>
                  <button id="updates-vis-toggle" onclick="saveUpdatesVisibility(!state.updatesVisibility)"
                    class="relative w-12 h-6 rounded-full flex-shrink-0 transition-colors ${state.updatesVisibility ? 'bg-white' : 'bg-gray-700'}">
                    <span class="absolute top-0.5 w-5 h-5 rounded-full bg-black shadow transition-all ${state.updatesVisibility ? 'left-6' : 'left-0.5'}"></span>
                  </button>
                </div>
              </div>
            </div>
            <div class="p-4 border-t border-gray-800 flex gap-3">
              <button id="cancel-edit-profile" class="flex-1 py-3 rounded-lg bg-gray-800 text-white font-medium hover:bg-gray-700 transition-colors">Cancel</button>
              <button id="save-profile" class="flex-1 py-3 rounded-lg bg-white text-black font-medium hover:bg-gray-200 transition-colors">Save Changes</button>
            </div>
          </div>
        </div>
      `;

      attachAppEventListeners();
    }



    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CONTACT PROFILE  â€”  WhatsApp-style full-screen profile view
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openContactProfile(user) {
      if (!user) return;
      const isBlocked = localStorage.getItem('blocked_' + user.id) === 'true';
      const isOnline  = user.isOnline;

      // Shared media: images from this chat
      const chatMessages = state.messages || [];
      const sharedImages = chatMessages.filter(m => m.imageUrl || (m.type === 'image' && m.mediaBase64));
      const sharedDocs   = chatMessages.filter(m => m.type === 'document' || m.type === 'audio');

      // Build shared media grid (up to 6 thumbnails)
      const mediaGrid = sharedImages.slice(0, 6).map(m => {
        const src = m.imageUrl || ('data:' + (m.mediaType || 'image/jpeg') + ';base64,' + (m.mediaBase64 || ''));
        return `<div class="aspect-square rounded-lg overflow-hidden bg-gray-100 cursor-pointer">
                  <img src="${src}" class="w-full h-full object-cover"/>
                </div>`;
      }).join('');

      const html = `
        <div id="contact-profile-screen" class="fixed inset-0 z-[80] flex flex-col bg-white"
             style="animation:slideUpProfile .25s cubic-bezier(.4,0,.2,1)">

          <!-- â”€â”€ Header (white) â”€â”€ -->
          <div class="flex items-center gap-3 px-4 py-3 flex-shrink-0 bg-white border-b border-gray-200">
            <button id="cp-back" class="p-2 -ml-2 text-gray-800 hover:text-black transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
            </button>
            <h2 class="text-black font-semibold text-lg flex-1">Contact info</h2>
          </div>

          <!-- â”€â”€ Scrollable body â”€â”€ -->
          <div class="flex-1 overflow-y-auto bg-white" style="-webkit-overflow-scrolling:touch;scrollbar-width:none;">

            <!-- Avatar + name hero â€” white bg -->
            <div class="flex flex-col items-center px-6 pt-10 pb-6 bg-white">
              <div class="relative mb-5 cursor-pointer active:opacity-80 transition-opacity" id="cp-avatar-tap">
                <!-- Large avatar â€” tap to full-screen -->
                <div class="w-44 h-44 rounded-full overflow-hidden border-4 border-gray-100 shadow-xl active:scale-95 transition-transform">
                  <img src="${user.avatar || `https://ui-avatars.com/api/?name=${user.name}&background=eeeeee&color=333&size=400`}"
                       alt="${user.name}"
                       class="w-full h-full object-cover">
                </div>
                ${isOnline ? `<div class="absolute bottom-3 right-3 w-5 h-5 bg-green-500 rounded-full border-[3px] border-white shadow-lg"></div>` : ''}
              </div>
              <h1 class="text-black text-2xl font-bold mb-1">${user.name}</h1>
              <p class="text-sm ${isOnline ? 'text-green-500' : 'text-gray-400'} font-medium">
                ${isOnline ? 'â— Online' : (user.lastSeen ? 'Last seen ' + formatLastSeen(user.lastSeen, false) : 'Offline')}
              </p>
            </div>

            <!-- Quick action buttons â€” white bg -->
            <div class="flex justify-center gap-6 px-6 py-5 bg-white border-t border-gray-100">
              <button id="cp-message" class="flex flex-col items-center gap-1.5 group">
                <div class="w-13 h-13 w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-gray-200 group-active:scale-95 transition-all">
                  <svg class="w-5 h-5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                </div>
                <span class="text-xs text-gray-500 font-medium">Message</span>
              </button>
              <button id="cp-voice" class="flex flex-col items-center gap-1.5 group">
                <div class="w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-gray-200 group-active:scale-95 transition-all">
                  <svg class="w-5 h-5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                </div>
                <span class="text-xs text-gray-500 font-medium">Call</span>
              </button>
              <button id="cp-video" class="flex flex-col items-center gap-1.5 group">
                <div class="w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-gray-200 group-active:scale-95 transition-all">
                  <svg class="w-5 h-5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                </div>
                <span class="text-xs text-gray-500 font-medium">Video</span>
              </button>
              <button id="cp-request" class="flex flex-col items-center gap-1.5 group">
                <div class="w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-gray-200 group-active:scale-95 transition-all">
                  <svg class="w-5 h-5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                </div>
                <span class="text-xs text-gray-500 font-medium">Request</span>
              </button>
            </div>

            <!-- Bio / About -->
            ${user.bio ? `
            <div class="bg-white border-t border-gray-100 px-4 py-4">
              <p class="text-xs text-gray-400 uppercase tracking-widest mb-1.5 font-semibold">About</p>
              <p class="text-black text-sm leading-relaxed">${user.bio}</p>
            </div>` : ''}

            <!-- Location -->
            ${user.location ? `
            <div class="bg-white border-t border-gray-100 px-4 py-4 flex items-center gap-3">
              <svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              <div>
                <p class="text-xs text-gray-400 uppercase tracking-widest font-semibold mb-0.5">Location</p>
                <p class="text-black text-sm">${user.location}</p>
              </div>
            </div>` : ''}

            <!-- Email -->
            ${user.email ? `
            <div class="bg-white border-t border-gray-100 px-4 py-4 flex items-center gap-3">
              <svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
              <div>
                <p class="text-xs text-gray-400 uppercase tracking-widest font-semibold mb-0.5">Email</p>
                <p class="text-black text-sm">${user.email}</p>
              </div>
            </div>` : ''}

            <!-- Shared media -->
            <div class="bg-white border-t border-gray-100 px-4 py-4">
              <div class="flex items-center justify-between mb-3">
                <p class="text-xs text-gray-400 uppercase tracking-widest font-semibold">Shared media</p>
                <span class="text-xs text-gray-400">${sharedImages.length} photo${sharedImages.length !== 1 ? 's' : ''}</span>
              </div>
              ${sharedImages.length > 0 ? `
              <div class="grid grid-cols-3 gap-1.5">
                ${mediaGrid}
              </div>` : `
              <p class="text-gray-400 text-sm">No shared media yet</p>`}
            </div>

            <!-- Danger zone -->
            <div class="border-t border-gray-100 mt-2">
              <button id="cp-block" class="w-full flex items-center gap-3 px-4 py-4 text-left hover:bg-gray-50 active:bg-gray-100 transition-colors border-b border-gray-100">
                <svg class="w-5 h-5 ${isBlocked ? 'text-gray-500' : 'text-red-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                <span class="text-sm font-medium ${isBlocked ? 'text-gray-500' : 'text-red-500'}">${isBlocked ? 'Unblock' : 'Block'} ${user.name}</span>
              </button>
              <button id="cp-report" class="w-full flex items-center gap-3 px-4 py-4 text-left hover:bg-gray-50 active:bg-gray-100 transition-colors">
                <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                <span class="text-sm font-medium text-red-500">Report ${user.name}</span>
              </button>
            </div>

            <div class="h-8"></div>
          </div>
        </div>
      `;

      // Inject into DOM
      document.body.insertAdjacentHTML('beforeend', html);

      // Wire up buttons
      const screen = document.getElementById('contact-profile-screen');

      const closeProfile = () => {
        screen.style.animation = 'slideDownProfile .2s cubic-bezier(.4,0,.2,1)';
        setTimeout(() => screen.remove(), 200);
      };

      document.getElementById('cp-back').addEventListener('click', closeProfile);

      // Tap avatar â†’ full-screen photo lightbox
      document.getElementById('cp-avatar-tap')?.addEventListener('click', () => {
        const src = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=222&color=fff&size=800`;
        const lightbox = document.createElement('div');
        lightbox.id = 'avatar-lightbox';
        lightbox.className = 'fixed inset-0 z-[100] bg-black flex items-center justify-center';
        lightbox.style.animation = 'fadeIn .2s ease';
        lightbox.innerHTML = `
          <div class="relative w-full h-full flex items-center justify-center p-4">
            <button id="lb-close" class="absolute top-4 left-4 z-10 w-10 h-10 bg-black/60 backdrop-blur rounded-full flex items-center justify-center text-white">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            <img src="${src}" alt="${user.name}" class="max-w-full max-h-full object-contain rounded-xl shadow-2xl" style="max-height:90vh;">
            <p class="absolute bottom-6 left-0 right-0 text-center text-white font-semibold text-lg drop-shadow">${user.name}</p>
          </div>`;
        document.body.appendChild(lightbox);
        document.getElementById('lb-close').addEventListener('click', () => {
          lightbox.style.animation = 'fadeOut .15s ease forwards';
          setTimeout(() => lightbox.remove(), 150);
        });
        lightbox.addEventListener('click', (e) => {
          if (e.target === lightbox || e.target.tagName === 'IMG') {
            lightbox.style.animation = 'fadeOut .15s ease forwards';
            setTimeout(() => lightbox.remove(), 150);
          }
        });
      });

      document.getElementById('cp-message').addEventListener('click', () => {
        closeProfile();
        // Already in the chat â€” just close
      });

      document.getElementById('cp-voice').addEventListener('click', () => {
        closeProfile();
        startCall(user.id, 'voice');
      });

      document.getElementById('cp-video').addEventListener('click', () => {
        closeProfile();
        startCall(user.id, 'video');
      });

      document.getElementById('cp-request').addEventListener('click', () => {
        closeProfile();
        state.selectedRequestUser = { id: user.id, name: user.name, avatar: user.avatar || '' };
        state.selectedRequestType = null;
        state.showRequestModal = true;
        document.getElementById('request-modal')?.classList.remove('hidden');
        updateRequestModal();
      });

      document.getElementById('cp-block').addEventListener('click', async () => {
        closeProfile();
        await toggleBlockUser(user.id, user.name);
      });

      document.getElementById('cp-report').addEventListener('click', () => {
        closeProfile();
        if (confirm('Report ' + user.name + ' for inappropriate behaviour?')) {
          alert('Report submitted. Thank you for helping keep Linq safe.');
        }
      });
    }

    // â”€â”€ CREATE POST MODAL CONTROLLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openCreatePostModal() {
      const modal = document.getElementById('create-post-modal');
      if (!modal) return;
      // Populate user info
      const avatarEl = document.getElementById('cpm-avatar');
      const initialEl = document.getElementById('cpm-initial');
      const nameEl = document.getElementById('cpm-name');
      const visSelect = document.getElementById('cpm-visibility');
      const visWarn = document.getElementById('cpm-vis-warning');
      if (state.userData?.avatar && avatarEl) {
        avatarEl.src = state.userData.avatar;
        avatarEl.classList.remove('hidden');
        initialEl?.classList.add('hidden');
      } else if (initialEl) {
        initialEl.textContent = state.userData?.name?.charAt(0) || 'U';
        initialEl.classList.remove('hidden');
        avatarEl?.classList.add('hidden');
      }
      if (nameEl) nameEl.textContent = state.userData?.name || '';
      // Visibility: if OFF â†’ force circle, disable public option
      if (!state.updatesVisibility) {
        if (visSelect) { visSelect.value = 'circle'; visSelect.disabled = true; }
        visWarn?.classList.remove('hidden');
      } else {
        if (visSelect) { visSelect.value = 'public'; visSelect.disabled = false; }
        visWarn?.classList.add('hidden');
      }
      modal.classList.remove('hidden');
      setTimeout(() => document.getElementById('cpm-content')?.focus(), 100);
      // Wire up listeners (once)
      _attachCreatePostListeners();
    }

    function _attachCreatePostListeners() {
      // Remove old listeners by replacing elements (clone trick for key buttons)
      const cancelBtn = document.getElementById('cpm-cancel');
      const postBtn = document.getElementById('cpm-post');
      if (cancelBtn?._cpm_wired) return; // already wired this session
      if (cancelBtn) { cancelBtn._cpm_wired = true; }

      let _imgFile = null;

      const closeModal = () => {
        document.getElementById('create-post-modal')?.classList.add('hidden');
        const content = document.getElementById('cpm-content');
        if (content) content.value = '';
        document.getElementById('cpm-char')?.['textContent' in document.getElementById('cpm-char') ? 'textContent' : 'innerText'];
        const charEl = document.getElementById('cpm-char');
        if (charEl) charEl.textContent = '0 / 500';
        document.getElementById('cpm-img-wrap')?.classList.add('hidden');
        const imgInput = document.getElementById('cpm-img-input');
        if (imgInput) imgInput.value = '';
        _imgFile = null;
      };

      document.getElementById('cpm-cancel')?.addEventListener('click', closeModal);

      document.getElementById('cpm-content')?.addEventListener('input', (e) => {
        const charEl = document.getElementById('cpm-char');
        if (charEl) charEl.textContent = e.target.value.length + ' / 500';
      });

      document.getElementById('cpm-img-input')?.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const isVid = file.type.startsWith('video/');
        if (!file.type.startsWith('image/') && !isVid) { alert('Please choose an image or video.'); return; }
        if (file.size > 50 * 1024 * 1024) { alert('File must be under 50MB.'); return; }
        _imgFile = file;
        const url = URL.createObjectURL(file);
        const img = document.getElementById('cpm-img-preview');
        const vid = document.getElementById('cpm-vid-preview');
        if (isVid) {
          if (img) img.classList.add('hidden');
          if (vid) { vid.src = url; vid.classList.remove('hidden'); }
        } else {
          if (vid) { vid.src = ''; vid.classList.add('hidden'); }
          if (img) { img.src = url; img.classList.remove('hidden'); }
        }
        document.getElementById('cpm-img-wrap')?.classList.remove('hidden');
      });

      document.getElementById('cpm-img-remove')?.addEventListener('click', () => {
        _imgFile = null;
        document.getElementById('cpm-img-wrap')?.classList.add('hidden');
        const img = document.getElementById('cpm-img-preview');
        const vid = document.getElementById('cpm-vid-preview');
        if (img) img.classList.remove('hidden');
        if (vid) { vid.src = ''; vid.classList.add('hidden'); }
        const input = document.getElementById('cpm-img-input');
        if (input) input.value = '';
      });

      document.getElementById('cpm-post')?.addEventListener('click', async () => {
        const content = (document.getElementById('cpm-content')?.value || '').trim();
        const visibility = document.getElementById('cpm-visibility')?.value || 'circle';
        if (!content && !_imgFile) { alert('Add some text or a photo first.'); return; }
        const btn = document.getElementById('cpm-post');
        btn.disabled = true;
        btn.textContent = 'Posting...';
        try {
          let imageUrl = null;
          let videoUrl = null;
          if (_imgFile) {
            btn.textContent = 'Uploading...';
            if (_imgFile.type.startsWith('video/')) {
              videoUrl = await new Promise((res, rej) => {
                const r = new FileReader();
                r.onload = ev => res(ev.target.result);
                r.onerror = () => rej(new Error('Video read failed'));
                r.readAsDataURL(_imgFile);
              });
            } else {
              imageUrl = await compressImageToBase64(_imgFile, 1920);
            }
          }
          await createPost({ content, imageUrl, videoUrl, visibility });
          // Switch to my_posts tab if circle, or stay on feed if public
          if (visibility === 'circle' || !state.updatesVisibility) {
            state.updatesSubTab = 'my_posts';
          } else {
            state.updatesSubTab = 'feed';
          }
          state.activeTab = 'slides';
          closeModal();
          updateSidebar();
        } catch (err) {
          log('Create post error: ' + err.message);
          alert('Failed to post. Please try again.');
          btn.disabled = false;
          btn.textContent = 'Post';
        }
      });
    }

    function attachAppEventListeners() {
      // Open search modal
      document.getElementById('open-search')?.addEventListener('click', () => {
        state.showUserSearch = true;
        state.searchResults = [];
        document.getElementById('user-search-modal')?.classList.remove('hidden');
        setTimeout(() => document.getElementById('search-users-input')?.focus(), 100);
      });

      // Open requests drawer
      document.getElementById('open-requests-drawer')?.addEventListener('click', (e) => {
        e.stopPropagation();
        openRequestsDrawer();
      });

      // Close requests drawer
      document.getElementById('close-requests-drawer')?.addEventListener('click', () => {
        document.getElementById('requests-drawer')?.classList.add('hidden');
      });

      // Close search modal
      document.getElementById('close-search')?.addEventListener('click', () => {
        state.showUserSearch = false;
        document.getElementById('user-search-modal')?.classList.add('hidden');
      });

      // Open invites panel (dropdown)
      document.getElementById('open-invites-panel')?.addEventListener('click', (e) => {
        e.stopPropagation();
        state.showConnectionInvites = !state.showConnectionInvites;
        const panel = document.getElementById('invites-panel');
        if (panel) {
          panel.classList.toggle('hidden', !state.showConnectionInvites);
          if (state.showConnectionInvites) {
            updateInvitesPanel();
          }
        }
        // Close profile menu if open
        document.getElementById('profile-menu')?.classList.add('hidden');
      });

      // Close invites panel X button
      document.getElementById('close-invites-panel-btn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        state.showConnectionInvites = false;
        document.getElementById('invites-panel')?.classList.add('hidden');
      });

      // Profile menu toggle
      document.getElementById('profile-btn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('profile-menu')?.classList.toggle('hidden');
      });

      // Close profile menu and invites panel when clicking outside
      document.addEventListener('click', () => {
        document.getElementById('profile-menu')?.classList.add('hidden');
        document.getElementById('invites-panel')?.classList.add('hidden');
        state.showConnectionInvites = false;
      });

      // Logout
      document.getElementById('logout-btn')?.addEventListener('click', logout);

      // Edit Profile button
      document.getElementById('edit-profile-btn')?.addEventListener('click', () => {
        document.getElementById('profile-menu')?.classList.add('hidden');
        document.getElementById('edit-profile-modal')?.classList.remove('hidden');
        // Populate current values
        document.getElementById('edit-name').value = state.userData?.name || '';
        document.getElementById('edit-location').value = state.userData?.location || '';
        document.getElementById('edit-bio').value = state.userData?.bio || '';
        document.getElementById('bio-char-count').textContent = (state.userData?.bio || '').length;
      });

      // Close edit profile modal
      document.getElementById('close-edit-profile')?.addEventListener('click', () => {
        document.getElementById('edit-profile-modal')?.classList.add('hidden');
      });
      document.getElementById('cancel-edit-profile')?.addEventListener('click', () => {
        document.getElementById('edit-profile-modal')?.classList.add('hidden');
      });

      // Bio character count
      document.getElementById('edit-bio')?.addEventListener('input', (e) => {
        document.getElementById('bio-char-count').textContent = e.target.value.length;
      });

      // Save profile changes
      document.getElementById('save-profile')?.addEventListener('click', async () => {
        const name = document.getElementById('edit-name')?.value?.trim();
        const location = document.getElementById('edit-location')?.value?.trim();
        const bio = document.getElementById('edit-bio')?.value?.trim();

        if (!name) {
          alert('Name is required');
          return;
        }

        const btn = document.getElementById('save-profile');
        btn.disabled = true;
        btn.textContent = 'Saving...';

        try {
          await updateDoc(doc(db, 'users', state.user.uid), {
            name,
            location: location || '',
            bio: bio || ''
          });

          // Update local state
          state.userData.name = name;
          state.userData.location = location || '';
          state.userData.bio = bio || '';
          localStorage.setItem('linkup_userData', JSON.stringify(state.userData));

          log('Profile updated!');
          document.getElementById('edit-profile-modal')?.classList.add('hidden');
          
          // Refresh the app to show updated profile
          renderFull();
        } catch (err) {
          log('Error updating profile: ' + err.message);
          alert('Failed to update profile. Please try again.');
        }

        btn.disabled = false;
        btn.textContent = 'Save Changes';
      });

      // Profile photo upload
      document.getElementById('profile-photo-input')?.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please select an image file');
          return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('Image must be less than 5MB');
          return;
        }
        
        try {
          log('Uploading profile picture...');
          const url = await uploadProfilePicture(file);
          if (url) {
            // Update the profile button image
            const profileBtn = document.getElementById('profile-btn');
            if (profileBtn) {
              profileBtn.innerHTML = `<img src="${url}" alt="Profile" class="w-full h-full object-cover" />`;
            }
            // Update the profile menu image
            const profileMenu = document.getElementById('profile-menu');
            if (profileMenu) {
              const img = profileMenu.querySelector('img');
              if (img) img.src = url;
            }
            log('Profile picture updated!');
            alert('Profile picture updated!');
          }
        } catch (err) {
          log('Profile upload failed: ' + err.message);
          alert('Failed to upload profile picture: ' + err.message);
        }
        
        // Reset input
        e.target.value = '';
      });

      // Circle search - filter chats/connections
      const searchInput = document.getElementById('search-connections');
      const clearSearchBtn = document.getElementById('clear-search');
      
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          state.circleSearchQuery = e.target.value.toLowerCase().trim();
          // Show/hide clear button
          if (clearSearchBtn) {
            clearSearchBtn.classList.toggle('hidden', !state.circleSearchQuery);
          }
          // Update the tab content to show filtered results
          updateSidebar();
        });
        
        // Focus handling
        searchInput.addEventListener('focus', () => {
          // Switch to circle tab when searching
          if (state.activeTab !== 'circle') {
            state.activeTab = 'circle';
            document.querySelectorAll('.tab-btn').forEach(b => {
              b.classList.toggle('text-white', b.dataset.tab === state.activeTab);
              b.classList.toggle('text-gray-500', b.dataset.tab !== state.activeTab);
              const indicator = b.querySelector('div');
              if (indicator) indicator.remove();
              if (b.dataset.tab === state.activeTab) {
                b.insertAdjacentHTML('beforeend', '<div class="absolute bottom-0 left-0 right-0 h-0.5 bg-white"></div>');
              }
            });
            updateSidebar();
          }
        });
      }
      
      // Clear search button
      if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', () => {
          state.circleSearchQuery = '';
          if (searchInput) searchInput.value = '';
          clearSearchBtn.classList.add('hidden');
          updateSidebar();
        });
      }

      // Tab switching
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          state.activeTab = btn.dataset.tab;
          // Clear search when switching tabs
          state.circleSearchQuery = '';
          if (searchInput) searchInput.value = '';
          if (clearSearchBtn) clearSearchBtn.classList.add('hidden');
          // Update active tab styling
          document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.toggle('text-white', b.dataset.tab === state.activeTab);
            b.classList.toggle('text-gray-500', b.dataset.tab !== state.activeTab);
            const indicator = b.querySelector('div');
            if (indicator) indicator.remove();
            if (b.dataset.tab === state.activeTab) {
              b.insertAdjacentHTML('beforeend', '<div class="absolute bottom-0 left-0 right-0 h-0.5 bg-white"></div>');
            }
          });
          updateSidebar();
        });
      });

      // Search users form
      document.getElementById('search-users-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('search-users-input');
        searchUsers(input.value);
      });

      // Attach request modal listeners
      attachRequestModalListeners();

      // Slide modal listeners
      function resetSlideModal() {
        document.getElementById('slide-modal')?.classList.add('hidden');
        document.getElementById('slide-content').value = '';
        document.getElementById('slide-char-count').textContent = '0/280';
        // Reset image
        document.getElementById('slide-image-preview')?.classList.add('hidden');
        document.getElementById('slide-image-upload-btn')?.classList.remove('hidden');
        const input = document.getElementById('slide-image-input');
        if (input) input.value = '';
      }

      document.getElementById('close-slide-modal')?.addEventListener('click', resetSlideModal);
      document.getElementById('cancel-slide')?.addEventListener('click', resetSlideModal);

      document.getElementById('slide-content')?.addEventListener('input', (e) => {
        const count = e.target.value.length;
        document.getElementById('slide-char-count').textContent = `${count}/280`;
      });

      // Slide image upload
      let slideImageFile = null;
      let slideImagePreviewUrl = null;

      document.getElementById('slide-image-input')?.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please select an image file');
          return;
        }
        
        // Validate file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
          alert('Image must be less than 10MB');
          return;
        }
        
        slideImageFile = file;
        slideImagePreviewUrl = URL.createObjectURL(file);
        
        // Show preview
        const preview = document.getElementById('slide-image-preview');
        const previewImg = document.getElementById('slide-preview-img');
        const uploadBtn = document.getElementById('slide-image-upload-btn');
        
        if (preview && previewImg) {
          previewImg.src = slideImagePreviewUrl;
          preview.classList.remove('hidden');
          uploadBtn?.classList.add('hidden');
        }
      });

      document.getElementById('remove-slide-image')?.addEventListener('click', () => {
        slideImageFile = null;
        if (slideImagePreviewUrl) {
          URL.revokeObjectURL(slideImagePreviewUrl);
          slideImagePreviewUrl = null;
        }
        
        const preview = document.getElementById('slide-image-preview');
        const uploadBtn = document.getElementById('slide-image-upload-btn');
        const input = document.getElementById('slide-image-input');
        
        preview?.classList.add('hidden');
        uploadBtn?.classList.remove('hidden');
        if (input) input.value = '';
      });

      document.getElementById('post-slide')?.addEventListener('click', async () => {
        const content = document.getElementById('slide-content')?.value?.trim();
        
        // Require either content or image
        if (!content && !slideImageFile) {
          alert('Please add a photo or caption');
          return;
        }

        const btn = document.getElementById('post-slide');
        btn.disabled = true;
        btn.textContent = 'Posting...';

        try {
          let imageUrl = null;
          
          // Upload image if selected
          if (slideImageFile) {
            btn.textContent = 'Uploading...';
            imageUrl = await uploadSlideImage(slideImageFile);
          }
          
          // Post the slide
          await postSlideWithImage(content, imageUrl);
          
          // Reset form
          document.getElementById('slide-modal')?.classList.add('hidden');
          document.getElementById('slide-content').value = '';
          document.getElementById('slide-char-count').textContent = '0/280';
          
          // Reset image
          slideImageFile = null;
          if (slideImagePreviewUrl) {
            URL.revokeObjectURL(slideImagePreviewUrl);
            slideImagePreviewUrl = null;
          }
          document.getElementById('slide-image-preview')?.classList.add('hidden');
          document.getElementById('slide-image-upload-btn')?.classList.remove('hidden');
          const input = document.getElementById('slide-image-input');
          if (input) input.value = '';
          
          log('Slide posted successfully!');
        } catch (err) {
          log('Error posting slide: ' + err.message);
          alert('Failed to post slide. Make sure Firebase Storage is enabled.');
        }

        btn.disabled = false;
        btn.textContent = 'Post Slide';
      });

      // ONLY the avatar opens the contact profile â€” not the whole header row
      document.getElementById('chat-avatar-btn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        const selectedChat = state.chats.find(c => c.id === state.selectedChatId);
        const user = selectedChat ? getOtherUser(selectedChat) : null;
        if (user) openContactProfile(user);
      });

      // Back button (mobile)
      document.getElementById('back-btn')?.addEventListener('click', () => {
        state.showMobileChat = false;
        state.selectedChatId = null;
        document.getElementById('sidebar')?.classList.remove('hidden');
        document.getElementById('sidebar')?.classList.add('flex');
        document.getElementById('chat-view')?.classList.add('hidden', 'md:flex');
        document.getElementById('chat-view')?.classList.remove('flex');
      });

      // Message form
      document.getElementById('message-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('message-input');
        if (input.value.trim()) {
          sendMessage(input.value);
          input.value = '';
          input.focus();
        }
      });

      attachTabContentListeners();
    }

    function attachTabContentListeners() {
      // Chat items
      document.querySelectorAll('.chat-item').forEach(item => {
        item.addEventListener('click', async () => {
          const chatId = item.dataset.chatId;
          const userId = item.dataset.userId; // For connections without chat
          
          log('Chat item clicked - chatId: ' + chatId + ', userId: ' + userId);
          
          if (chatId) {
            // Existing chat
            state.selectedChatId = chatId;
            log('Selected existing chat: ' + chatId);
          } else if (userId) {
            // Connection without chat - create new chat
            const user = state.connections.find(c => c.id === userId);
            if (user) {
              const newChatId = [state.user.uid, userId].sort().join('_');
              
              // Check if chat exists
              try {
                const existingChat = await getDoc(doc(db, 'chats', newChatId));
                
                if (!existingChat.exists()) {
                  // Create the chat
                  await setDoc(doc(db, 'chats', newChatId), {
                    participants: [state.user.uid, userId],
                    participantNames: {
                      [state.user.uid]: state.userData?.name || 'You',
                      [userId]: user.name
                    },
                    participantAvatars: {
                      [state.user.uid]: state.userData?.avatar || '',
                      [userId]: user.avatar || ''
                    },
                    lastMessage: '',
                    lastMessageTime: serverTimestamp(),
                    lastMessageSenderId: '',
                    lastMessageStatus: '',
                    requestsCount: 0,
                    createdAt: serverTimestamp()
                  });
                  log('Chat created for connection: ' + newChatId);
                }
                
                state.selectedChatId = newChatId;
                log('Created new chat: ' + newChatId);
              } catch (err) {
                log('Error creating chat: ' + err.message);
                return;
              }
            }
          }
          
          log('Opening chat: ' + state.selectedChatId);
          state.showMobileChat = true;
          // Load cached messages first (don't clear)
          if (allMessages[state.selectedChatId]) {
            state.messages = allMessages[state.selectedChatId];
            log('Loaded ' + state.messages.length + ' messages from memory cache');
          }
          setupMessagesListener(state.selectedChatId);
          
          // Update UI
          document.getElementById('sidebar')?.classList.add('hidden', 'md:flex');
          document.getElementById('sidebar')?.classList.remove('flex');
          document.getElementById('chat-view')?.classList.remove('hidden');
          document.getElementById('chat-view')?.classList.add('flex');
          
          // Update chat view content
          const selectedChat = state.chats.find(c => c.id === state.selectedChatId);
          const otherUser = selectedChat ? getOtherUser(selectedChat) : state.connections.find(c => c.id === userId);
          document.getElementById('chat-view').innerHTML = renderChatView(selectedChat || { id: state.selectedChatId, participants: [state.user.uid, userId] }, otherUser);
          attachChatViewListeners();
          updateChatRequestBadge();
        });
      });

      // Accept/Reject/Cancel invite buttons
      document.querySelectorAll('.accept-invite').forEach(btn => {
        btn.addEventListener('click', () => acceptInvite(btn.dataset.id));
      });
      document.querySelectorAll('.reject-invite').forEach(btn => {
        btn.addEventListener('click', () => rejectInvite(btn.dataset.id));
      });
      document.querySelectorAll('.cancel-invite').forEach(btn => {
        btn.addEventListener('click', () => cancelInvite(btn.dataset.id));
      });

      // Accept/Decline request buttons
      document.querySelectorAll('.accept-request').forEach(btn => {
        btn.addEventListener('click', () => acceptRequest(btn.dataset.id));
      });
      document.querySelectorAll('.decline-request').forEach(btn => {
        btn.addEventListener('click', () => declineRequest(btn.dataset.id));
      });

      // Requests sub-tabs (Incoming / Sent)
      document.querySelectorAll('.requests-subtab').forEach(btn => {
        btn.addEventListener('click', () => {
          state.requestsSubTab = btn.dataset.subtab;
          updateSidebar();
        });
      });

      // Open request modal buttons
      document.querySelectorAll('.open-request-modal').forEach(btn => {
        btn.addEventListener('click', () => {
          const userId = btn.dataset.userId;
          const userName = btn.dataset.userName;
          const userAvatar = btn.dataset.userAvatar;
          
          state.selectedRequestUser = {
            id: userId,
            name: userName,
            avatar: userAvatar
          };
          state.selectedRequestType = null;
          state.showRequestModal = true;
          
          document.getElementById('request-modal')?.classList.remove('hidden');
          updateRequestModal();
        });
      });

      // Find people button in slides tab
      document.getElementById('find-people-btn')?.addEventListener('click', () => {
        state.showUserSearch = true;
        state.searchResults = [];
        document.getElementById('user-search-modal')?.classList.remove('hidden');
        setTimeout(() => document.getElementById('search-users-input')?.focus(), 100);
      });

      // Find people button in circle tab
      document.getElementById('find-people-circle-btn')?.addEventListener('click', () => {
        state.showUserSearch = true;
        state.searchResults = [];
        document.getElementById('user-search-modal')?.classList.remove('hidden');
        setTimeout(() => document.getElementById('search-users-input')?.focus(), 100);
      });

      // Find people button in requests tab
      document.getElementById('find-people-requests-btn')?.addEventListener('click', () => {
        state.showUserSearch = true;
        state.searchResults = [];
        document.getElementById('user-search-modal')?.classList.remove('hidden');
        setTimeout(() => document.getElementById('search-users-input')?.focus(), 100);
      });

      // â”€â”€ Status bubble listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      // Add slide button (+ button on my status bubble)
      document.getElementById('add-slide-btn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('slide-modal')?.classList.remove('hidden');
        document.getElementById('slide-content')?.focus();
      });

      // My status bubble (view my slides)
      document.getElementById('my-slide-btn')?.addEventListener('click', () => {
        const mySlides = (state.slides || []).filter(s => s.userId === state.user?.uid);
        if (mySlides.length > 0) {
          openSlideViewer(state.user.uid);
        } else {
          document.getElementById('slide-modal')?.classList.remove('hidden');
          document.getElementById('slide-content')?.focus();
        }
      });

      // View connection slides
      document.querySelectorAll('.view-slide-btn').forEach(btn => {
        btn.addEventListener('click', () => { openSlideViewer(btn.dataset.userId); });
      });

      // â”€â”€ Updates sub-tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      document.querySelectorAll('.updates-subtab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          state.updatesSubTab = btn.dataset.subtab;
          updateSidebar();
        });
      });

      // â”€â”€ Open create post modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      ['open-create-post', 'open-create-post-icon'].forEach(id => {
        document.getElementById(id)?.addEventListener('click', openCreatePostModal);
      });

      // â”€â”€ Like a post â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      document.querySelectorAll('.post-like-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const postId = btn.dataset.postId;
          // Optimistic UI
          const countEl = btn.querySelector('.post-like-count');
          const svgEl = btn.querySelector('svg');
          const wasLiked = svgEl?.classList.contains('fill-red-500');
          if (!wasLiked) {
            btn.classList.replace('text-white', 'text-red-500');
            svgEl?.classList.add('fill-red-500');
            svgEl?.removeAttribute('stroke');
            if (countEl) countEl.textContent = parseInt(countEl.textContent||'0') + 1;
          } else {
            btn.classList.replace('text-red-500', 'text-white');
            svgEl?.classList.remove('fill-red-500');
            svgEl?.setAttribute('stroke', 'currentColor');
            if (countEl) countEl.textContent = Math.max(0, parseInt(countEl.textContent||'1') - 1);
          }
          btn.classList.add('like-pop');
          setTimeout(() => btn.classList.remove('like-pop'), 300);
          await toggleLike(postId);
        });
      });

      // â”€â”€ Delete my post â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      document.querySelectorAll('.post-delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          await deletePost(btn.dataset.postId);
        });
      });

      // â”€â”€ Connect from post â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      document.querySelectorAll('.post-connect-btn').forEach(btn => {
        if (btn.disabled) return;
        btn.addEventListener('click', () => {
          sendInviteFromPost(btn.dataset.userId, btn.dataset.userName, btn.dataset.userAvatar, btn);
        });
      });

      // â”€â”€ Comments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      document.querySelectorAll('.post-comment-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();
          openComments(btn.dataset.postId);
        });
      });

      // â”€â”€ Message connected user from post â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      document.querySelectorAll('.post-message-btn').forEach(btn => {
        btn.addEventListener('click', () => { openChatWithUser(btn.dataset.userId); });
      });

      // â”€â”€ Three-dot post menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      document.querySelectorAll('.post-menu-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const postId = btn.dataset.postId;
          const postUserId = btn.dataset.postUserId;
          const postUserName = btn.dataset.postUserName;
          const isOwn = postUserId === state.user?.uid;
          const sheet = document.getElementById('post-sheet');
          const label = document.getElementById('post-sheet-label');
          const actions = document.getElementById('post-sheet-actions');
          if (!sheet || !actions) return;
          if (label) label.textContent = isOwn ? 'Your post' : 'Post by ' + postUserName;
          actions.innerHTML = isOwn
            ? `<button class="w-full flex items-center gap-3 px-4 py-3.5 text-red-500 hover:bg-gray-100 rounded-xl text-sm font-medium"
                onclick="deletePost('${postId}');document.getElementById('post-sheet').classList.add('hidden')">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                Delete Post</button>`
            : `<button class="w-full flex items-center gap-3 px-4 py-3.5 text-white hover:bg-gray-100 rounded-xl text-sm font-medium"
                onclick="reportPost('${postId}','${postUserId}');document.getElementById('post-sheet').classList.add('hidden')">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/></svg>
                Report Post</button>
               <button class="w-full flex items-center gap-3 px-4 py-3.5 text-red-500 hover:bg-gray-100 rounded-xl text-sm font-medium"
                onclick="blockUserFromFeed('${postUserId}','${postUserName}');document.getElementById('post-sheet').classList.add('hidden')">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                Block ${postUserName}</button>`;
          sheet.classList.remove('hidden');
          document.getElementById('post-sheet-overlay')?.addEventListener('click', () => sheet.classList.add('hidden'), { once: true });
        });
      });
    }

    function attachChatViewListeners() {
      // Back button (mobile)
      document.getElementById('back-btn')?.addEventListener('click', () => {
        state.showMobileChat = false;
        state.selectedChatId = null;
        document.getElementById('sidebar')?.classList.remove('hidden');
        document.getElementById('sidebar')?.classList.add('flex');
        document.getElementById('chat-view')?.classList.add('hidden', 'md:flex');
        document.getElementById('chat-view')?.classList.remove('flex');
        document.getElementById('chat-view').innerHTML = renderEmptyChatView();
      });

      // Message input - auto resize and toggle send/mic button
            const messageInput = document.getElementById('message-input');
      const sendBtn = document.getElementById('send-btn');
      const voiceBtn = document.getElementById('voice-note-btn');
      
      if (messageInput) {
        messageInput.addEventListener('input', (e) => {
          // Auto resize
          e.target.style.height = 'auto';
          e.target.style.height = Math.min(e.target.scrollHeight, 128) + 'px';
          
          // Toggle send/mic button based on input content
          const hasText = e.target.value.trim().length > 0;
          if (sendBtn && voiceBtn) {
            if (hasText) {
              sendBtn.classList.remove('hidden');
              voiceBtn.classList.add('hidden');
            } else {
              sendBtn.classList.add('hidden');
              voiceBtn.classList.remove('hidden');
            }
          }
        });
        
        // Handle Enter key to send (Shift+Enter for new line)
        messageInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessageFromInput();
          }
        });
      }
      
      // Send button
      document.getElementById('send-btn')?.addEventListener('click', () => {
        sendMessageFromInput();
      });
      
      // â”€â”€ Emoji picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const ECATS = [
        { icon:'ðŸ˜€', label:'Smileys', emojis:['ðŸ˜€','ðŸ˜','ðŸ˜‚','ðŸ¤£','ðŸ˜Š','ðŸ˜‡','ðŸ™‚','ðŸ˜‰','ðŸ˜','ðŸ¤©','ðŸ˜˜','ðŸ˜‹','ðŸ˜›','ðŸ˜œ','ðŸ¤ª','ðŸ˜','ðŸ¤‘','ðŸ¤—','ðŸ¤”','ðŸ˜','ðŸ˜‘','ðŸ˜¶','ðŸ˜','ðŸ˜’','ðŸ™„','ðŸ˜¬','ðŸ˜³','ðŸ˜±','ðŸ˜¨','ðŸ˜°','ðŸ˜¥','ðŸ˜¢','ðŸ˜­','ðŸ˜¤','ðŸ˜ ','ðŸ¤¬','ðŸ˜ˆ','ðŸ’€','ðŸ˜´','ðŸ¤¢','ðŸ¤§','ðŸ¥µ','ðŸ¥¶','ðŸ˜µ','ðŸ¤¯','ðŸ¤ ','ðŸ˜Ž','ðŸ¤“'] },
        { icon:'ðŸ‘‹', label:'Hands', emojis:['ðŸ‘‹','ðŸ¤š','âœ‹','ðŸ––','ðŸ‘Œ','âœŒï¸','ðŸ¤ž','ðŸ‘','ðŸ‘Ž','âœŠ','ðŸ‘Š','ðŸ‘','ðŸ™Œ','ðŸ¤²','ðŸ™','ðŸ’ª','ðŸ«¶','ðŸ¤','ðŸ’…','ðŸ«µ','ðŸ‘ˆ','ðŸ‘‰','ðŸ‘†','ðŸ‘‡'] },
        { icon:'â¤ï¸', label:'Hearts', emojis:['â¤ï¸','ðŸ§¡','ðŸ’›','ðŸ’š','ðŸ’™','ðŸ’œ','ðŸ–¤','ðŸ¤','ðŸ¤Ž','â¤ï¸â€ðŸ”¥','ðŸ’”','ðŸ’•','ðŸ’ž','ðŸ’“','ðŸ’—','ðŸ’–','ðŸ’˜','ðŸ’','ðŸ’Ÿ','ðŸ’Œ','ðŸ’‹','ðŸ«‚'] },
        { icon:'ðŸ˜¸', label:'Animals', emojis:['ðŸ¶','ðŸ±','ðŸ­','ðŸ°','ðŸ¦Š','ðŸ»','ðŸ¼','ðŸ¨','ðŸ¯','ðŸ¦','ðŸ®','ðŸ·','ðŸ¸','ðŸµ','ðŸ™ˆ','ðŸ™‰','ðŸ™Š','ðŸ”','ðŸ§','ðŸ¦','ðŸ¦†','ðŸ¦…','ðŸ¦‰','ðŸº','ðŸ—','ðŸ¦‹','ðŸ','ðŸ›','ðŸ¦Ž','ðŸ¢','ðŸ¬','ðŸ³','ðŸ¦ˆ','ðŸ™'] },
        { icon:'ðŸ•', label:'Food', emojis:['ðŸ•','ðŸ”','ðŸŒ®','ðŸŒ¯','ðŸ£','ðŸœ','ðŸ','ðŸ›','ðŸ—','ðŸ¥©','ðŸŸ','ðŸ¦','ðŸ©','ðŸª','ðŸŽ‚','ðŸ°','ðŸ§','ðŸ«','ðŸ¬','ðŸ­','â˜•','ðŸ§ƒ','ðŸ¥¤','ðŸº','ðŸ»','ðŸ¥‚','ðŸ·'] },
        { icon:'âš½', label:'Sport', emojis:['âš½','ðŸ€','ðŸˆ','âš¾','ðŸŽ¾','ðŸ','ðŸ‰','ðŸŽ±','ðŸ†','ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰','ðŸŽ¯','ðŸŽ®','ðŸŽ²','ðŸŽ­','ðŸŽ¨','ðŸŽª','ðŸŽ ','ðŸŽ¡','ðŸŽ¢','ðŸŽŸï¸'] },
        { icon:'âœˆï¸', label:'Travel', emojis:['âœˆï¸','ðŸš€','ðŸ›¸','ðŸš','â›µ','ðŸš¢','ðŸš‚','ðŸš—','ðŸš•','ðŸš™','ðŸŽï¸','ðŸš²','ðŸ›µ','ðŸï¸','ðŸŒ','ðŸŒŽ','ðŸŒ','ðŸ—ºï¸','ðŸ”ï¸','ðŸŒ‹','ðŸ•ï¸','ðŸ–ï¸','ðŸœï¸','ðŸï¸','ðŸ—¼','ðŸ—½','ðŸ°','ðŸ¯','â›©ï¸'] },
        { icon:'ðŸ”¥', label:'Symbols', emojis:['ðŸ”¥','ðŸ’¯','âœ…','âŒ','â­•','ðŸ’¤','ðŸ’¢','ðŸ’¥','ðŸ’«','ðŸ’¦','ðŸ•³ï¸','ðŸ””','ðŸ”•','ðŸ“¢','ðŸ“£','ðŸ’¬','ðŸ’­','â™»ï¸','âšœï¸','â—','â“','ðŸ†•','ðŸ†“','ðŸ†’','ðŸ†™','ðŸ†—','â«','â¬','ðŸ”','ðŸ”›'] }
      ];
      let emojiOpen = false;
      let activeECat = 0;

      function renderECat(idx) {
        activeECat = idx;
        const grid = document.getElementById('emoji-grid');
        if (!grid) return;
        grid.innerHTML = '';
        ECATS[idx].emojis.forEach(em => {
          const b = document.createElement('button');
          b.textContent = em;
          b.style.cssText = 'font-size:22px;padding:5px;border-radius:6px;border:none;background:none;cursor:pointer;';
          b.addEventListener('mouseenter', () => b.style.background = '#f3f4f6');
          b.addEventListener('mouseleave', () => b.style.background = 'none');
          b.addEventListener('click', () => {
            const inp = document.getElementById('message-input');
            if (inp) {
              const p = inp.selectionStart ?? inp.value.length;
              inp.value = inp.value.slice(0, p) + em + inp.value.slice(p);
              inp.focus();
              inp.setSelectionRange(p + em.length, p + em.length);
              inp.dispatchEvent(new Event('input'));
            }
          });
          grid.appendChild(b);
        });
        // Highlight active cat tab
        document.querySelectorAll('.ecat-btn').forEach((b2, i) => {
          b2.style.background = i === idx ? '#f3f4f6' : 'none';
        });
      }

      function buildECatTabs() {
        const cats = document.getElementById('emoji-cats');
        if (!cats) return;
        cats.innerHTML = '';
        ECATS.forEach((cat, i) => {
          const b = document.createElement('button');
          b.className = 'ecat-btn';
          b.textContent = cat.icon;
          b.title = cat.label;
          b.style.cssText = 'font-size:20px;padding:4px 8px;border-radius:8px;border:none;cursor:pointer;flex-shrink:0;';
          b.addEventListener('click', () => renderECat(i));
          cats.appendChild(b);
        });
      }

      const emojiBtn2 = document.getElementById('emoji-btn');
      const emojiPanel2 = document.getElementById('emoji-panel');
      emojiBtn2?.addEventListener('click', e => {
        e.stopPropagation();
        emojiOpen = !emojiOpen;
        if (emojiPanel2) emojiPanel2.classList.toggle('open', emojiOpen);
        if (emojiOpen) { buildECatTabs(); renderECat(0); }
      });
      document.addEventListener('click', e => {
        if (emojiOpen && emojiPanel2 && !emojiPanel2.contains(e.target) && e.target !== emojiBtn2) {
          emojiOpen = false;
          emojiPanel2?.classList.remove('open');
        }
      });

      // Voice note button
      document.getElementById('voice-note-btn')?.addEventListener('click', () => {
        if (!isRecording) {
          startVoiceRecording();
        }
      });
      
      // Helper function to send message
      function sendMessageFromInput() {
        const input = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const voiceBtn = document.getElementById('voice-note-btn');
        
        if (input && input.value.trim()) {
          sendMessage(input.value);
          input.value = '';
          input.style.height = 'auto';
          input.focus();
          
          // Reset to show mic button after sending
          if (sendBtn && voiceBtn) {
            sendBtn.classList.add('hidden');
            voiceBtn.classList.remove('hidden');
          }
        }
      }

      // Message form (backup submit handler)
      document.getElementById('message-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        sendMessageFromInput();
      });
      
      // Scroll to bottom button
      const messageList = document.getElementById('message-list');
      const scrollBtn = document.getElementById('scroll-to-bottom');
      
      if (messageList && scrollBtn) {
        // Show/hide scroll button based on scroll position
        messageList.addEventListener('scroll', () => {
          const isNearBottom = messageList.scrollHeight - messageList.scrollTop - messageList.clientHeight < 100;
          scrollBtn.classList.toggle('hidden', isNearBottom);
          scrollBtn.classList.toggle('flex', !isNearBottom);
        });
        
        // Click to scroll to bottom
        scrollBtn.addEventListener('click', () => {
          messageList.scrollTo({
            top: messageList.scrollHeight,
            behavior: 'smooth'
          });
        });
        
        // Initially scroll to bottom
        messageList.scrollTop = messageList.scrollHeight;
      }
      
      // Voice call button
      document.getElementById('voice-call-btn')?.addEventListener('click', () => {
        log('Voice call button clicked');
        const selectedChat = state.chats.find(c => c.id === state.selectedChatId);
        const otherUser = selectedChat ? getOtherUser(selectedChat) : null;
        log('Other user for call: ' + (otherUser ? otherUser.name : 'null'));
        if (otherUser) {
          startCall(otherUser.id, 'voice');
        } else {
          log('Cannot start call - no other user found');
          alert('Cannot start call - user not found');
        }
      });
      
      // Request from chat button
      document.getElementById('request-from-chat-btn')?.addEventListener('click', () => {
        log('Request from chat button clicked');
        const selectedChat = state.chats.find(c => c.id === state.selectedChatId);
        const otherUser = selectedChat ? getOtherUser(selectedChat) : null;
        
        if (otherUser) {
          state.selectedRequestUser = {
            id: otherUser.id,
            name: otherUser.name,
            avatar: otherUser.avatar || ''
          };
          state.selectedRequestType = null;
          state.showRequestModal = true;
          
          document.getElementById('request-modal')?.classList.remove('hidden');
          updateRequestModal();
        } else {
          alert('Cannot send request - user not found');
        }
      });
      
      // Video call button
      document.getElementById('video-call-btn')?.addEventListener('click', () => {
        log('Video call button clicked');
        const selectedChat = state.chats.find(c => c.id === state.selectedChatId);
        const otherUser = selectedChat ? getOtherUser(selectedChat) : null;
        log('Other user for call: ' + (otherUser ? otherUser.name : 'null'));
        if (otherUser) {
          startCall(otherUser.id, 'video');
        } else {
          log('Cannot start call - no other user found');
          alert('Cannot start call - user not found');
        }
      });
      
      // Attachment button - toggle menu
      const attachmentBtn = document.getElementById('attachment-btn');
      const attachmentMenu = document.getElementById('attachment-menu');
      
      attachmentBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        attachmentMenu?.classList.toggle('hidden');
        // Close other menus
        document.getElementById('more-options-menu')?.classList.add('hidden');
      });
      
      // Attachment options
      document.querySelectorAll('.attachment-option').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const type = btn.dataset.type;
          log('Attachment option clicked: ' + type);
          attachmentMenu?.classList.add('hidden');
          
          switch(type) {
            case 'camera':
              // Open camera (on mobile this opens camera, on desktop shows file picker)
              const cameraInput = document.createElement('input');
              cameraInput.type = 'file';
              cameraInput.accept = 'image/*';
              cameraInput.capture = 'environment';
              cameraInput.onchange = (e) => handleAttachmentFile(e.target.files[0], 'image');
              cameraInput.click();
              break;
            case 'gallery':
              document.getElementById('attachment-gallery-input')?.click();
              break;
            case 'document':
              document.getElementById('attachment-document-input')?.click();
              break;
            case 'location':
              handleShareLocation();
              break;
            case 'contact':
              openContactPicker();
              break;
            case 'audio':
              document.getElementById('attachment-audio-input')?.click();
              break;
          }
        });
      });
      
      // File input handlers
      document.getElementById('attachment-gallery-input')?.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files.length > 0) {
          for (let file of files) {
            handleAttachmentFile(file, 'media');
          }
        }
        e.target.value = '';
      });
      
      document.getElementById('attachment-document-input')?.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          // Check file size (max 500KB for Firestore)
          if (file.size > 500 * 1024) {
            alert('Document too large! Maximum size is 500KB. Please use a smaller file or compress it.');
            e.target.value = '';
            return;
          }
          
          // Convert to Base64 and send
          const reader = new FileReader();
          reader.onload = async () => {
            const base64 = reader.result;
            const fileName = file.name;
            const fileSize = file.size;
            const fileType = file.type || 'application/octet-stream';
            const fileExt = fileName.split('.').pop().toLowerCase();
            
            await sendDocumentMessage(fileName, base64, fileSize, fileType, fileExt);
          };
          reader.onerror = () => {
            alert('Error reading file. Please try again.');
          };
          reader.readAsDataURL(file);
        }
        e.target.value = '';
      });
      
      document.getElementById('attachment-audio-input')?.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          handleAttachmentFile(file, 'audio');
        }
        e.target.value = '';
      });
      
      // More options button - toggle menu
      const moreOptionsBtn = document.getElementById('more-options-btn');
      const moreOptionsMenu = document.getElementById('more-options-menu');
      
      moreOptionsBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        moreOptionsMenu?.classList.toggle('hidden');
        // Close other menus
        attachmentMenu?.classList.add('hidden');
      });
      
      // More options actions
      document.querySelectorAll('.more-option').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const action = btn.dataset.action;
          log('More option clicked: ' + action);
          moreOptionsMenu?.classList.add('hidden');
          
          const selectedChat = state.chats.find(c => c.id === state.selectedChatId);
          const otherUser = selectedChat ? getOtherUser(selectedChat) : null;
          
          switch(action) {
            case 'view-contact':
              if (otherUser) {
                openContactProfile(otherUser);
              }
              break;
            case 'search':
              openSearchInChat();
              break;
            case 'mute':
              openMuteOptions();
              break;
            case 'wallpaper':
              openWallpaperPicker();
              break;
            case 'clear-chat':
              if (confirm('Clear all messages in this chat? This cannot be undone.')) {
                await clearChat(state.selectedChatId);
              }
              break;
            case 'block':
              if (otherUser) {
                await toggleBlockUser(otherUser.id, otherUser.name);
              }
              break;
            case 'report':
              if (confirm('Report this conversation for abuse?')) {
                alert('Report submitted. Thank you for helping keep Linq safe.');
              }
              break;
          }
        });
      });
      
      // Close menus when clicking elsewhere
      document.addEventListener('click', () => {
        attachmentMenu?.classList.add('hidden');
        moreOptionsMenu?.classList.add('hidden');
      });
    }

    function attachSearchResultListeners() {
      document.querySelectorAll('.send-invite-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const user = state.searchResults.find(u => u.id === btn.dataset.userId);
          if (user) {
            btn.disabled = true;
            btn.textContent = 'Sending...';
            await sendInvite(user);
            btn.textContent = 'Sent!';
            setTimeout(() => {
              renderSearchResults();
            }, 1000);
          }
        });
      });
    }

    function renderTabContent() {
      if (state.activeTab === 'circle') {
        return renderCircleTab();
      } else {
        return renderSlidesTab();
      }
    }

    function renderCircleTab() {
      const searchQuery = state.circleSearchQuery || '';
      
      // Filter function for search
      const matchesSearch = (chat, user) => {
        if (!searchQuery) return true;
        
        // Search by user name
        if (user?.name?.toLowerCase().includes(searchQuery)) return true;
        
        // Search by last message content
        if (chat?.lastMessage?.toLowerCase().includes(searchQuery)) return true;
        
        // Search by location
        if (user?.location?.toLowerCase().includes(searchQuery)) return true;
        
        return false;
      };
      
      if (state.chats.length === 0 && state.connections.length === 0) {
        return `
          <div class="flex-1 flex items-center justify-center p-8">
            <div class="text-center text-gray-500">
              <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gray-800 flex items-center justify-center">
                <svg class="w-10 h-10 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
              </div>
              <p class="text-sm font-medium text-gray-400 mb-2">No connections yet</p>
              <p class="text-xs text-gray-600">Find people and send invites to connect</p>
              <button id="find-people-circle-btn" class="mt-4 px-4 py-2 bg-white text-black rounded-lg font-medium hover:bg-gray-200 transition-colors">Find People</button>
            </div>
          </div>
        `;
      }

      // Show chats if available - WhatsApp style
      if (state.chats.length > 0) {
        // Sort chats by last message time (most recent first)
        let sortedChats = [...state.chats].sort((a, b) => {
          const timeA = a.lastMessageTime?.toDate?.() || new Date(a.lastMessageTime || 0);
          const timeB = b.lastMessageTime?.toDate?.() || new Date(b.lastMessageTime || 0);
          return timeB - timeA;
        });
        
        // Filter chats based on search query
        if (searchQuery) {
          sortedChats = sortedChats.filter(chat => {
            const user = getOtherUser(chat);
            return matchesSearch(chat, user);
          });
          
          // Show no results message if no matches
          if (sortedChats.length === 0) {
            return `
              <div class="flex-1 flex items-center justify-center p-8">
                <div class="text-center text-gray-500">
                  <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                  <p class="text-sm font-medium text-gray-400 mb-1">No results for "${searchQuery}"</p>
                  <p class="text-xs text-gray-600">Try searching for a name or message</p>
                </div>
              </div>
            `;
          }
        }
        
        return sortedChats.map(chat => {
          const user = getOtherUser(chat);
          const otherId = chat.participants.find(p => p !== state.user?.uid);
          const isTyping = state.typingUsers && state.typingUsers[otherId];
          const unreadCount = chat.unreadCount || 0;
          const lastMsgIsMe = chat.lastMessageSenderId === state.user?.uid;
          
          // If user data not loaded yet, show placeholder
          if (!user) {
            return `
              <div class="chat-item chat-item-hover flex items-center gap-3 px-4 py-3 cursor-pointer transition-all border-b border-gray-800/50 hover:bg-gray-100/80" data-chat-id="${chat.id}">
                <div class="relative flex-shrink-0">
                  <div class="w-14 h-14 rounded-full bg-gray-700 animate-pulse"></div>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="h-4 w-28 bg-gray-700 rounded animate-pulse mb-2"></div>
                  <div class="h-3 w-40 bg-gray-800 rounded animate-pulse"></div>
                </div>
              </div>
            `;
          }
          
          // Format time like WhatsApp
          const timeStr = formatChatTime(chat.lastMessageTime);
          const hasUnread = unreadCount > 0;
          
          return `
            <div class="chat-item chat-item-hover flex items-center gap-3 px-4 py-3 cursor-pointer transition-all border-b border-gray-800/50 ${state.selectedChatId === chat.id ? 'bg-gray-800' : 'hover:bg-gray-100/80'}" data-chat-id="${chat.id}">
              <!-- Avatar with online indicator -->
              <div class="relative flex-shrink-0">
                <img src="${user.avatar || `https://ui-avatars.com/api/?name=${user.name}&background=333&color=fff`}" alt="${user.name}" class="w-14 h-14 rounded-full object-cover border border-gray-800">
                ${user.isOnline ? '<div class="absolute bottom-0.5 right-0.5 w-3.5 h-3.5 bg-white rounded-full border-2 border-black"></div>' : ''}
              </div>
              
              <!-- Chat info -->
              <div class="flex-1 min-w-0">
                <!-- Name and time row -->
                <div class="flex items-center justify-between mb-0.5">
                  <h3 class="font-semibold text-white truncate text-[15px]">${searchQuery ? highlightSearchMatch(user.name, searchQuery) : user.name}</h3>
                  <span class="text-xs ${hasUnread ? 'text-white font-medium' : 'text-gray-500'} flex-shrink-0 ml-2">${timeStr}</span>
                </div>
                
                <!-- Last message row -->
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-1 flex-1 min-w-0">
                    ${lastMsgIsMe && chat.lastMessage ? `
                      <!-- Double checkmark for sent messages -->
                      <span class="flex-shrink-0">
                        ${chat.lastMessageStatus === 'read' ? `
                          <svg class="w-4 h-4 text-white" viewBox="0 0 16 15" fill="currentColor">
                            <path d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.879a.32.32 0 0 1-.484.033l-.358-.325a.319.319 0 0 0-.484.032l-.378.483a.418.418 0 0 0 .036.541l1.32 1.266c.143.14.361.125.484-.033l6.272-8.048a.366.366 0 0 0-.064-.512zm-4.1 0l-.478-.372a.365.365 0 0 0-.51.063L4.566 9.879a.32.32 0 0 1-.484.033L1.891 7.769a.366.366 0 0 0-.515.006l-.423.433a.364.364 0 0 0 .006.514l3.258 3.185c.143.14.361.125.484-.033l6.272-8.048a.365.365 0 0 0-.063-.51z"/>
                          </svg>
                        ` : chat.lastMessageStatus === 'delivered' ? `
                          <svg class="w-4 h-4 text-gray-400" viewBox="0 0 16 15" fill="currentColor">
                            <path d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.879a.32.32 0 0 1-.484.033l-.358-.325a.319.319 0 0 0-.484.032l-.378.483a.418.418 0 0 0 .036.541l1.32 1.266c.143.14.361.125.484-.033l6.272-8.048a.366.366 0 0 0-.064-.512zm-4.1 0l-.478-.372a.365.365 0 0 0-.51.063L4.566 9.879a.32.32 0 0 1-.484.033L1.891 7.769a.366.366 0 0 0-.515.006l-.423.433a.364.364 0 0 0 .006.514l3.258 3.185c.143.14.361.125.484-.033l6.272-8.048a.365.365 0 0 0-.063-.51z"/>
                          </svg>
                        ` : `
                          <svg class="w-4 h-4 text-gray-500" viewBox="0 0 16 15" fill="currentColor">
                            <path d="M10.91 3.316l-.478-.372a.365.365 0 0 0-.51.063L4.566 9.879a.32.32 0 0 1-.484.033L1.891 7.769a.366.366 0 0 0-.515.006l-.423.433a.364.364 0 0 0 .006.514l3.258 3.185c.143.14.361.125.484-.033l6.272-8.048a.365.365 0 0 0-.063-.51z"/>
                          </svg>
                        `}
                      </span>
                    ` : ''}
                    
                    ${isTyping ? `
                      <!-- Typing indicator -->
                      <span class="text-white text-sm font-medium italic">typing</span>
                      <span class="flex gap-0.5 ml-0.5">
                        <span class="typing-dot w-1.5 h-1.5 bg-white rounded-full"></span>
                        <span class="typing-dot w-1.5 h-1.5 bg-white rounded-full"></span>
                        <span class="typing-dot w-1.5 h-1.5 bg-white rounded-full"></span>
                      </span>
                    ` : `
                      <p class="text-sm ${hasUnread ? 'text-white font-medium' : 'text-gray-400'} truncate">${chat.lastMessage || 'Start a conversation'}</p>
                    `}
                  </div>
                  
                  <!-- Unread badge -->
                  ${hasUnread ? `
                    <span class="ml-2 flex-shrink-0 bg-white text-black text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1.5">${unreadCount > 99 ? '99+' : unreadCount}</span>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      // Show connections without chats
      let filteredConnections = state.connections;
      
      // Filter connections based on search query
      if (searchQuery) {
        filteredConnections = state.connections.filter(user => {
          if (user.name?.toLowerCase().includes(searchQuery)) return true;
          if (user.status?.toLowerCase().includes(searchQuery)) return true;
          if (user.location?.toLowerCase().includes(searchQuery)) return true;
          return false;
        });
        
        // Show no results message if no matches
        if (filteredConnections.length === 0) {
          return `
            <div class="flex-1 flex items-center justify-center p-8">
              <div class="text-center text-gray-500">
                <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <p class="text-sm font-medium text-gray-400 mb-1">No results for "${searchQuery}"</p>
                <p class="text-xs text-gray-600">Try searching for a name</p>
              </div>
            </div>
          `;
        }
      }
      
      return filteredConnections.map(user => `
        <div class="chat-item chat-item-hover flex items-center gap-3 px-4 py-3 cursor-pointer transition-all border-b border-gray-800/50 hover:bg-gray-100/80" data-user-id="${user.id}">
          <div class="relative flex-shrink-0">
            <img src="${user.avatar || `https://ui-avatars.com/api/?name=${user.name}&background=333&color=fff`}" alt="${user.name}" class="w-14 h-14 rounded-full object-cover border border-gray-800">
            ${user.isOnline ? '<div class="absolute bottom-0.5 right-0.5 w-3.5 h-3.5 bg-white rounded-full border-2 border-black"></div>' : ''}
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between mb-0.5">
              <h3 class="font-semibold text-white truncate text-[15px]">${highlightSearchMatch(user.name, searchQuery)}</h3>
              <span class="text-xs text-gray-500">tap to chat</span>
            </div>
            <p class="text-sm text-gray-500 truncate">${user.status || 'Hey there! I am using Linq'}</p>
          </div>
        </div>
      `).join('');
    }
    
    // Helper function to highlight search matches in text
    function highlightSearchMatch(text, query) {
      if (!query || !text) return text;
      const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return text.replace(regex, '<span class="bg-white/20 text-white">$1</span>');
    }
    
    // WhatsApp-style time formatting
    function formatChatTime(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const now = new Date();
      const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) {
        // Today - show time
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } else if (diffDays === 1) {
        return 'Yesterday';
      } else if (diffDays < 7) {
        // This week - show day name
        return date.toLocaleDateString([], { weekday: 'short' });
      } else {
        // Older - show date
        return date.toLocaleDateString([], { day: '2-digit', month: '2-digit', year: '2-digit' });
      }
    }


    // Helper: compute days from today to a date string (YYYY-MM-DD)
    function getDaysUntil(dateStr) {
      if (!dateStr) return null;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const target = new Date(dateStr + 'T00:00:00');
      return Math.round((target - today) / (1000 * 60 * 60 * 24));
    }

    // Helper: countdown chip HTML for a date
    function getDateCountdownChip(dateStr) {
      if (!dateStr) return '';
      const days = getDaysUntil(dateStr);
      if (days === null) return '';
      let label, chipClass, iconPath;
      if (days < 0) {
        label = `Overdue by ${Math.abs(days)}d`;
        chipClass = 'bg-red-100 text-red-600 border border-red-200';
        iconPath = 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z';
      } else if (days === 0) {
        label = 'Today!';
        chipClass = 'bg-red-500 text-white';
        iconPath = 'M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.974 7.974 0 01-2.343 5.657z M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z';
      } else if (days === 1) {
        label = 'Tomorrow';
        chipClass = 'bg-orange-500 text-white';
        iconPath = 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z';
      } else if (days <= 3) {
        label = `In ${days} days`;
        chipClass = 'bg-orange-100 text-orange-700 border border-orange-200';
        iconPath = 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z';
      } else if (days <= 7) {
        label = `In ${days} days`;
        chipClass = 'bg-yellow-100 text-yellow-700 border border-yellow-200';
        iconPath = 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z';
      } else {
        label = `In ${days} days`;
        chipClass = 'bg-gray-100 text-gray-500 border border-gray-200';
        iconPath = 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z';
      }
      return `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold ${chipClass}">
        <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"/></svg>
        ${label}
      </span>`;
    }

    // Helper: status pill for a request
    function getStatusPill(status) {
      if (status === 'accepted') {
        return `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
          Accepted
        </span>`;
      } else if (status === 'declined') {
        return `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-bold bg-red-100 text-red-600 border border-red-200">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"/></svg>
          Declined
        </span>`;
      } else {
        return `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700 border border-yellow-200">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          Pending
        </span>`;
      }
    }

    // Helper: reminder banner for upcoming accepted/pending requests within 3 days
    function getReminderBanner() {
      const allReqs = [...(state.sentRequests || []), ...(state.receivedRequests || [])];
      const upcoming = allReqs.filter(req => {
        const dateStr = req.details?.date;
        if (!dateStr) return false;
        const days = getDaysUntil(dateStr);
        return days !== null && days >= 0 && days <= 3 && req.status !== 'declined';
      }).sort((a, b) => getDaysUntil(a.details.date) - getDaysUntil(b.details.date));

      if (upcoming.length === 0) return '';

      const items = upcoming.map(req => {
        const days = getDaysUntil(req.details.date);
        const isFromMe = req.fromId === state.user?.uid;
        const person = isFromMe ? (req.toName || 'Someone') : (req.fromName || 'Someone');
        const typeConfig = REQUEST_TYPES[req.type] || REQUEST_TYPES.special;
        const timeLabel = days === 0 ? 'Today!' : days === 1 ? 'Tomorrow' : `In ${days} days`;
        const timeLabelClass = days === 0 ? 'text-red-600 font-extrabold' : days === 1 ? 'text-orange-600 font-bold' : 'text-orange-700 font-bold';
        const dotIcon = days === 0
          ? `<svg class="w-3.5 h-3.5 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.974 7.974 0 01-2.343 5.657z M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"/></svg>`
          : `<svg class="w-3.5 h-3.5 text-orange-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;
        return `
          <div class="flex items-center gap-2 py-1.5 border-b border-orange-200 last:border-0">
            ${dotIcon}
            <span class="text-orange-900 text-xs flex-1 min-w-0 truncate">
              <span class="font-bold">${typeConfig.name}</span> with <span class="font-semibold">${person}</span>
              ${req.details?.time ? `<span class="text-orange-600"> Â· ${req.details.time}</span>` : ''}
            </span>
            <span class="text-xs flex-shrink-0 ${timeLabelClass}">${timeLabel}</span>
          </div>
        `;
      }).join('');

      return `
        <div class="mx-3 mt-3 mb-1 bg-orange-50 border border-orange-300 rounded-xl p-3 shadow-sm">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-orange-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
            <span class="text-orange-800 text-xs font-bold uppercase tracking-wide">Upcoming Reminders</span>
          </div>
          ${items}
        </div>
      `;
    }

    function renderRequestsTab() {
      const hasConnections = state.connections.length > 0;
      const hasReceivedRequests = state.receivedRequests.length > 0;
      const hasSentRequests = state.sentRequests.length > 0;
      const subTab = state.requestsSubTab || 'incoming';
      
      log('Rendering Requests tab - Connections: ' + state.connections.length);
      
      let html = '';

      // Reminder banner â€” upcoming dates within 3 days
      html += getReminderBanner();
      
      // Section 1: Send Requests to Connections
      html += `
        <div class="border-b border-gray-800">
          <div class="px-4 py-3 bg-white border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-sm font-semibold text-black uppercase tracking-wider">Send a Request</h3>
            ${hasConnections ? `<span class="text-xs text-gray-500">${state.connections.length} connection${state.connections.length > 1 ? 's' : ''}</span>` : ''}
          </div>
          ${hasConnections ? `
            <div class="p-3 space-y-2 bg-white">
              ${state.connections.map(user => `
                <div class="flex items-center justify-between p-3 rounded-lg bg-white hover:bg-gray-50 transition-colors border border-gray-200">
                  <div class="flex items-center gap-3">
                    <div class="relative">
                      <img src="${user.avatar || `https://ui-avatars.com/api/?name=${user.name}&background=333&color=fff`}" alt="${user.name}" class="w-10 h-10 rounded-full object-cover">
                      ${user.isOnline ? '<div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-400 rounded-full border-2 border-white"></div>' : ''}
                    </div>
                    <div>
                      <span class="text-black font-medium block">${user.name}</span>
                      <span class="text-gray-500 text-xs">${user.isOnline ? 'Online' : 'Offline'}</span>
                    </div>
                  </div>
                  <button class="open-request-modal px-3 py-1.5 bg-black text-white rounded-lg text-sm font-semibold hover:bg-gray-800 active:scale-95 transition-all flex items-center gap-1.5" data-user-id="${user.id}" data-user-name="${user.name}" data-user-avatar="${user.avatar || ''}">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/></svg>
                    Request
                  </button>
                </div>
              `).join('')}
            </div>
          ` : `
            <div class="flex flex-col items-center justify-center py-8 px-4 text-gray-500 bg-white">
              <svg class="w-10 h-10 mb-2 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              <p class="text-sm text-center mb-3">No connections yet</p>
              <p class="text-xs text-gray-400 text-center mb-4">Add people to your circle first, then you can send them requests</p>
              <button id="find-people-requests-btn" class="px-4 py-2 bg-black text-white rounded-lg text-sm font-medium hover:bg-gray-800 transition-colors">Find People</button>
            </div>
          `}
        </div>
      `;
      
      // Section 2: Incoming/Sent sub-tabs
      html += `
        <div>
          <div class="flex bg-white sticky top-0 z-10 shadow-sm">
            <button class="requests-subtab flex-1 py-3.5 text-sm font-semibold transition-all relative active:bg-gray-50 ${subTab === 'incoming' ? 'text-black border-b-2 border-black' : 'text-gray-400 border-b-2 border-transparent'}" data-subtab="incoming">
              Incoming
              ${hasReceivedRequests ? `<span class="ml-1.5 px-1.5 py-0.5 text-xs rounded-full ${subTab === 'incoming' ? 'bg-black text-white' : 'bg-gray-200 text-gray-600'}">${state.receivedRequests.length}</span>` : ''}
            </button>
            <button class="requests-subtab flex-1 py-3.5 text-sm font-semibold transition-all relative active:bg-gray-50 ${subTab === 'sent' ? 'text-black border-b-2 border-black' : 'text-gray-400 border-b-2 border-transparent'}" data-subtab="sent">
              Sent
              ${hasSentRequests ? `<span class="ml-1.5 px-1.5 py-0.5 text-xs rounded-full ${subTab === 'sent' ? 'bg-black text-white' : 'bg-gray-200 text-gray-600'}">${state.sentRequests.length}</span>` : ''}
            </button>
          </div>

          ${subTab === 'incoming' ? `
            ${hasReceivedRequests ? `
              <div class="divide-y divide-gray-100 bg-white">
                ${state.receivedRequests.map(req => {
                  const typeConfig = REQUEST_TYPES[req.type] || REQUEST_TYPES.special;
                  const dateChip = getDateCountdownChip(req.details?.date);
                  return `
                    <div class="p-4 hover:bg-gray-50 transition-colors">
                      <div class="flex items-start gap-3">
                        <img src="${req.fromAvatar || `https://ui-avatars.com/api/?name=${req.fromName}&background=333&color=fff`}" alt="${req.fromName}" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                        <div class="flex-1 min-w-0">
                          <div class="flex items-center justify-between mb-1.5 flex-wrap gap-1">
                            <div class="flex items-center gap-1.5 flex-wrap">
                              <span class="text-black font-semibold text-sm">${req.fromName}</span>
                              <span class="text-gray-300">â€¢</span>
                              <span class="text-gray-500 text-xs flex items-center gap-1">
                                ${typeConfig.icon.replace('w-6 h-6', 'w-3.5 h-3.5')}
                                ${typeConfig.name}
                              </span>
                            </div>
                            ${getStatusPill('pending')}
                          </div>
                          ${dateChip ? `<div class="mb-2">${dateChip}</div>` : ''}
                          <div class="bg-gray-50 rounded-xl p-3 mb-3 border border-gray-200">
                            ${renderRequestDetails(req)}
                          </div>
                          <div class="flex gap-2">
                            <button class="accept-request flex-1 py-3 bg-black text-white rounded-xl text-sm font-bold hover:bg-gray-800 active:scale-95 transition-all flex items-center justify-center gap-1.5" data-id="${req.id}">
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>
                              Accept
                            </button>
                            <button class="decline-request flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl text-sm font-bold hover:bg-gray-200 active:scale-95 transition-all flex items-center justify-center gap-1.5" data-id="${req.id}">
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/></svg>
                              Decline
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `
              <div class="flex flex-col items-center justify-center py-10 px-4 text-gray-400 bg-white">
                <svg class="w-10 h-10 mb-2 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                </svg>
                <p class="text-sm font-medium">No incoming requests</p>
                <p class="text-xs text-gray-400 mt-1">When someone sends you a request, it'll show here</p>
              </div>
            `}
          ` : `
            ${hasSentRequests ? `
              <div class="divide-y divide-gray-100 bg-white">
                ${state.sentRequests.map(req => {
                  const typeConfig = REQUEST_TYPES[req.type] || REQUEST_TYPES.special;
                  const dateChip = getDateCountdownChip(req.details?.date);
                  const sentAt = req.createdAt?.toDate?.() || (req.createdAt ? new Date(req.createdAt) : null);
                  const sentLabel = sentAt ? sentAt.toLocaleDateString([], { day: 'numeric', month: 'short' }) : '';
                  return `
                    <div class="p-4 hover:bg-gray-50 transition-colors">
                      <div class="flex items-start gap-3">
                        <img src="${req.toAvatar || `https://ui-avatars.com/api/?name=${req.toName || 'User'}&background=333&color=fff`}" alt="${req.toName || 'User'}" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                        <div class="flex-1 min-w-0">
                          <div class="flex items-center justify-between mb-1.5 flex-wrap gap-1">
                            <div class="flex items-center gap-1.5 flex-wrap">
                              <span class="text-black font-semibold text-sm">${req.toName || 'Unknown'}</span>
                              <span class="text-gray-300">â€¢</span>
                              <span class="text-gray-500 text-xs flex items-center gap-1">
                                ${typeConfig.icon.replace('w-6 h-6', 'w-3.5 h-3.5')}
                                ${typeConfig.name}
                              </span>
                            </div>
                            ${getStatusPill(req.status)}
                          </div>
                          ${dateChip ? `<div class="mb-2">${dateChip}</div>` : ''}
                          ${sentLabel ? `<p class="text-gray-400 text-xs mb-2">Sent ${sentLabel}</p>` : ''}
                          <div class="bg-gray-50 rounded-xl p-3 border border-gray-200">
                            ${renderRequestDetails(req)}
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `
              <div class="flex flex-col items-center justify-center py-10 px-4 text-gray-400 bg-white">
                <svg class="w-10 h-10 mb-2 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
                <p class="text-sm font-medium">No sent requests yet</p>
                <p class="text-xs text-gray-400 mt-1">Requests you send will appear here with their status</p>
              </div>
            `}
          `}
        </div>
      `;
      
      return html;
    }

    function renderRequestDetails(req) {
      const details = req.details || {};
      let html = '';
      
      if (details.title) {
        html += `<p class="text-gray-900 font-semibold text-sm mb-1">${details.title}</p>`;
      }
      if (details.description) {
        html += `<p class="text-gray-600 text-sm mb-2">${details.description}</p>`;
      }
      if (details.date || details.time) {
        const formattedDate = details.date ? new Date(details.date + 'T00:00:00').toLocaleDateString([], { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' }) : '';
        html += `<p class="text-gray-600 text-sm flex items-center gap-2">
          <svg class="w-3.5 h-3.5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
          ${formattedDate}${details.time ? ' Â· ' + details.time : ''}
        </p>`;
      }
      if (details.location || details.restaurant) {
        html += `<p class="text-gray-600 text-sm flex items-center gap-2 mt-1">
          <svg class="w-3.5 h-3.5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
          ${details.location || details.restaurant}
        </p>`;
      }
      if (details.activity || details.vibe) {
        html += `<p class="text-gray-600 text-sm flex items-center gap-2 mt-1">
          <svg class="w-3.5 h-3.5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          ${details.activity || details.vibe}
        </p>`;
      }
      if (details.urgency) {
        const urgClass = details.urgency.includes('High') ? 'text-red-600' : details.urgency.includes('Medium') ? 'text-orange-600' : 'text-gray-500';
        html += `<p class="${urgClass} text-sm flex items-center gap-2 mt-1">
          <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          ${details.urgency}
        </p>`;
      }
      if (details.notes) {
        html += `<p class="text-gray-400 text-xs mt-2 italic border-t border-gray-200 pt-2">${details.notes}</p>`;
      }
      
      return html || '<p class="text-gray-400 text-sm">No details provided</p>';
    }


    function renderRequestModal() {
      if (!state.selectedRequestUser) {
        return `
          <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <h2 class="text-xl font-semibold text-black">Send Request</h2>
            <button id="close-request-modal" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:text-black hover:bg-gray-200 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="p-8 text-center text-gray-500 bg-white">No user selected</div>
        `;
      }

      // Step 1: Select request type
      if (!state.selectedRequestType) {
        return `
          <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <img src="${state.selectedRequestUser.avatar || `https://ui-avatars.com/api/?name=${state.selectedRequestUser.name}&background=333&color=fff`}" alt="${state.selectedRequestUser.name}" class="w-10 h-10 rounded-full">
              <div>
                <h2 class="text-lg font-semibold text-black">Send Request</h2>
                <p class="text-sm text-gray-600">to ${state.selectedRequestUser.name}</p>
              </div>
            </div>
            <button id="close-request-modal" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:text-black hover:bg-gray-200 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="p-4 overflow-y-auto flex-1 bg-white">
            <p class="text-gray-600 text-sm mb-4">Select a request type:</p>
            <div class="grid grid-cols-2 gap-3">
              ${Object.entries(REQUEST_TYPES).map(([key, config]) => `
                <button class="select-request-type flex flex-col items-center gap-2 p-4 rounded-xl bg-gray-100 hover:bg-gray-200 transition-colors border border-gray-200 hover:border-gray-400" data-type="${key}">
                  <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center text-black">
                    ${config.icon}
                  </div>
                  <span class="text-black text-sm font-medium text-center">${config.name.replace(' Request', '')}</span>
                </button>
              `).join('')}
            </div>
          </div>
        `;
      }

      // Step 2: Fill in request details
      const typeConfig = REQUEST_TYPES[state.selectedRequestType];
      return `
        <div class="p-4 border-b border-gray-200 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <button id="back-to-types" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:text-black hover:bg-gray-200 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            <div>
              <h2 class="text-lg font-semibold text-black">${typeConfig.name}</h2>
              <p class="text-sm text-gray-600">to ${state.selectedRequestUser.name}</p>
            </div>
          </div>
          <button id="close-request-modal" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:text-black hover:bg-gray-200 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <form id="request-form" class="p-4 overflow-y-auto flex-1 space-y-4 bg-white">
          ${typeConfig.fields.map(field => {
            if (field.type === 'textarea') {
              return `
                <div>
                  <label class="block text-gray-700 text-sm mb-2">${field.label}${field.required ? ' *' : ''}</label>
                  <textarea name="${field.name}" placeholder="${field.placeholder || ''}" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-4 py-3 text-black placeholder-gray-500 focus:outline-none focus:border-black focus:ring-1 focus:ring-black transition-colors resize-none h-24" ${field.required ? 'required' : ''}></textarea>
                </div>
              `;
            } else if (field.type === 'select') {
              return `
                <div>
                  <label class="block text-gray-700 text-sm mb-2">${field.label}${field.required ? ' *' : ''}</label>
                  <select name="${field.name}" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-4 py-3 text-black focus:outline-none focus:border-black focus:ring-1 focus:ring-black transition-colors" ${field.required ? 'required' : ''}>
                    <option value="">Select an option</option>
                    ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                  </select>
                </div>
              `;
            } else {
              return `
                <div>
                  <label class="block text-gray-700 text-sm mb-2">${field.label}${field.required ? ' *' : ''}</label>
                  <input type="${field.type}" name="${field.name}" placeholder="${field.placeholder || ''}" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-4 py-3 text-black placeholder-gray-500 focus:outline-none focus:border-black focus:ring-1 focus:ring-black transition-colors" ${field.required ? 'required' : ''}>
                </div>
              `;
            }
          }).join('')}
        </form>
        <div class="p-4 border-t border-gray-200 flex gap-3 bg-white">
          <button id="cancel-request" class="flex-1 py-3 rounded-lg bg-gray-200 text-black font-medium hover:bg-gray-300 transition-colors">Cancel</button>
          <button id="submit-request" class="flex-1 py-3 rounded-lg bg-black text-white font-medium hover:bg-gray-800 transition-colors">Send Request</button>
        </div>
      `;
    }

    function updateRequestModal() {
      const container = document.getElementById('request-modal-content');
      if (container) {
        container.innerHTML = renderRequestModal();
        attachRequestModalListeners();
      }
    }

    function attachRequestModalListeners() {
      // Close modal
      document.getElementById('close-request-modal')?.addEventListener('click', () => {
        state.showRequestModal = false;
        state.selectedRequestUser = null;
        state.selectedRequestType = null;
        document.getElementById('request-modal')?.classList.add('hidden');
      });

      // Select request type
      document.querySelectorAll('.select-request-type').forEach(btn => {
        btn.addEventListener('click', () => {
          state.selectedRequestType = btn.dataset.type;
          updateRequestModal();
        });
      });

      // Back to types
      document.getElementById('back-to-types')?.addEventListener('click', () => {
        state.selectedRequestType = null;
        updateRequestModal();
      });

      // Cancel request
      document.getElementById('cancel-request')?.addEventListener('click', () => {
        state.showRequestModal = false;
        state.selectedRequestUser = null;
        state.selectedRequestType = null;
        document.getElementById('request-modal')?.classList.add('hidden');
      });

      // Submit request
      document.getElementById('submit-request')?.addEventListener('click', async () => {
        const form = document.getElementById('request-form');
        if (!form) return;
        
        // Get form data
        const formData = new FormData(form);
        const details = {};
        for (const [key, value] of formData.entries()) {
          if (value) details[key] = value;
        }
        
        // Validate required fields
        const typeConfig = REQUEST_TYPES[state.selectedRequestType];
        const requiredFields = typeConfig.fields.filter(f => f.required);
        for (const field of requiredFields) {
          if (!details[field.name]) {
            alert(`Please fill in the ${field.label} field`);
            return;
          }
        }
        
        // Send request
        const btn = document.getElementById('submit-request');
        btn.disabled = true;
        btn.textContent = 'Sending...';
        
        try {
          await sendRequest(state.selectedRequestUser, state.selectedRequestType, details);
          
          // Close modal
          state.showRequestModal = false;
          state.selectedRequestUser = null;
          state.selectedRequestType = null;
          document.getElementById('request-modal')?.classList.add('hidden');
          
          // Show success feedback
          log('Request sent successfully!');
        } catch (err) {
          log('Error sending request: ' + err.message);
          alert('Failed to send request. Please try again.');
          btn.disabled = false;
          btn.textContent = 'Send Request';
        }
      });
    }

    function renderSlidesTab() {
      const myUid = state.user?.uid;
      const connectionIds = (state.connections || []).map(c => c.id);
      const subTab = state.updatesSubTab || 'feed';

      // â”€â”€ Status story bubbles (WhatsApp-style row at top) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const now = Date.now();
      const h24 = 86400000;
      const recentSlides = (state.slides || []).filter(s => {
        const t = s.createdAt?.toDate?.() || new Date(s.createdAt || 0);
        return (now - t.getTime()) < h24;
      });
      const byUser = {};
      recentSlides.forEach(s => { byUser[s.userId] = byUser[s.userId] || []; byUser[s.userId].push(s); });
      const mySlides = byUser[myUid] || [];
      const connSlides = Object.keys(byUser).filter(u => u !== myUid && connectionIds.includes(u));
      const ring = n => n <= 1 ? '' : `stroke-dasharray: ${(100/n)-2} 2;`;

      // â”€â”€ Posts feed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const allPosts = state.posts || [];
      const myPosts = allPosts.filter(p => p.userId === myUid);
      const feedPosts = allPosts.filter(p => {
        if (p.userId === myUid) return false;
        if ((state.blockedUsers || []).includes(p.userId)) return false;
        if (p.visibility !== 'public') return false;
        return true;
      });

      return `
        <!-- â”€â”€ Status bubbles row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="bg-black border-b border-gray-800 px-3 py-2.5">
          <div class="flex gap-4 overflow-x-auto" style="scrollbar-width:none;-webkit-overflow-scrolling:touch;">
            <!-- My status -->
            <div class="flex flex-col items-center gap-1 flex-shrink-0 cursor-pointer" id="my-slide-btn">
              <div class="relative w-14 h-14">
                ${mySlides.length > 0 ? `
                  <svg class="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 36 36">
                    <circle cx="18" cy="18" r="16" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" style="${ring(mySlides.length)}" class="opacity-90"/>
                  </svg>` : `<div class="absolute inset-0 rounded-full border-2 border-dashed border-gray-600"></div>`}
                <div class="absolute inset-1 rounded-full overflow-hidden bg-gray-800">
                  ${state.userData?.avatar ? `<img src="${state.userData.avatar}" class="w-full h-full object-cover"/>` : `<div class="w-full h-full flex items-center justify-center text-white font-bold text-lg">${state.userData?.name?.charAt(0)||'U'}</div>`}
                </div>
                <button id="add-slide-btn" class="absolute -bottom-0.5 -right-0.5 w-5 h-5 bg-white rounded-full flex items-center justify-center shadow-md border-2 border-black z-10">
                  <svg class="w-3 h-3 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                </button>
              </div>
              <span class="text-white text-[10px] font-medium w-14 text-center truncate">My Status</span>
            </div>
            <!-- Circle status bubbles -->
            ${connSlides.map(uid => {
              const slides = byUser[uid];
              const latest = slides[slides.length-1];
              return `<div class="flex flex-col items-center gap-1 flex-shrink-0 cursor-pointer view-slide-btn" data-user-id="${uid}">
                <div class="relative w-14 h-14">
                  <svg class="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 36 36">
                    <circle cx="18" cy="18" r="16" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" style="${ring(slides.length)}" class="opacity-90"/>
                  </svg>
                  <div class="absolute inset-1 rounded-full overflow-hidden bg-gray-800">
                    ${latest.userAvatar ? `<img src="${latest.userAvatar}" class="w-full h-full object-cover"/>` : `<div class="w-full h-full flex items-center justify-center text-white font-bold">${latest.userName?.charAt(0)||'?'}</div>`}
                  </div>
                </div>
                <span class="text-gray-300 text-[10px] w-14 text-center truncate">${latest.userName?.split(' ')[0]||'User'}</span>
              </div>`;
            }).join('')}
          </div>
        </div>

        <!-- â”€â”€ Sub-tabs: For You | My Posts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="flex bg-black border-b border-gray-800 sticky top-0 z-10">
          <button class="updates-subtab-btn flex-1 py-3 text-sm font-semibold border-b-2 transition-all ${subTab==='feed' ? 'text-white border-white' : 'text-gray-500 border-transparent'}" data-subtab="feed">
            Slide
          </button>
          <button class="updates-subtab-btn flex-1 py-3 text-sm font-semibold border-b-2 transition-all ${subTab==='my_posts' ? 'text-white border-white' : 'text-gray-500 border-transparent'}" data-subtab="my_posts">
            My Posts ${myPosts.length ? `<span class="ml-1 px-1.5 py-0.5 text-[10px] rounded-full bg-gray-700 text-gray-300">${myPosts.length}</span>` : ''}
          </button>
        </div>

        ${subTab === 'feed' ? `
          <!-- â”€â”€ Compose bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
          <div class="bg-black border-b border-gray-800 flex items-center gap-3 px-4 py-3">
            <div class="w-9 h-9 rounded-full overflow-hidden bg-gray-800 flex-shrink-0 border border-gray-700">
              ${state.userData?.avatar ? `<img src="${state.userData.avatar}" class="w-full h-full object-cover"/>` : `<div class="w-full h-full flex items-center justify-center text-white font-bold text-sm">${state.userData?.name?.charAt(0)||'U'}</div>`}
            </div>
            <button id="open-create-post" class="flex-1 text-left bg-gray-100 border border-gray-200 rounded-full px-4 py-2.5 text-gray-500 text-sm hover:border-gray-400 transition-colors">
              What's on your mind?
            </button>
            <button id="open-create-post-icon" class="w-9 h-9 bg-white rounded-full flex items-center justify-center flex-shrink-0 hover:bg-gray-200 active:scale-95 transition-all">
              <svg class="w-4 h-4 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
            </button>
          </div>
          <!-- Visibility-OFF warning banner -->
          ${!state.updatesVisibility ? `
            <div class="mx-3 mt-2 mb-0 bg-amber-950 border border-amber-800 rounded-xl p-3 flex items-start gap-2.5">
              <svg class="w-4 h-4 text-amber-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/></svg>
              <p class="text-amber-300 text-xs flex-1">Your Updates visibility is <strong>OFF</strong> â€” public posts won't appear in anyone's feed. <button class="underline font-bold" onclick="saveUpdatesVisibility(true)">Turn ON</button></p>
            </div>` : ''}
          <!-- Posts feed -->
          ${feedPosts.length === 0 ? `
            <div class="flex flex-col items-center justify-center py-16 px-6 text-center">
              <div class="w-20 h-20 rounded-full bg-gray-100 border border-gray-200 flex items-center justify-center mb-4">
                <svg class="w-9 h-9 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
              </div>
              <p class="text-white font-semibold text-lg mb-1">Nothing here yet</p>
              <p class="text-gray-500 text-sm">Public posts from all Linq users appear here. Be the first to share something.</p>
              <button id="open-create-post" class="mt-5 px-5 py-2.5 bg-white text-black text-sm font-bold rounded-full hover:bg-gray-200 active:scale-95 transition-all">Post Something</button>
            </div>` : `
            <div id="updates-feed-list">
              ${feedPosts.map(p => renderPostCard(p)).join('')}
            </div>`}
        ` : `
          <!-- â”€â”€ My Posts tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
          <div class="bg-black border-b border-gray-800 flex items-center gap-3 px-4 py-3">
            <button id="open-create-post" class="flex-1 text-left bg-gray-100 border border-gray-200 rounded-full px-4 py-2.5 text-gray-500 text-sm hover:border-gray-400 transition-colors">Share something new...</button>
          </div>
          ${myPosts.length === 0 ? `
            <div class="flex flex-col items-center justify-center py-16 px-6 text-center">
              <p class="text-gray-400 font-medium">No posts yet</p>
              <p class="text-gray-600 text-sm mt-1">Posts you create will appear here</p>
            </div>` : `
            <div>${myPosts.map(p => renderPostCard(p)).join('')}</div>`}
        `}
      `;
    }

    // â”€â”€ Post Card Renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderPostCard(post) {
      const myUid = state.user?.uid;
      const isOwn = post.userId === myUid;
      const isConnected = (state.connections || []).some(c => c.id === post.userId);
      const isLiked = (post.likedBy || []).includes(myUid);
      const t = post.createdAt?.toDate?.() || new Date(post.createdAt || 0);
      const timeAgo = getTimeAgo(t);
      const isInviteSent = (state.sentInvites || []).some(i => i.toId === post.userId && i.status === 'pending');

      const visIcon = post.visibility === 'public'
        ? `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"/></svg>`
        : `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>`;

      return `<div class="post-card border-b border-gray-900 px-4 py-4 bg-black" data-post-id="${post.id}">
        <!-- Author row -->
        <div class="flex items-start gap-3 mb-3">
          <div class="w-11 h-11 rounded-full overflow-hidden bg-gray-800 flex-shrink-0 border border-gray-800">
            ${post.userAvatar ? `<img src="${post.userAvatar}" class="w-full h-full object-cover"/>` : `<div class="w-full h-full flex items-center justify-center text-white font-bold">${post.userName?.charAt(0)||'?'}</div>`}
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-1.5 flex-wrap mb-0.5">
              <span class="text-white font-semibold text-sm">${post.userName||'Unknown'}</span>
              <span class="text-gray-600 flex items-center gap-0.5 text-[11px]">${visIcon} ${post.visibility==='public'?'Public':'Circle'}</span>
              <span class="text-gray-600 text-[11px]">Â· ${timeAgo}</span>
            </div>
            ${post.userLocation ? `<p class="text-gray-600 text-xs flex items-center gap-1"><svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>${post.userLocation}</p>` : ''}
            ${post.userBio ? `<p class="text-gray-500 text-xs line-clamp-1">${post.userBio}</p>` : ''}
          </div>
          <!-- â‹¯ menu -->
          <button class="post-menu-btn flex-shrink-0 p-1.5 text-gray-600 hover:text-gray-400 rounded-full hover:bg-gray-100 transition-colors" data-post-id="${post.id}" data-post-user-id="${post.userId}" data-post-user-name="${post.userName||''}">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>
          </button>
        </div>
        <!-- Content -->
        ${post.content ? `<p class="text-white text-[15px] leading-relaxed mb-3 whitespace-pre-wrap">${post.content}</p>` : ''}
        ${post.videoUrl ? `<div class="rounded-xl overflow-hidden mb-3 border border-gray-800"><video src="${post.videoUrl}" class="w-full max-h-72 bg-black" controls playsinline preload="metadata"></video></div>` : post.imageUrl ? `<div class="rounded-xl overflow-hidden mb-3 border border-gray-800"><img src="${post.imageUrl}" alt="" class="w-full object-cover max-h-72 bg-gray-100"/></div>` : ''}
        <!-- Actions -->
        <div class="flex items-center justify-between pt-1">
          <div class="flex items-center gap-4">
            <button class="post-like-btn flex items-center gap-1.5 text-sm transition-colors ${isLiked?'text-red-500':'text-white hover:text-red-400'}" data-post-id="${post.id}">
              <svg class="w-5 h-5 transition-all ${isLiked?'fill-red-500':'fill-none'}" stroke="${isLiked?'none':'currentColor'}" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
              <span class="post-like-count text-xs">${post.likesCount||0}</span>
            </button>
            <button class="post-comment-btn flex items-center gap-1.5 text-sm text-white hover:text-gray-400 transition-colors" data-post-id="${post.id}">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
              <span class="text-xs post-comment-count">${post.commentsCount||0}</span>
            </button>
          </div>
          ${isOwn ? `
            <button class="post-delete-btn flex items-center gap-1 text-xs text-gray-600 hover:text-red-500 transition-colors px-2 py-1 rounded-lg hover:bg-gray-100" data-post-id="${post.id}">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              Delete
            </button>` : isConnected ? `
            <button class="post-message-btn flex items-center gap-1.5 px-3 py-1.5 bg-black border border-black text-white text-xs font-semibold rounded-full hover:bg-gray-800 active:scale-95 transition-all" data-user-id="${post.userId}">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
              Message
            </button>` : `
            <button class="post-connect-btn flex items-center gap-1.5 px-3 py-1.5 border text-xs font-bold rounded-full active:scale-95 transition-all ${isInviteSent ? 'border-gray-700 text-gray-500 cursor-default' : 'bg-white text-black border-white hover:bg-gray-200'}" data-user-id="${post.userId}" data-user-name="${post.userName||''}" data-user-avatar="${post.userAvatar||''}" ${isInviteSent?'disabled':''}>
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isInviteSent ? 'M5 13l4 4L19 7' : 'M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z'}"/></svg>
              ${isInviteSent ? 'Sent' : 'Connect'}
            </button>`}
        </div>
      </div>`;
    }

    function getTimeAgo(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      
      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      return 'Yesterday';
    }

    function renderEmptyChatView() {
      return `
        <div class="flex-1 flex items-center justify-center p-6">
          <div class="text-center max-w-md">
            <div class="mb-4"></div>
            <h2 class="text-2xl font-bold text-white mb-2">Welcome to Linq</h2>
            <p class="text-gray-400 mb-6">Select a chat from your Circle to start messaging, or find new people to connect with.</p>
            
            <div class="bg-gray-100 rounded-xl p-6 text-left border border-gray-200">
              <h3 class="text-white font-semibold mb-4">How it works:</h3>
              <ul class="space-y-3 text-gray-400 text-sm">
                <li class="flex items-start gap-3">
                  <span class="bg-white text-black rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 font-bold text-xs">1</span>
                  <span>Click the <strong class="text-white">+ icon</strong> to search for people</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="bg-white text-black rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 font-bold text-xs">2</span>
                  <span>Send an <strong class="text-white">invite</strong> to connect</span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="bg-white text-black rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 font-bold text-xs">3</span>
                  <span>Once they accept, they appear in your <strong class="text-white">Circle</strong></span>
                </li>
                <li class="flex items-start gap-3">
                  <span class="bg-white text-black rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 font-bold text-xs">4</span>
                  <span>Now you can <strong class="text-white">message</strong> each other!</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    function renderChatView(chat, otherUser) {
      const isTyping = state.typingUsers && otherUser && state.typingUsers[otherUser.id];
      
      return `
        <!-- Chat Header - WhatsApp Style -->
        <div class="chat-header-mobile bg-white border-b border-gray-200 flex items-center px-3 gap-3">
          <button id="back-btn" class="p-2 -ml-2 text-gray-600 hover:text-black transition-colors md:hidden">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </button>
          
          <!-- Chat header: avatar taps to profile, text taps to profile too -->
          <div class="flex items-center gap-3 flex-1 min-w-0" id="chat-user-info">
            <div class="relative flex-shrink-0 cursor-pointer" id="chat-avatar-btn">
              <img src="${otherUser?.avatar || `https://ui-avatars.com/api/?name=${otherUser?.name || 'U'}&background=333&color=fff`}" alt="${otherUser?.name || 'User'}" class="w-10 h-10 rounded-full object-cover active:scale-90 transition-transform">
              ${otherUser?.isOnline ? '<div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-white"></div>' : ''}
            </div>

            <div class="flex-1 min-w-0">
              <h2 class="font-semibold text-black truncate text-[15px]">${otherUser?.name || 'Unknown User'}</h2>
              ${isTyping ? `
                <div class="flex items-center gap-1">
                  <span class="text-gray-600 text-xs font-medium">typing</span>
                  <span class="flex gap-0.5">
                    <span class="typing-dot w-1 h-1 bg-gray-600 rounded-full"></span>
                    <span class="typing-dot w-1 h-1 bg-gray-600 rounded-full"></span>
                    <span class="typing-dot w-1 h-1 bg-gray-600 rounded-full"></span>
                  </span>
                </div>
              ` : `
                <p class="text-xs text-gray-500 truncate">${formatLastSeen(otherUser?.lastSeen, otherUser?.isOnline)}</p>
              `}
            </div>
          </div>

          <div class="flex items-center gap-1">
            <div class="relative">
              <button id="request-from-chat-btn" class="flex items-center justify-center w-9 h-9 bg-gray-100 hover:bg-gray-200 active:bg-gray-300 active:scale-95 transition-all rounded-full text-gray-700 hover:text-black" title="Send Request">
                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/>
                </svg>
              </button>
              <span id="chat-request-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold rounded-full min-w-[18px] h-[18px] flex items-center justify-center hidden"></span>
            </div>
            <button id="video-call-btn" class="p-2.5 text-gray-600 hover:text-black hover:bg-gray-100 active:bg-gray-200 active:scale-95 transition-all rounded-full" title="Video call">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
            </button>
            <button id="voice-call-btn" class="p-2.5 text-gray-600 hover:text-black hover:bg-gray-100 active:bg-gray-200 active:scale-95 transition-all rounded-full" title="Voice call">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
              </svg>
            </button>
            <div class="relative">
              <button id="more-options-btn" class="p-2.5 text-gray-600 hover:text-black hover:bg-gray-100 active:bg-gray-200 active:scale-95 transition-all rounded-full" title="More options">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                </svg>
              </button>
              <!-- More Options Menu -->
              <div id="more-options-menu" class="hidden absolute top-12 right-0 bg-white rounded-xl shadow-xl border border-gray-200 py-2 z-50 min-w-[180px]">
                <button class="more-option w-full flex items-center gap-3 px-4 py-2.5 text-left text-gray-700 hover:bg-gray-100 transition-colors" data-action="view-contact">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                  <span class="text-sm">View Contact</span>
                </button>
                <button class="more-option w-full flex items-center gap-3 px-4 py-2.5 text-left text-gray-700 hover:bg-gray-100 transition-colors" data-action="search">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                  <span class="text-sm">Search</span>
                </button>
                <button class="more-option w-full flex items-center gap-3 px-4 py-2.5 text-left text-gray-700 hover:bg-gray-100 transition-colors" data-action="mute">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
                  </svg>
                  <span class="text-sm">Mute</span>
                </button>
                <button class="more-option w-full flex items-center gap-3 px-4 py-2.5 text-left text-gray-700 hover:bg-gray-100 transition-colors" data-action="wallpaper">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span class="text-sm">Wallpaper</span>
                </button>
                <div class="my-1 border-t border-gray-200"></div>
                <button class="more-option w-full flex items-center gap-3 px-4 py-2.5 text-left text-gray-700 hover:bg-gray-100 transition-colors" data-action="clear-chat">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                  <span class="text-sm">Clear Chat</span>
                </button>
                <button class="more-option w-full flex items-center gap-3 px-4 py-2.5 text-left text-red-600 hover:bg-red-50 transition-colors" data-action="block">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                  </svg>
                  <span class="text-sm">Block</span>
                </button>
                <button class="more-option w-full flex items-center gap-3 px-4 py-2.5 text-left text-red-600 hover:bg-red-50 transition-colors" data-action="report">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                  <span class="text-sm">Report</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Messages Container -->
        <div class="chat-messages-mobile relative">
          <!-- Chat wallpaper/pattern (optional subtle pattern) -->
          <div class="absolute inset-0 bg-black opacity-95"></div>
          
          <!-- Messages -->
          <div id="message-list" class="h-full overflow-y-auto px-3 py-2" style="-webkit-overflow-scrolling: touch;">
            ${renderMessageList()}
          </div>
          
          <!-- Scroll to bottom button -->
          <button id="scroll-to-bottom" class="hidden absolute bottom-4 right-4 w-10 h-10 bg-gray-800 rounded-full shadow-lg flex items-center justify-center text-white hover:bg-gray-700 transition-colors scroll-btn-bounce border border-gray-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
            </svg>
            <span id="scroll-unread-badge" class="hidden absolute -top-1 -right-1 bg-white text-black text-xs font-bold rounded-full min-w-[18px] h-[18px] flex items-center justify-center px-1"></span>
          </button>
        </div>

                <!-- Emoji Panel -->
        <div id="emoji-panel">
          <div id="emoji-cats" style="display:flex;gap:4px;padding:6px 8px;border-bottom:1px solid #f3f4f6;overflow-x:auto"></div>
          <div id="emoji-grid" style="display:grid;grid-template-columns:repeat(8,1fr);gap:2px;padding:6px 8px"></div>
        </div>
        <!-- Message Input - WhatsApp Style -->
        <div class="chat-input-mobile bg-white border-t border-gray-200 p-2">
          <div class="flex items-end gap-2">
            <!-- Attachment button with menu -->
            <div class="relative">
              <button type="button" id="attachment-btn" class="p-2.5 text-gray-600 hover:text-black hover:bg-gray-100 active:bg-gray-200 active:scale-95 transition-all rounded-full flex-shrink-0" title="Attach file">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                </svg>
              </button>
              <!-- Attachment Menu -->
              <div id="attachment-menu" class="hidden absolute bottom-14 left-0 bg-white rounded-2xl shadow-xl border border-gray-200 p-3 z-50 min-w-[200px]">
                <div class="grid grid-cols-3 gap-2">
                  <button class="attachment-option flex flex-col items-center gap-1.5 p-3 rounded-xl hover:bg-gray-100 transition-colors" data-type="camera">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-500 to-red-500 flex items-center justify-center">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                    </div>
                    <span class="text-xs text-gray-700 font-medium">Camera</span>
                  </button>
                  <button class="attachment-option flex flex-col items-center gap-1.5 p-3 rounded-xl hover:bg-gray-100 transition-colors" data-type="gallery">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 flex items-center justify-center">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                    </div>
                    <span class="text-xs text-gray-700 font-medium">Gallery</span>
                  </button>
                  <button class="attachment-option flex flex-col items-center gap-1.5 p-3 rounded-xl hover:bg-gray-100 transition-colors" data-type="document">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                    </div>
                    <span class="text-xs text-gray-700 font-medium">Document</span>
                  </button>
                  <button class="attachment-option flex flex-col items-center gap-1.5 p-3 rounded-xl hover:bg-gray-100 transition-colors" data-type="location">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                    </div>
                    <span class="text-xs text-gray-700 font-medium">Location</span>
                  </button>
                  <button class="attachment-option flex flex-col items-center gap-1.5 p-3 rounded-xl hover:bg-gray-100 transition-colors" data-type="contact">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-500 to-amber-500 flex items-center justify-center">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                      </svg>
                    </div>
                    <span class="text-xs text-gray-700 font-medium">Contact</span>
                  </button>
                  <button class="attachment-option flex flex-col items-center gap-1.5 p-3 rounded-xl hover:bg-gray-100 transition-colors" data-type="audio">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-rose-500 to-pink-500 flex items-center justify-center">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                      </svg>
                    </div>
                    <span class="text-xs text-gray-700 font-medium">Audio</span>
                  </button>
                </div>
              </div>
              <!-- Hidden file inputs -->
              <input type="file" id="attachment-gallery-input" accept="image/*,video/*" class="hidden" multiple>
              <input type="file" id="attachment-document-input" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt" class="hidden">
              <input type="file" id="attachment-audio-input" accept="audio/*" class="hidden">
            </div>
            
            <!-- Input container -->
            <form id="message-form" class="blue-glow-input flex-1 flex items-end gap-2 bg-gray-100 rounded-3xl px-4 py-1 border border-transparent">
              <button type="button" id="emoji-btn" class="p-1.5 text-gray-600 hover:text-black hover:scale-110 active:scale-95 transition-all flex-shrink-0" title="Emoji">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </button>
              
              <textarea id="message-input" placeholder="Message" rows="1" autocomplete="off" class="flex-1 bg-transparent text-black placeholder-gray-500 py-2 focus:outline-none resize-none max-h-32 text-[15px]" style="min-height: 24px;"></textarea>
            </form>
            
            <!-- Send / Voice button (only one shows at a time) -->
            <button type="button" id="send-btn" class="hidden p-3 bg-black text-white rounded-full hover:bg-gray-800 hover:scale-105 active:scale-95 transition-all flex-shrink-0 shadow-lg" title="Send message">
              <svg id="send-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
            </button>
            
            <!-- Voice Note button (shows when no text) -->
            <button type="button" id="voice-note-btn" class="p-3 bg-black text-white rounded-full hover:bg-gray-800 hover:scale-105 active:scale-95 transition-all flex-shrink-0 shadow-lg" title="Record voice note">
              <svg id="mic-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
              </svg>
            </button>
          </div>
        </div>
      `;
    }

    function renderMessageList() {
      if (state.messages.length === 0) {
        return `
          <div class="flex items-center justify-center h-full text-gray-500">
            <div class="text-center px-8">
              <!-- Encrypted message indicator like WhatsApp -->
              <div class="bg-gray-200/90 rounded-lg px-4 py-3 inline-block">
                <div class="flex items-center justify-center gap-2 text-xs text-gray-400">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                  <span>Messages are private between you and this person</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // Group messages by date with WhatsApp-style labels
      const groups = [];
      let currentDate = '';
      let prevSenderId = null;
      
      state.messages.forEach((msg, index) => {
        const ts = msg.timestamp;
        const dateObj = ts?.toDate ? ts.toDate() : new Date(ts || Date.now());
        const dateStr = formatDateDivider(dateObj);
        
        // Check if this is a continuous message from same sender
        const isContinuous = prevSenderId === msg.senderId && index > 0;
        prevSenderId = msg.senderId;
        
        if (dateStr !== currentDate) {
          currentDate = dateStr;
          groups.push({ date: dateStr, dateObj, messages: [{ ...msg, isFirstInGroup: true }] });
        } else {
          groups[groups.length - 1].messages.push({ ...msg, isFirstInGroup: !isContinuous });
        }
      });

      return groups.map(group => `
        <div class="mb-2">
          <!-- Date divider - WhatsApp style -->
          <div class="flex items-center justify-center my-3">
            <span class="bg-gray-800/90 text-gray-300 text-[11px] px-3 py-1 rounded-md font-medium shadow-sm">${group.date}</span>
          </div>
          
          <!-- Messages -->
          <div class="space-y-0.5">
            ${group.messages.map((msg, msgIndex) => {
              const isMe = msg.senderId === state.user?.uid;
              const isFirstInGroup = msg.isFirstInGroup;
              const isLastInGroup = msgIndex === group.messages.length - 1 || group.messages[msgIndex + 1]?.senderId !== msg.senderId;
              
              // Message status icons
              const statusIcon = isMe ? getMessageStatusIcon(msg.status) : '';
              
              // Check if message has an image or voice note
              const hasImage = msg.imageUrl || msg.type === 'image';
              const hasVoice = msg.audioUrl || msg.type === 'voice';
              
              // Check if message is a document
              const hasDocument = msg.documentUrl || msg.type === 'document';
              
              if (hasDocument) {
                // Document message - WhatsApp style
                const fileName = msg.documentName || msg.text || 'Document';
                const fileSize = msg.documentSize || 0;
                const fileExt = msg.documentExt || fileName.split('.').pop().toLowerCase() || 'file';
                const documentUrl = msg.documentUrl || '';
                
                // Format file size
                const formatSize = (bytes) => {
                  if (!bytes) return '';
                  if (bytes < 1024) return bytes + ' B';
                  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                };
                
                // Get icon based on file extension
                const getDocIcon = (ext) => {
                  const icons = {
                    pdf: { color: 'text-red-400', bg: 'bg-red-500/20' },
                    doc: { color: 'text-blue-400', bg: 'bg-blue-500/20' },
                    docx: { color: 'text-blue-400', bg: 'bg-blue-500/20' },
                    xls: { color: 'text-green-400', bg: 'bg-green-500/20' },
                    xlsx: { color: 'text-green-400', bg: 'bg-green-500/20' },
                    ppt: { color: 'text-orange-400', bg: 'bg-orange-500/20' },
                    pptx: { color: 'text-orange-400', bg: 'bg-orange-500/20' },
                    txt: { color: 'text-gray-400', bg: 'bg-gray-500/20' },
                    zip: { color: 'text-yellow-400', bg: 'bg-yellow-500/20' },
                    rar: { color: 'text-purple-400', bg: 'bg-purple-500/20' }
                  };
                  return icons[ext] || { color: 'text-gray-400', bg: 'bg-gray-500/20' };
                };
                
                const docStyle = getDocIcon(fileExt);
                
                return `
                  <div class="flex ${isMe ? 'justify-end' : 'justify-start'} ${isFirstInGroup ? 'mt-2' : ''} px-2" data-msg-id="${msg.id}">
                    <div class="${isMe ? 'bg-white' : 'bg-gray-800'} rounded-2xl ${isLastInGroup ? (isMe ? 'rounded-br-md' : 'rounded-bl-md') : ''} overflow-hidden shadow-sm" style="min-width: 250px; max-width: 300px;">
                      <div class="p-3">
                        <div class="flex items-center gap-3">
                          <!-- File icon -->
                          <div class="w-12 h-12 ${docStyle.bg} rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-7 h-7 ${docStyle.color}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                          </div>
                          
                          <!-- File info -->
                          <div class="flex-1 min-w-0">
                            <p class="${isMe ? 'text-black' : 'text-white'} font-medium text-sm truncate">${fileName}</p>
                            <p class="${isMe ? 'text-gray-500' : 'text-gray-400'} text-xs flex items-center gap-2">
                              <span class="uppercase">${fileExt}</span>
                              ${fileSize ? `<span>â€¢ ${formatSize(fileSize)}</span>` : ''}
                            </p>
                          </div>
                          
                          <!-- Download button -->
                          ${documentUrl ? `
                            <button onclick="downloadDocument('${documentUrl}', '${fileName}')" 
                                    class="w-10 h-10 rounded-full ${isMe ? 'bg-black text-white hover:bg-gray-800' : 'bg-white text-black hover:bg-gray-200'} flex items-center justify-center transition-colors flex-shrink-0"
                                    title="Download">
                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                              </svg>
                            </button>
                          ` : ''}
                        </div>
                        
                        <!-- Time and status -->
                        <div class="flex items-center justify-end gap-1 mt-2">
                          <span class="text-[10px] ${isMe ? 'text-gray-500' : 'text-gray-400'}">${formatMessageTime(msg.timestamp)}</span>
                          ${isMe ? statusIcon : ''}
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              }
              
              if (hasVoice) {
                // Voice note message - WhatsApp style
                const duration = msg.audioDuration || 0;
                const durationStr = formatVoiceDuration(duration);
                
                return `
                  <div class="flex ${isMe ? 'justify-end' : 'justify-start'} ${isFirstInGroup ? 'mt-2' : ''} px-2">
                    <div class="relative ${isMe ? 'bg-white' : 'bg-gray-800'} rounded-2xl ${isLastInGroup ? (isMe ? 'rounded-br-md' : 'rounded-bl-md') : ''} shadow-sm overflow-hidden" style="min-width: 250px; max-width: 300px;">
                      <div class="flex items-center gap-3 p-2">
                        <!-- Play button -->
                        <button id="voice-play-${msg.id}" 
                                onclick="playVoiceNote('${msg.audioUrl}', '${msg.id}')"
                                class="w-12 h-12 rounded-full ${isMe ? 'bg-black text-white' : 'bg-white text-black'} flex items-center justify-center flex-shrink-0 hover:opacity-80 transition-opacity">
                          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                          </svg>
                        </button>
                        
                        <!-- Waveform and progress -->
                        <div class="flex-1">
                          <div class="relative h-8 flex items-center">
                            <!-- Waveform bars -->
                            <div class="flex items-center gap-0.5 w-full">
                              ${Array(25).fill(0).map(() => 
                                `<div class="w-1 ${isMe ? 'bg-gray-300' : 'bg-gray-600'} rounded-full" style="height: ${Math.random() * 20 + 4}px;"></div>`
                              ).join('')}
                            </div>
                            <!-- Progress overlay -->
                            <div class="absolute inset-0 overflow-hidden">
                              <div id="voice-progress-${msg.id}" class="h-full flex items-center gap-0.5" style="width: 0%;">
                                ${Array(25).fill(0).map(() => 
                                  `<div class="w-1 ${isMe ? 'bg-gray-700' : 'bg-white'} rounded-full" style="height: ${Math.random() * 20 + 4}px;"></div>`
                                ).join('')}
                              </div>
                            </div>
                          </div>
                          <!-- Duration -->
                          <div class="flex items-center justify-between mt-1">
                            <span id="voice-time-${msg.id}" class="text-xs ${isMe ? 'text-gray-500' : 'text-gray-400'}">${durationStr}</span>
                            <div class="flex items-center gap-1">
                              <span class="text-[10px] ${isMe ? 'text-gray-500' : 'text-gray-400'}">${formatMessageTime(msg.timestamp)}</span>
                              ${isMe ? statusIcon : ''}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              }
              
              if (hasImage) {
                // Clean WhatsApp-style image message
                const imageCaption = msg.text || '';
                const escapedCaption = imageCaption.replace(/'/g, "\\'").replace(/"/g, '\\"');
                
                // Check if imageUrl is valid Base64 or URL
                const imageUrl = msg.imageUrl || '';
                const isValidImage = imageUrl.startsWith('data:image') || imageUrl.startsWith('http');
                
                if (!isValidImage) {
                  // Show placeholder for invalid/truncated images
                  return `
                    <div class="flex ${isMe ? 'justify-end' : 'justify-start'} ${isFirstInGroup ? 'mt-2' : ''} px-2">
                      <div class="${isMe ? 'bg-white' : 'bg-gray-800'} rounded-2xl ${isLastInGroup ? (isMe ? 'rounded-br-md' : 'rounded-bl-md') : ''} overflow-hidden shadow-sm" style="max-width: 280px; min-width: 200px;">
                        <div class="p-4 text-center">
                          <svg class="w-12 h-12 mx-auto mb-2 ${isMe ? 'text-gray-400' : 'text-gray-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                          </svg>
                          <p class="${isMe ? 'text-gray-500' : 'text-gray-400'} text-sm">ðŸ“· Photo</p>
                          ${imageCaption ? `<p class="${isMe ? 'text-gray-600' : 'text-gray-500'} text-xs mt-1">${imageCaption}</p>` : ''}
                          <div class="flex items-center justify-end gap-1 mt-2">
                            <span class="text-[10px] ${isMe ? 'text-gray-500' : 'text-gray-400'}">${formatMessageTime(msg.timestamp)}</span>
                            ${isMe ? statusIcon : ''}
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                }
                
                return `
                  <div class="flex ${isMe ? 'justify-end' : 'justify-start'} ${isFirstInGroup ? 'mt-2' : ''} px-2">
                    <div class="relative cursor-pointer overflow-hidden" 
                         style="max-width: 280px; min-width: 200px;"
                         onclick="openFullscreenImage('${imageUrl}', '${escapedCaption}', '${formatMessageTime(msg.timestamp)}')">
                      
                      <!-- Clean bubble container -->
                      <div class="${isMe ? 'bg-white' : 'bg-gray-800'} rounded-2xl ${isLastInGroup ? (isMe ? 'rounded-br-md' : 'rounded-bl-md') : ''} overflow-hidden shadow-sm">
                        
                        <!-- Image with padding -->
                        <div class="p-1">
                          <div class="relative rounded-xl overflow-hidden">
                            <img src="${imageUrl}" 
                                 alt="Photo" 
                                 class="w-full block object-cover"
                                 style="max-height: 300px; min-height: 150px;"
                                 loading="lazy"
                                 onerror="this.parentElement.innerHTML='<div class=\\'p-8 text-center text-gray-500\\'>ðŸ“· Image failed to load</div>'">
                            
                            <!-- Time badge overlay on image (no caption) -->
                            ${!imageCaption ? `
                              <div class="absolute bottom-1.5 right-1.5 bg-black/50 backdrop-blur-sm rounded-full px-2 py-0.5 flex items-center gap-1">
                                <span class="text-[10px] text-white">${formatMessageTime(msg.timestamp)}</span>
                                ${isMe ? `<span class="text-white">${statusIcon.replace(/text-gray-\d+/g, 'text-white').replace(/w-4 h-4/g, 'w-3 h-3')}</span>` : ''}
                              </div>
                            ` : ''}
                          </div>
                        </div>
                        
                        <!-- Caption (if present) -->
                        ${imageCaption ? `
                          <div class="px-3 pb-2 pt-1">
                            <p class="${isMe ? 'text-black' : 'text-white'} text-[14px] leading-snug">${formatMessageText(imageCaption)}</p>
                            <div class="flex items-center justify-end gap-1 mt-1">
                              <span class="text-[10px] ${isMe ? 'text-gray-500' : 'text-gray-400'}">${formatMessageTime(msg.timestamp)}</span>
                              ${isMe ? statusIcon : ''}
                            </div>
                          </div>
                        ` : ''}
                      </div>
                    </div>
                  </div>
                `;
              }
              
              return `
                <div class="flex ${isMe ? 'justify-end' : 'justify-start'} ${isFirstInGroup ? 'mt-2' : ''}">
                  <div class="relative max-w-[80%] md:max-w-[65%] ${isMe 
                    ? `bg-white text-black ${isLastInGroup ? 'rounded-2xl rounded-br-md msg-tail-right' : 'rounded-2xl'}` 
                    : `bg-gray-800 text-white ${isLastInGroup ? 'rounded-2xl rounded-bl-md msg-tail-left' : 'rounded-2xl'}`
                  } px-3 py-1.5 shadow-md">
                    <!-- Message text -->
                    <p class="break-words text-[14.5px] leading-relaxed whitespace-pre-wrap">${formatMessageText(msg.text)}</p>
                    
                    <!-- Time and status -->
                    <div class="flex items-center justify-end gap-1 -mb-0.5 ${isMe ? 'text-gray-500' : 'text-gray-400'}">
                      <span class="text-[10px] leading-none">${formatMessageTime(msg.timestamp)}</span>
                      ${statusIcon}
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `).join('');
    }
    
    // Format date divider like WhatsApp (Today, Yesterday, or full date)
    function formatDateDivider(date) {
      const now = new Date();
      const diffTime = now - date;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) {
        return 'TODAY';
      } else if (diffDays === 1) {
        return 'YESTERDAY';
      } else if (diffDays < 7) {
        return date.toLocaleDateString([], { weekday: 'long' }).toUpperCase();
      } else {
        return date.toLocaleDateString([], { day: 'numeric', month: 'long', year: 'numeric' }).toUpperCase();
      }
    }
    
    // Get message status icon (sending, sent, delivered, read, failed)
    function getMessageStatusIcon(status) {
      if (status === 'failed') {
        // Error icon for failed messages
        return `<svg class="w-3.5 h-3.5 text-red-500 ml-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>`;
      } else if (status === 'sending') {
        // Clock icon for sending
        return `<svg class="w-3.5 h-3.5 text-gray-400 ml-0.5 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>`;
      } else if (status === 'read') {
        // Double checkmark (filled/read)
        return `<svg class="w-4 h-4 text-gray-600 ml-0.5" viewBox="0 0 16 15" fill="currentColor">
          <path d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.879a.32.32 0 0 1-.484.033l-.358-.325a.319.319 0 0 0-.484.032l-.378.483a.418.418 0 0 0 .036.541l1.32 1.266c.143.14.361.125.484-.033l6.272-8.048a.366.366 0 0 0-.064-.512zm-4.1 0l-.478-.372a.365.365 0 0 0-.51.063L4.566 9.879a.32.32 0 0 1-.484.033L1.891 7.769a.366.366 0 0 0-.515.006l-.423.433a.364.364 0 0 0 .006.514l3.258 3.185c.143.14.361.125.484-.033l6.272-8.048a.365.365 0 0 0-.063-.51z"/>
        </svg>`;
      } else if (status === 'delivered') {
        // Double gray checkmark
        return `<svg class="w-4 h-4 text-gray-400 ml-0.5" viewBox="0 0 16 15" fill="currentColor">
          <path d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.879a.32.32 0 0 1-.484.033l-.358-.325a.319.319 0 0 0-.484.032l-.378.483a.418.418 0 0 0 .036.541l1.32 1.266c.143.14.361.125.484-.033l6.272-8.048a.366.366 0 0 0-.064-.512zm-4.1 0l-.478-.372a.365.365 0 0 0-.51.063L4.566 9.879a.32.32 0 0 1-.484.033L1.891 7.769a.366.366 0 0 0-.515.006l-.423.433a.364.364 0 0 0 .006.514l3.258 3.185c.143.14.361.125.484-.033l6.272-8.048a.365.365 0 0 0-.063-.51z"/>
        </svg>`;
      } else {
        // Single checkmark (sent)
        return `<svg class="w-4 h-4 text-gray-400 ml-0.5" viewBox="0 0 16 15" fill="currentColor">
          <path d="M10.91 3.316l-.478-.372a.365.365 0 0 0-.51.063L4.566 9.879a.32.32 0 0 1-.484.033L1.891 7.769a.366.366 0 0 0-.515.006l-.423.433a.364.364 0 0 0 .006.514l3.258 3.185c.143.14.361.125.484-.033l6.272-8.048a.365.365 0 0 0-.063-.51z"/>
        </svg>`;
      }
    }
    
    // Format message text with links and line breaks
    function formatMessageText(text) {
      if (!text) return '';
      // Escape HTML
      let formatted = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      // Convert URLs to links
      formatted = formatted.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-white underline hover:no-underline">$1</a>');
      return formatted;
    }
    
    // Open fullscreen image viewer (like WhatsApp)
    function openFullscreenImage(imageUrl, caption, time) {
      const viewerHtml = `
        <div id="fullscreen-image-viewer" class="fixed inset-0 z-[70] bg-black flex flex-col">
          <!-- Header -->
          <div class="flex items-center justify-between p-4 bg-gradient-to-b from-black/80 to-transparent absolute top-0 left-0 right-0 z-10">
            <button id="close-fullscreen-image" class="w-10 h-10 rounded-full flex items-center justify-center text-white hover:bg-white/20 transition-all">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            <div class="flex items-center gap-2">
              <button id="share-image" class="w-10 h-10 rounded-full flex items-center justify-center text-white hover:bg-white/20 transition-all" title="Share">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
              </button>
              <button id="download-image" class="w-10 h-10 rounded-full flex items-center justify-center text-white hover:bg-white/20 transition-all" title="Download">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
              </button>
            </div>
          </div>
          
          <!-- Image -->
          <div class="flex-1 flex items-center justify-center p-4">
            <img src="${imageUrl}" alt="Full screen" class="max-w-full max-h-full object-contain">
          </div>
          
          <!-- Caption and time -->
          <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent">
            ${caption ? `<p class="text-white text-center mb-1">${caption}</p>` : ''}
            <p class="text-gray-400 text-xs text-center">${time}</p>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', viewerHtml);
      
      // Close on click
      document.getElementById('close-fullscreen-image')?.addEventListener('click', () => {
        document.getElementById('fullscreen-image-viewer')?.remove();
      });
      
      // Download image
      document.getElementById('download-image')?.addEventListener('click', () => {
        const link = document.createElement('a');
        link.href = imageUrl;
        link.download = 'linq-image-' + Date.now() + '.jpg';
        link.click();
      });
      
      // Close on escape key
      const handleEscape = (e) => {
        if (e.key === 'Escape') {
          document.getElementById('fullscreen-image-viewer')?.remove();
          document.removeEventListener('keydown', handleEscape);
        }
      };
      document.addEventListener('keydown', handleEscape);
    }
    
    // Make openFullscreenImage available globally
    window.openFullscreenImage = openFullscreenImage;
    
    // Download document function
    function downloadDocument(base64Data, fileName) {
      try {
        // Create a link element and trigger download
        const link = document.createElement('a');
        link.href = base64Data;
        link.download = fileName || 'document';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        log('Document downloaded: ' + fileName);
      } catch (err) {
        log('Download error: ' + err.message);
        alert('Failed to download document. Please try again.');
      }
    }
    
    // Make downloadDocument available globally
    window.downloadDocument = downloadDocument;

    // Initialize
    renderFull();
    
    // Listen for incoming calls when logged in
    if (state.user) {
      listenForIncomingCalls();
    }
  </script>
</head>
<body class="bg-black">
  <div id="root"></div>
</body>
</html>
